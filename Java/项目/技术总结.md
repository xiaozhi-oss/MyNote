# 文件存储

一般我们不会使用传统服务器存储，一般是使用第三方的系统来进行存储



## 1、FastDFS 

### 1.1 概述

分布式文件存储系统，需要自己搭建服务



#### ①FastDFS架构

![image-20221018215158055](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20221018215158055.png)

Tracker：负责来和用户打交道的，它相当于是一个中间人，由它来告诉用户那个Storage是可用的

Storage：它是负责存储的，采用分布式的存储方式，组之间节点的数据相互同步的，比如Node4的数据会同步给Node5





#### ②FastDFS上传过程

<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20221018215402539.png" alt="image-20221018215402539"  />



#### ③FastDFS下载过程

![image-20221018215915998](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20221018215915998.png)





#### ④优点和缺点

优点：

-   它是相对第三方服务更加的安全，可以保护用户隐私
-   采用分布式的架构，保证了文件的可用性
-   可以水平扩展

缺点：

-   需要自己手动搭建服务，运维成本高
-   开发复杂，当需要对文件进行一些复杂操作的时候就需要团队来进行后续的开发处理，技术复杂度高，比如上传视屏，用户会对视屏做一些处理，比如颜色、滤镜之类的





### 1.2 安装

地址：https://cloud.tencent.com/developer/article/1691891

或者百度



### 1.3 java客户端操作

spring环境下

1.  maven依赖

    ```xml
    <dependency>
        <groupId>com.github.tobato</groupId>
        <artifactId>fastdfs-client</artifactId>
        <version>1.27.2</version>
    </dependency>
    ```

2.  配置

    ```yaml
    #======================================
    # fastdfs配置
    #======================================
    fdfs:
      so-timeout: 30                      # 连接超时时间
      connect-timeout: 30                 # 读取时间
      tracker-list: 192.168.6.156:22122   # tracker服务配置地址列表
    ```

3.  使用

    它已经是注册到spring容器中了，可以直接使用注入的方式获取`FastFileStorageClient`对象，通过这个对象就可以进行上传服务了

    ```java
    @Autowired
    private FastFileStorageClient fastFileStorageClient;
    ```







## 2、第三方云存储

优点：

-   SDK使用简单
-   提供强大的文件处理功能
-   零运维成本，只需要购买服务
-   图形化管理控制台
-   CDN加速

云存储平台：阿里云、腾讯云、七牛云......



### 2.1 阿里云OSS

阿里云平台的云存储

阿里云存储的文件地址：

```java
https://imooc-news-xiaozhi.oss-cn-guangzhou.aliyuncs.com/imooc/test/221019GANP917WBC.jpg
// imooc-news-xiaozhi：Bucket名
```

名词解释：

-   Bucket：阿里云中可以创建多个Bucket，可以对应多个项目
-   Endpoint：地域节点，选择离服务器近的



#### ①购买服务

学习的话购买资源包就好了，选择标准40G的

![image-20221019214254360](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20221019214254360.png)



#### ②创建Bucket

-   进入对象存储OSS模块，点击创建Bucket

    ![image-20221019214430900](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20221019214430900.png)

    <img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20221019214748290.png" alt="image-20221019214748290" style="zoom:80%;" />

-   进入创建的Bucket，然后上传图片测试

    ![image-20221019215007400](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20221019215007400.png)

    注：这里可以根据不同的功能可以创建不同的目录，更好的进行分类

    ![image-20221019215146918](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20221019215146918.png)

    测试：复制URL打开看是否可以访问即可



#### ③使用Java SDK

官网有例子，这里结合springBoot进行解耦



1、在Resource目录下创建两个文件

-   aliyunProperties：存放Aliyun的accessKey的信息

    ```properties
    aliyun.akId=
    aliyun.akSecret=
    ```

    注：这里建议使用RAM进行权限管理

-   oss-file.properties：存放OSS需要的信息

    ```properties
    # 阿里云OSS相关配置
    file.endpoint=oss-cn-guangzhou.aliyuncs.com
    file.bucketName=imooc-news-xiaozhi
    # object是创建目录的路径
    file.objectName=imooc/test
    # 这个返回前端需要
    file.ossHost=https://imooc-news-xiaozhi.oss-cn-guangzhou.aliyuncs.com
    ```

2、创建对应的配置类

```java
@Component
@PropertySource("classpath:aliyun.properties")
@ConfigurationProperties(prefix = "aliyun")
public class AliyunResource {

    private String akId;
    private String akSecret;
    // 省略get和set方法
}
```

```java
@Component
@ConfigurationProperties(prefix = "file")
@PropertySource("classpath:oss-file.properties")
public class FileResource {

    private String endpoint;
    private String bucketName;
    private String objectName;
    private String ossHost;
}
```

3、创建uploadService

```java
@Override
public String uploadToOss(MultipartFile file, String userId,String extName) throws IOException {
    // Endpoint以华东1（杭州）为例，其它Region请按实际情况填写。
    String endpoint = fileResource.getEndpoint();
    // 阿里云账号AccessKey拥有所有API的访问权限，风险很高。强烈建议您创建并使用RAM用户进行API访问或日常运维，请登录RAM控制台创建RAM用户。
    String accessKeyId = aliyunResource.getAkId();
    String accessKeySecret = aliyunResource.getAkSecret();
    // 填写Bucket名称，例如examplebucket。
    String bucketName = fileResource.getBucketName();
    // 填写Object完整路径，例如exampledir/exampleobject.txt。Object完整路径中不能包含Bucket名称。
    String objectName = fileResource.getObjectName();
    String ossHost = fileResource.getOssHost();

    // 创建OSSClient实例。
    OSS ossClient = new OSSClientBuilder().build(endpoint, accessKeyId, accessKeySecret);

    // 获取文件完整路径
    String filename = sid.nextShort();
    String myObjectName = objectName + "/" + filename + "." + extName;

    // 上传文件流
    PutObjectResult result = ossClient.putObject(bucketName, myObjectName, file.getInputStream());
    // 关闭资源
    ossClient.shutdown();
    return ossHost + "/" + myObjectName;
}
```





## 3、GridFS

问题：图片存储到第三方会出现一个隐私泄露的问题，所以需要将文件存储到我们自己的文件服务器中，但是如果文件不是很大的话我们就不要要使用分布式文件存储系统（FastDFS），我们可以采用GridFS来进行存储





## 4、MinIO

开源的分布式系统





# 内容安全

这里使用阿里云的内容安全服务

内容安全有图片审核、文本审核、视频审核等。。。

![image-20221019224521968](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20221019224521968.png)







# 三方登录

## 微信登录















# 支付







