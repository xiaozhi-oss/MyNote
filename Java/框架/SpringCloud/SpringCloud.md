# ä¸€ã€SpringCloudæ¦‚è¿°

## 1.1 å¾®æœåŠ¡æ˜¯ä»€ä¹ˆ

ç”±äºå•ä½“åº”ç”¨çš„å±€é™æ€§å’Œæ€§èƒ½ç“¶é¢ˆï¼Œä½¿å¾—å¾®æœåŠ¡æŠ€æœ¯çš„å‡ºç°ã€‚å¾®æœåŠ¡å°±æ˜¯å°†å•ä½“åº”ç”¨çš„å„ä¸ªåŠŸèƒ½æ‹†åˆ†æˆå„ç§æœåŠ¡ï¼Œæ¯ä¸€ä¸ªæœåŠ¡æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ã€‚æœåŠ¡ä¸æœåŠ¡ä¹‹é—´äº’ä¸å¹²æ‰°ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å¼€å‘çš„æ—¶å€™å¯ä»¥å»å¹¶è¡Œå¼€å‘ï¼Œæ¯ä¸ªäººå¯ä»¥è´Ÿè´£å¼€å‘ä¸åŒçš„æ¨¡å—ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„æœåŠ¡ã€‚ç”±äºæ˜¯å•ä¸ªæœåŠ¡ï¼Œæ‰€ä»¥åœ¨è¯·æ±‚æµé‡å¤šçš„æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥æ‰©å®¹å½“å‰æœåŠ¡ï¼Œä»è€Œå‡å°‘èµ„æºçš„æµªè´¹ï¼Œå°±å¥½æ¯”å¦‚æˆ‘ä»¬çš„ä¸Šä¼ å’Œä¸‹è½½æœåŠ¡æ˜¯ä¸ç»å¸¸ä½¿ç”¨ï¼Œè€Œä¸‹è®¢å•çš„æœåŠ¡æ˜¯æµé‡å·¨å¤§çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å¯¹ä¸‹å•çš„è¿™ä¸ªæœåŠ¡è¿›è¡Œæ‰©å®¹ã€‚ç›¸æ¯”äºå•ä½“åº”ç”¨ï¼Œå¾®æœåŠ¡çš„å¯æ‰©å±•æ€§æé«˜äº†ã€‚æœåŠ¡æ‹†åˆ†å¿…ç„¶ä¼šå‡ºç°å¾ˆå¤šçš„é—®é¢˜ï¼ŒæœåŠ¡ä¸æœåŠ¡ä¹‹é—´çš„è°ƒç”¨é—®é¢˜ï¼ŒæœåŠ¡çš„ç›‘æ§é—®é¢˜ï¼ŒæœåŠ¡çš„é“¾è·¯è¿½è¸ªé—®é¢˜ã€‚

SpringCoundæä¾›äº†åˆ†å¸ƒå¼å¾®æœåŠ¡æ¶æ„çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆï¼Œä¿—ç§°å¾®æœåŠ¡å…¨å®¶æ¡¶ï¼Œå®ƒæ˜¯å¾®æœåŠ¡å¼€å‘çš„ä¸»æµæŠ€æœ¯æ ˆï¼Œåœ¨å›½å†…å¼€å‘è€…ç¤¾åŒºéå¸¸ç«çˆ†ã€‚spring Cloud Alibabaè¾ƒä¸ºçªå‡ºã€‚å®ƒé€šè¿‡ä¸€ç³»åˆ—çš„æŠ€æœ¯æ¥è§£å†³åˆ†å¸ƒå¼å¾®æœåŠ¡æ‰€å¸¦æ¥çš„é—®é¢˜ã€‚

ä¾‹å­ï¼šäº¬ä¸œ2018å¹´çš„æ¶æ„

![image-20230205120403321](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230205120403321.png)

<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230205114858713.png" alt="image-20230205114858713" style="zoom:67%;" />

ä¸šåŠ¡å’Œéä¸šåŠ¡çš„æ¨¡å—è¿›è¡Œæ‹†åˆ†



## 1.2 SpringCloudä¸»æµæŠ€æœ¯æ ˆ

![image-20230205115124762](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230205115124762.png)

ä¸Šå›¾æ‰€ç¤ºæŠ€æœ¯åœ¨2020å¹´å‡ ä¹éƒ½å·²ç»è¢«æ–°æŠ€æœ¯æ›¿ä»£ï¼Œä½†æ˜¯ä»–ä»¬çš„ä½¿ç”¨æ–¹å¼å’ŒåŸç†å¤§ä½“ç±»ä¼¼ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä¼šå­¦ä¹ è¿™äº›æŠ€æœ¯ï¼Œå› ä¸ºä¸€äº›è€é¡¹ç›®ä¼šç”¨åˆ°è¿™äº›æŠ€æœ¯

![image-20230205161827474](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230205161827474.png)





## 1.3 Bootå’ŒCouldæŠ€æœ¯é€‰å‹

åœ¨å®˜ç½‘ä¸­å¯ä»¥çœ‹åˆ°springCloudå¯¹åº”å»ºè®®çš„Bootç‰ˆæœ¬





# äºŒã€å¾®æœåŠ¡å·¥ç¨‹æ­å»º

**äº”å¤§æ­¥éª¤**

1.  å»ºæ¨¡å—
2.  æ”¹pom
3.  æ”¹yalml
4.  ä¸»å¯åŠ¨
5.  ä¸šåŠ¡ç±»

==æœ€é‡è¦çš„ä¸€æ­¥ï¼šå…ˆæ­å»ºå¥½ç¯å¢ƒï¼Œé˜²æ­¢ç¯å¢ƒå‡ºç°é—®é¢˜ï¼ï¼ï¼==

éœ€è¦æ„å»ºä¸¤ä¸ªæœåŠ¡ï¼Œè®¢å•æœåŠ¡å’Œæ”¯ä»˜æœåŠ¡ï¼Œè®¢å•æœåŠ¡å»è°ƒç”¨æ”¯ä»˜æœåŠ¡çš„æ¥å£





## çˆ¶å·¥ç¨‹æ­å»º

åˆ›å»ºä¸€ä¸ªç©ºçš„Mavené¡¹ç›®

ä¿®æ”¹POM

```xml
<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.atguigu.com</groupId>
    <artifactId>cloud2020</artifactId>
    <version>1.0-SNAPSHOT</version>
    <packaging>pom</packaging>
    <modules>
        <module>cloud-provider-payment8001</module>
    </modules>

    <!-- ç»Ÿä¸€ç®¡ç†jaråŒ…ç‰ˆæœ¬ -->
    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <maven.compiler.source>1.8</maven.compiler.source>
        <maven.compiler.target>1.8</maven.compiler.target>
        <junit.version>4.12</junit.version>
        <log4j.version>1.2.17</log4j.version>
        <lombok.version>1.16.18</lombok.version>
        <mysql.version>5.1.47</mysql.version>
        <druid.version>1.2.3</druid.version>
        <mybatis.spring.boot.version>1.3.0</mybatis.spring.boot.version>
    </properties>


    <!-- å­æ¨¡å—ç»§æ‰¿ä¹‹åï¼Œæä¾›ä½œç”¨ï¼šé”å®šç‰ˆæœ¬+å­modlueä¸ç”¨å†™groupIdå’Œversion  -->
    <dependencyManagement>
        <dependencies>
            <!--spring boot 2.2.2-->
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-dependencies</artifactId>
                <version>2.2.2.RELEASE</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <!--spring cloud Hoxton.SR1-->
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>Hoxton.SR1</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <!--spring cloud alibaba 2.1.0.RELEASE-->
            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>spring-cloud-alibaba-dependencies</artifactId>
                <version>2.1.0.RELEASE</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>mysql</groupId>
                <artifactId>mysql-connector-java</artifactId>
                <version>${mysql.version}</version>
            </dependency>
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>druid</artifactId>
                <version>${druid.version}</version>
            </dependency>
            <dependency>
                <groupId>org.mybatis.spring.boot</groupId>
                <artifactId>mybatis-spring-boot-starter</artifactId>
                <version>${mybatis.spring.boot.version}</version>
            </dependency>
            <dependency>
                <groupId>junit</groupId>
                <artifactId>junit</artifactId>
                <version>${junit.version}</version>
            </dependency>
            <dependency>
                <groupId>log4j</groupId>
                <artifactId>log4j</artifactId>
                <version>${log4j.version}</version>
            </dependency>
            <dependency>
                <groupId>org.projectlombok</groupId>
                <artifactId>lombok</artifactId>
                <version>${lombok.version}</version>
                <optional>true</optional>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <fork>true</fork>
                    <addResources>true</addResources>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>
```



## æ”¯ä»˜æ¨¡å—æ­å»º

### â‘ åˆ›å»ºæ¨¡å—

cloud-provider-payment



### â‘¡ä¿®æ”¹Pom

```xml
<parent>
    <artifactId>cloud2020</artifactId>
    <groupId>com.atguigu.com</groupId>
    <version>1.0-SNAPSHOT</version>
</parent>
<modelVersion>4.0.0</modelVersion>

<artifactId>cloud-provider-payment8001</artifactId>

<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    <dependency>
        <groupId>org.mybatis.spring.boot</groupId>
        <artifactId>mybatis-spring-boot-starter</artifactId>
    </dependency>
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>druid-spring-boot-starter</artifactId>
        <version>1.1.10</version>
    </dependency>
    <!--mysql-connector-java-->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
    </dependency>
    <!--jdbc-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-jdbc</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-devtools</artifactId>
        <scope>runtime</scope>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```



### â‘¢æ”¹yalml

```yaml
server:
  port: 8001

spring:
  application:
    name: cloud-payment-service
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource            # å½“å‰æ•°æ®æºæ“ä½œç±»å‹
    driver-class-name: org.gjt.mm.mysql.Driver              # mysqlé©±åŠ¨åŒ… com.mysql.jdbc.Driver
    url: jdbc:mysql://study-mysql.com:3306/spring-cloud-study?useUnicode=true&characterEncoding=utf-8&useSSL=false
    username: root
    password: abc123


mybatis:
  mapperLocations: classpath:mapper/*.xml
  type-aliases-package: com.atguigu.springcloud.entities    # æ‰€æœ‰Entityåˆ«åç±»æ‰€åœ¨åŒ…
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
```



### â‘£ä¸»å¯åŠ¨

```java
@SpringBootApplication
public class PaymentMain8001 {

    public static void main(String[] args) {
        SpringApplication.run(PaymentMain8001.class, args);
    }
}
```



### â‘¤ä¸šåŠ¡ç±»

-   entity

    ```java
    @Data
    public class Payment implements Serializable {
    
        private Long id;
        private String serial;
    
        private static final long serialVersionUID = 1L;
    }
    ```

-   mapper

    ```java
    @Mapper
    public interface PaymentMapper {
    
        int create(Payment payment);
    
        Payment getPaymentById(long id);
    }
    ```

    ```xml
    <?xml version="1.0" encoding="UTF-8" ?>
    <!DOCTYPE mapper
            PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
    <mapper namespace="com.atguigu.springcloud.mapper.PaymentMapper">
    
        <resultMap id="BaseResultMap" type="payment">
            <id column="id" property="id" jdbcType="BIGINT"/>
            <result column="serial" property="serial" jdbcType="VARCHAR"/>
        </resultMap>
    
        <insert id="create" parameterType="Payment" useGeneratedKeys="true" keyProperty="id">
            insert into payment(SERIAL) VALUES (#{serial})
        </insert>
    
        <select id="getPaymentById" parameterType="Long" resultMap="BaseResultMap">
            SELECT * FROM payment where `id`= #{id};
        </select>
    
    </mapper>
    ```

-   service

    ```java
    @Service
    public class PayServiceImpl implements PayService {
    
        @Resource
        private PaymentMapper paymentMapper;
    
        @Override
        public int create(Payment payment) {
            return paymentMapper.create(payment);
        }
    
        @Override
        public Payment getPaymentById(Long id) {
            return paymentMapper.getPaymentById(id);
        }
    }
    ```

-   controller

    ```java
    @RestController
    @Slf4j
    @RequestMapping("payment")
    public class PaymentController {
    
        @Resource
        private PayService payService;
    
        @PostMapping("/add")
        public CommonResult addPayment(@RequestBody Payment payment) {
            int res = payService.create(payment);
            log.info("æ’å…¥ç»“æœä¸º --- {}", res);
            if (res > 0) {
                return new CommonResult(200, "æ·»åŠ æˆåŠŸ", res);
            } else {
                return new CommonResult(444, "æ·»åŠ å¤±è´¥");
            }
        }
    
        @GetMapping("/getPaymentById")
        public CommonResult getPaymentById(@RequestParam("id") Long id) {
            Payment payment = payService.getPaymentById(id);
            log.info("æŸ¥è¯¢ç»“æœä¸º --- {}", payment);
            if (payment != null) {
                return new CommonResult(200, "æŸ¥è¯¢æˆåŠŸ", payment);
            } else {
                return new CommonResult(444, "æŸ¥è¯¢å¤±è´¥");
            }
        }
    }
    ```






## è®¢å•æ¨¡å—æ­å»º

å’Œæ”¯ä»˜æ¨¡å—ä¸€æ ·çš„æ­¥éª¤ï¼ŒåŒæ—¶å‡è®¾è®¢å•æ¨¡å—è°ƒç”¨æ”¯ä»˜æ¨¡å—

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>cloud2020</artifactId>
        <groupId>com.atguigu.com</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>cloud-consumer-order8002</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

</project>
```

```yml
server:
  port: 8002
```

```
CommonResultå’ŒPaymentç±»
```



**RestTemplate**

springæä¾›çš„å‘èµ·httpè¯·æ±‚çš„è¯·æ±‚ç±»ï¼Œå’Œ`Httpclient`çš„åŠŸèƒ½ç±»ä¼¼ï¼Œå®ƒæ˜¯webæ¨¡å—ä¸‹çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦å¼•å…¥é¢å¤–ä¾èµ–ï¼Œåªéœ€è¦å°†å®ƒæ³¨å†Œåˆ°å®¹å™¨ä¸­å³å¯

```java
@Configuration
public class ApplicationContextConfig {

    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

æ¥ä¸‹æ¥å°±æ˜¯ä½¿ç”¨`RestTemplate`è¯·æ±‚æœåŠ¡

```java
@RestController
@Slf4j
@RequestMapping("order")
public class OrderController {

    @Resource
    private RestTemplate restTemplate;

    public static final String PaymentSrv_URL = "http://localhost:8001";

    @GetMapping("/addOrder")
    public CommonResult addPayment(Payment payment) {
        return restTemplate.postForObject(PaymentSrv_URL + "/payment/add",
                payment, CommonResult.class);
    }

    @GetMapping("/getOrderById")
    public CommonResult getPaymentById(@RequestParam("id") Long id) {
        System.out.println("");
        return restTemplate.getForObject(PaymentSrv_URL + "/payment/getPaymentById?id=" + id,
                CommonResult.class);
    }
}
```

æµ‹è¯•é€šè¿‡~~~~







## æŠ½å–å…¬å…±æ¨¡å—

è§‚å¯Ÿå‘ç°ä¸¤ä¸ªæ¨¡å—éƒ½æœ‰ç›¸åŒçš„ä¸¤ä¸ªå®ä½“ç±»ï¼Œè€Œä¸”`CommonResult`åº”è¯¥ä¸å±äºæ˜¯ä¸šåŠ¡ç±»ä¸­çš„ï¼Œæ‰€ä»¥éœ€è¦å°†ä»–ä»¬æŠ½å–å‡ºæ¥æ”¾å…¥åˆ°å…¬å…±æ¨¡å—`common`æˆ–è€…`model`æ¨¡å—

æ¥ä¸‹è¿›è¡Œæ”¹é€ ï¼Œå°†entitiesç§»åŠ¨åˆ°`common`æ¨¡å—ä¸‹ï¼ŒåŒæ—¶å°†ä¸€ä¸‹å…¬å…±çš„ä¾èµ–ä¹Ÿæ”¾åˆ°`common`ä¸‹

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-devtools</artifactId>
        <scope>runtime</scope>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>
    <dependency>
        <groupId>cn.hutool</groupId>
        <artifactId>hutool-all</artifactId>
        <version>5.8.8</version>
    </dependency>
</dependencies>
```

![image-20230205174812928](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230205174812928.png)

å…¶ä»–æ¨¡å—å¼•ç”¨å®ƒå³å¯

```xml
<dependency>
    <groupId>com.atguigu.com</groupId>
    <artifactId>cloud-api-commons</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

ä»¥åå°±å¯ä»¥å®ä½“ç±»æ”¾åˆ°commonä¸­äº†ï¼Œè¿™æ ·å°±ä¸ç”¨é‡å¤å†™



# ä¸‰ã€æœåŠ¡æ³¨å†Œä¸å‘ç°

**ä»€ä¹ˆæ˜¯æœåŠ¡æ²»ç†**

åœ¨æˆ‘ä»¬çš„å‰ä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†`RestTemplate`æ¥ç›´æ¥è¯·æ±‚ç›®æ ‡åœ°å€ï¼Œè¿™ç§è°ƒç”¨æ–¹å¼æ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œä½†æ˜¯ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯ä¸€æ—¦å¾®æœåŠ¡æ¨¡å—å¤šäº†ä¹‹åï¼Œå®ƒä»¬ä¹‹é—´çš„ä¾èµ–å…³ç³»å°±éå¸¸å¤æ‚ï¼Œéš¾ä»¥ç®¡ç†ã€‚æƒ³æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæŸäº›æœåŠ¡åœ°å€æ”¹å˜ï¼Œæˆ‘ä»¬ç¨‹åºä¸­çš„è¯·æ±‚åœ°å€ä¹Ÿéœ€è¦ä¿®æ”¹ï¼Œå¦‚æœé¡¹ç›®éå¸¸å¤§çš„è¯ï¼Œæ”¹èµ·æ¥ä¹Ÿæ˜¯å¾ˆéº»çƒ¦çš„ã€‚æ‰€ä»¥éœ€è¦ä½¿ç”¨æœåŠ¡æ²»ç†ï¼Œç®¡ç†æœåŠ¡ä¸æœåŠ¡ä¹‹é—´çš„ä¾èµ–ï¼Œå®ç°æœåŠ¡çš„è°ƒç”¨ã€è´Ÿè½½å‡è¡¡ã€å®¹é”™ç­‰ï¼Œå®ç°æœåŠ¡æ³¨å†Œä¸å‘ç°ã€‚



**ä»€ä¹ˆæ˜¯æœåŠ¡æ³¨å†Œä¸å‘ç°**

æœåŠ¡æ³¨å†Œï¼šè¦å¯¹æœåŠ¡è¿›è¡Œç®¡ç†ï¼Œé¦–å…ˆéœ€è¦å‘Šè¯‰æˆ‘æœåŠ¡åœ¨å“ªï¼Œå®ƒå«ä»€ä¹ˆï¼Œæ‰€ä»¥åœ¨è°ƒåº¦ä¹‹é—´éœ€è¦å°†æœåŠ¡çš„ä¿¡æ¯æ³¨å†Œåˆ°æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚

å‘ç°ï¼šé€šè¿‡è½®è¯¢çš„è´Ÿè½½ç®—æ³•å‘é€å¿ƒè·³ï¼Œé»˜è®¤å‘¨æœŸæ˜¯30ç§’ï¼Œå¦‚æœåœ¨å¤šä¸ªå‘¨æœŸæ²¡æœ‰æ”¶åˆ°æ¥è‡ªæœåŠ¡çš„å¿ƒè·³ï¼Œæ³¨å†Œä¸­å¿ƒå°±ä¼šç§»é™¤è¿™ä¸ªæœåŠ¡ã€‚

![image-20230206114138304](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206114138304.png)

ä¸Šå›¾å·¦è¾¹æ˜¯Eurekaçš„æ¶æ„ï¼Œå³å›¾æ˜¯Dubboçš„æ¶æ„ã€‚éƒ½æ˜¯å…ˆæ³¨å†Œï¼Œç„¶åå†è°ƒç”¨





## Eurekaï¼ˆåœæ›´ç»´æŠ¤âš ï¼‰

![image-20230206114554754](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206114554754.png)

***Eurekaæœ‰ä¸¤å¤§ç»„ä»¶***

-   Eureka Serverï¼šæä¾›æœåŠ¡æ³¨å†ŒæœåŠ¡ã€‚

    å„ä¸ªå¾®æœåŠ¡èŠ‚ç‚¹é€šè¿‡é…ç½®å¯åŠ¨åï¼Œä¼šåœ¨Eureka Serverè¿›è¡Œæ³¨å†Œï¼Œåœ¨Eurekaçš„ç®¡ç†ç•Œé¢å¯ä»¥çœ‹åˆ°å·²æ³¨å†Œçš„æœåŠ¡ä¿¡æ¯

-   Eureka Clientï¼šé€šè¿‡æ³¨å†Œä¸­å¿ƒè¿›è¡Œè®¿é—®ã€‚

    æ˜¯ä¸€ä¸ªJavaå®¢æˆ·ç«¯ï¼Œç”¨äºç®€åŒ–Eureka Serverçš„äº¤äº’ï¼Œå®¢æˆ·ç«¯åŒæ—¶ä¹Ÿå…·å¤‡ä¸€ä¸ªå†…ç½®çš„ã€ä½¿ç”¨è½®è¯¢(round-robin)è´Ÿè½½ç®—æ³•çš„è´Ÿè½½å‡è¡¡å™¨ã€‚åœ¨åº”ç”¨å¯åŠ¨åï¼Œå°†ä¼šå‘Eureka Serverå‘é€å¿ƒè·³(é»˜è®¤å‘¨æœŸä¸º30ç§’)ã€‚å¦‚æœEureka Serveråœ¨å¤šä¸ªå¿ƒè·³å‘¨æœŸå†…æ²¡æœ‰æ¥æ”¶åˆ°æŸä¸ªèŠ‚ç‚¹çš„å¿ƒè·³ï¼ŒEurekaServerå°†ä¼šä»æœåŠ¡æ³¨å†Œè¡¨ä¸­æŠŠè¿™ä¸ªæœåŠ¡èŠ‚ç‚¹ç§»é™¤ï¼ˆé»˜è®¤90ç§’ï¼‰



### æ­å»ºå•æœºæœåŠ¡

æ”¹é€ æˆ‘ä»¬ä¹‹å‰çš„ä¸¤ä¸ªæœåŠ¡ï¼ˆè®¢å•å’Œæ”¯ä»˜ï¼‰ï¼Œä½¿ç”¨Eurekaå¯¹ä»–ä»¬è¿›è¡Œç®¡ç†



#### â‘ æ­å»ºæ³¨å†Œä¸­å¿ƒ

1.  å»ºæ¨¡å— -> `cloud-eureka-server7001`

2.  æ”¹pom

    ```xml
    <artifactId>cloud-eureka-server7001</artifactId>
    
    <dependencies>
        <!--eureka-server-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>
        <!-- å¼•å…¥è‡ªå·±å®šä¹‰çš„apié€šç”¨åŒ…ï¼Œå¯ä»¥ä½¿ç”¨Paymentæ”¯ä»˜Entity -->
        <dependency>
            <groupId>com.atguigu</groupId>
            <artifactId>cloud-api-commons</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <!--boot web actuator-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <!--ä¸€èˆ¬é€šç”¨é…ç½®-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
        </dependency>
    </dependencies>
    ```

3.  æ”¹yml

    ```yaml
    server:
      port: 7001
    
    eureka:
      instance:
        hostname: localhost
      client:
        # æ˜¯å¦å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œ -> å½“å‰æ˜¯æ³¨å†Œä¸­å¿ƒï¼Œæ‰€ä»¥ä¸ºfalse
        register-with-eureka: false
        # æ˜¯å¦éœ€è¦æ£€ç´¢æœåŠ¡ -> falseè¡¨ç¤ºå½“å‰ç«¯æ˜¯æœåŠ¡ä¸­å¿ƒ
        fetch-registry: false
        # æ³¨å†Œä¸­å¿ƒçš„åœ°å€
        service-url:
          defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/
    ```

4.  ä¸»å¯åŠ¨

    ```java
    @SpringBootApplication
    @EnableEurekaServer
    public class EurekaMain7001 {
    
        public static void main(String[] args) {
            SpringApplication.run(EurekaMain7001.class, args);
        }
    }
    ```

==æ³¨æ„ï¼šServerç«¯çš„å¯åŠ¨æ³¨è§£æ˜¯`@EnableEurekaServer`ï¼Œå®¢æˆ·ç«¯çš„å¯åŠ¨æ³¨è§£æ˜¯`@EnableEurekaClient`==

å¯åŠ¨æµ‹è¯•ï¼šæµè§ˆå™¨ä¸­è¾“å…¥`localhost:7001`è®¿é—®æ§åˆ¶é¡µé¢

![image-20230206121914411](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206121914411.png)

æµ‹è¯•æˆåŠŸ~~~



#### â‘¡å°†æ¨¡å—æ³¨å†Œ

ä¸¤ä¸ªæ¨¡å—æ‰§è¡ŒåŒæ ·çš„æ“ä½œ

1.  å¼•å…¥ä¾èµ–

    ```xml
    <!--eureka-client-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
    ```

2.  æ”¹yml -> æ·»åŠ eurakeçš„é…ç½®

    ```yaml
    eureka:
      client:
        # æ˜¯å¦æ³¨å†Œåˆ°eurekaä¸­ -> trueä¸ºæ˜¯
        register-with-eureka: true
        # æ˜¯å¦æ˜¯å¦ä»EurekaServeræŠ“å–å·²æœ‰çš„æ³¨å†Œä¿¡æ¯ï¼Œé»˜è®¤ä¸ºtrueã€‚
        # å•èŠ‚ç‚¹æ— æ‰€è°“ï¼Œé›†ç¾¤å¿…é¡»è®¾ç½®ä¸ºtrueæ‰èƒ½é…åˆribbonä½¿ç”¨è´Ÿè½½å‡è¡¡
        fetch-registry: true
        # æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡åœ°å€
        service-url:
          defaultZone: http://localhost:7001/eureka
    ```

3.  å¯åŠ¨æµ‹è¯•

    ![image-20230206122324638](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206122324638.png)

    å¯ä»¥çœ‹åˆ°æœåŠ¡éƒ½æ³¨å†Œè¿›æ¥



==***å‡ºç°ä¸€ä¸ªå°é—®é¢˜***==![image-20230206122047376](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206122047376.png)

æ³¨æ„ï¼šå‡ºç°`UNKNOWN`æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰ç»™æœåŠ¡èµ·åå­—ï¼ŒåŠ ä¸Šåå­—å°±å¯ä»¥æ˜¾ç¤ºäº†

```yml
spring:
  application:
    name: cloud-order-service
```

æˆåŠŸ~~~



#### â‘¢è°ƒç”¨æœåŠ¡

è¿™é‡Œä¸ç”¨ä¿®æ”¹ï¼Œè¿˜æ˜¯ä½¿ç”¨`RestTemplate`å‘èµ·è¯·æ±‚





### æ­å»ºé›†ç¾¤æœåŠ¡

 é—®é¢˜ï¼šå¾®æœåŠ¡RPCè¿œç¨‹è°ƒç”¨æœåŠ¡çš„æ ¸å¿ƒæ˜¯ä»€ä¹ˆï¼Ÿ

é«˜å¯ç”¨ï¼ŒæœåŠ¡ä¸­å¿ƒæŒ‚äº†ï¼Œæ•´ä¸ªå¾®æœåŠ¡ä¸å¯ç”¨ï¼Œæ‰€ä»¥è¦é‡‡ç”¨é›†ç¾¤æœåŠ¡ä¿è¯å®ƒçš„é«˜å¯ç”¨



#### â‘ é›†ç¾¤åŸç†è¯´æ˜

Eurake æœåŠ¡å’Œ EurakeæœåŠ¡ä¹‹é—´ç›¸äº’æ³¨å†Œï¼Œå½¼æ­¤å®ˆæœ›ã€‚



#### â‘¡æ­å»º

1.  åˆ›å»ºç¬¬äºŒä¸ªEurake Serverï¼Œæ¨¡å—åä¸º`cloud-eureka-server7002`ï¼Œ==ç«¯å£å·ä¸º7002==

2.  pomä¸€è‡´

3.  yamläº›è®¸ä¸åŒ

    ![image-20230206142300581](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206142300581.png)

    é¦–å…ˆï¼Œå› ä¸ºæ˜¯æ­å»ºé›†ç¾¤ï¼Œæ‰€ä»¥ä¼šæœ‰å¾ˆå¤šå°æœºå™¨ï¼Œæ‰€ä»¥å®ƒä»¬çš„ä¸»æœºåä¸èƒ½ä¸ºåŒæ ·ï¼Œæˆ‘ä»¬æ˜¯åœ¨æœ¬åœ°æµ‹è¯•çš„ï¼Œå› æ­¤ä½¿ç”¨ä¸»æœºåæ˜ å°„çš„æ–¹å¼æ¥æµ‹è¯•ã€‚åœ¨æœ¬åœ°çš„`host`æ–‡ä»¶ä¿®æ”¹æ˜ å°„

    | åŸŸå           | ip        |
    | -------------- | --------- |
    | eureka7001.com | 127.0.0.1 |
    | eureka7002.com | 127.0.0.1 |

    æ˜ å°„å®Œæˆä¹‹åè¿˜éœ€è¦ä¿®æ”¹éœ€è¦å°†æœåŠ¡æ³¨å†Œçš„ç›®æ ‡æ³¨å†Œä¸­å¿ƒï¼Œé›†ç¾¤ä¹‹é—´çš„æœåŠ¡ç›¸äº’æ³¨å†Œï¼Œä¹Ÿå°±æ˜¯è¯´7001éœ€è¦æ³¨å†Œåˆ°7002ï¼Œ7002éœ€è¦æ³¨å†Œåˆ°7001ã€‚æ¥ä¸‹æ¥éœ€è¦ä¿®æ”¹`ymlé…ç½®`

    **æœåŠ¡ä¸»æœºåä¿®æ”¹ï¼Œä¸¤ä¸ªéƒ½è¦ä¿®æ”¹æˆå¯¹åº”çš„ä¸»æœºå**

    ![image-20230206143606854](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206143606854.png)

    **æ³¨å†Œä¸­å¿ƒåœ°å€ä¿®æ”¹**

    ![image-20230206142837211](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206142837211.png)

    ```yml
    # 7001 é…ç½®
    service-url:
      # defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/
      defaultZone: http://eureka7002.com:7002.comeureka/
    ```

    ```yml
    # 7002 é…ç½®
    service-url:
      # defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/
      defaultZone: http://eureka7001.com:7001.comeureka/
    ```

4.  å¯åŠ¨æµ‹è¯•

    7001æ˜¾ç¤º

    ![image-20230206144705582](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206144705582.png)

    7002æ˜¾ç¤º

    ![image-20230206144738040](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206144738040.png)

    å®Œç¾~~~ï¼Œè€å­çœŸæ˜¯å¤©æ‰ï¼Œå“ˆå“ˆå“ˆ



#### â‘¢æœåŠ¡æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒé›†ç¾¤

éœ€è¦ä¿®æ”¹ymlæ–‡ä»¶ï¼Œå°†æ³¨å†Œä¸­å¿ƒçš„åœ°å€è¿›è¡Œæ·»åŠ ï¼Œä¸¤ä¸ªæ¨¡å—éƒ½è¦

```yml
# æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡åœ°å€
service-url:
  defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/
```

![image-20230206145858717](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206145858717.png)

æµ‹è¯•æˆåŠŸ~~~,èŠœæ¹–



### è´Ÿè½½å‡è¡¡

æˆ‘iä»¬è¯´è®¢å•æ¨¡å—å®ƒæ˜¯æ¶ˆè´¹è€…ï¼Œæ”¯ä»˜æ¨¡å—æ˜¯æä¾›è€…ï¼Œé‚£ä¹ˆåœ¨å¾®æœåŠ¡ä¸­ï¼ŒæœåŠ¡è€…ä¸€èˆ¬ä¹Ÿæ˜¯ä»¥é›†ç¾¤çš„å½¢å¼éƒ¨ç½²ï¼Œeurekaå¯ä»¥å¯¹è¯·æ±‚è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œè®©é›†ç¾¤å¹³æ‘Šè¯·æ±‚æµé‡



#### â‘ æä¾›è€…å¢åŠ 

å½“å‰æˆ‘ä»¬çš„æ”¯ä»˜æ¨¡å—åªæœ‰ä¸€ä¸ªï¼Œæˆ‘ä»¬ç»™å®ƒå¢åŠ ä¸€ä¸ªï¼Œå…¶ä»–çš„ä¿æŒä¸å˜ï¼Œç«¯å£å·æ”¹ä¸º`8003`ï¼Œæ¨¡å—åä¸º`cloud-eutake-server8003`



#### â‘¡ä¿®æ”¹æ¶ˆè´¹è€…çš„è¯·æ±‚è·¯å¾„

![image-20230206150900172](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206150900172.png)

åœ¨ä¹‹å‰æˆ‘ä»¬è¿™ä¸ªè¯·æ±‚åœ°å€æ˜¯å†™æ­»çš„ï¼Œè¿™æ ·å°±è¾¾ä¸åˆ°è´Ÿè½½å‡è¡¡çš„æ•ˆæœï¼Œæ‰€ä»¥éœ€è¦å°†å®ƒçš„åœ°å€ä¿®æ”¹ä¸ºeurekaæä¾›çš„åœ°å€`http://CLOUD-PAYMENT-SERVICE`ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªåŸŸåå°±æ˜¯æˆ‘ä»¬çš„åº”ç”¨åï¼Œæ‰€ä»¥è¿™ä¸ªåº”ç”¨åæ˜¯å¾ˆé‡è¦çš„!!!

![image-20230206151223413](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206151223413.png)

æ¥ç€éœ€è¦ä¿®æ”¹ä¸€ä¸‹æˆ‘ä»¬çš„æ”¯ä»˜æ¨¡å—æ¥å£ï¼Œè®©å®ƒè¾“å‡ºçš„ä¿¡æ¯å¯ä»¥çœ‹åˆ°æ˜¯è°ƒç”¨é‚£ä¸ªç«¯å£å·çš„æœåŠ¡ã€‚

```java
@Value("${server.port}")
private Integer serverPort;
```

![image-20230206151534475](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206151534475.png)

æœ€åï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ªæ³¨è§£å¼€å¯è´Ÿè½½åŠŸèƒ½

```java
@Bean
@LoadBalanced //ä½¿ç”¨@LoadBalancedæ³¨è§£èµ‹äºˆRestTemplateè´Ÿè½½å‡è¡¡çš„èƒ½åŠ›
public RestTemplate restTemplate() {
    return new RestTemplate();
}
```



#### â‘¢å¯åŠ¨æµ‹è¯•

![image-20230206152450167](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206152450167.png)

![image-20230206152435291](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206152435291.png)

å®Œç¾~~~





### actuatorå¾®æœåŠ¡ä¿¡æ¯å®Œå–„

#### ç›‘æ§æ¥å£å

![image-20230206165752800](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206165752800.png)

åœ¨euekaçš„ç®¡ç†ç•Œé¢å¯ä»¥çœ‹åˆ°æœ‰`actuator`ä¿¡æ¯ç›¸å…³çš„é“¾æ¥ï¼Œå®ƒçš„å‘½åæ˜¯`ä¸»æœºå:æœåŠ¡å:ç«¯å£å·`ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä¿®æ”¹æˆæˆ‘ä»¬çš„ä¸šåŠ¡åç§°ã€‚è¿™ä¸ªé“¾æ¥è·³è½¬çš„urlæ˜¯`ä¸»æœºå:ç«¯å£å·/actuator/info`ï¼Œæ˜¯ä»¥ä¸»æœºåçš„æ–¹å¼å»è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹æˆä»¥ipçš„æ–¹å¼å»è®¿é—®ï¼Œè¿™æ ·å¯ä»¥åœ¨æ’æŸ¥é”™è¯¯çš„æ—¶å€™å®šä½é‚£ä¸ªæœºå­å‡ºç°äº†é—®é¢˜ã€‚



#### ä¿®æ”¹æœåŠ¡idå’Œæ˜¾ç¤ºip

```yaml
eureka:
  instance:
    instance-id: payment8001
    prefer-ip-address: true
```

**æµ‹è¯•**

![image-20230206171048764](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206171048764.png)

å½“å‰åªä¿®æ”¹äº†ä¸€å°æœºå­ï¼Œæ‰€ä»¥å¦å¤–ä¸¤å°è¿˜æ˜¯é»˜è®¤çš„å‘½å

ç‚¹å‡»é“¾æ¥è·³è½¬å¯ä»¥çœ‹åˆ°ipæ˜¾ç¤ºå‡ºæ¥äº†

![image-20230206171133576](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206171133576.png)





### æœåŠ¡å‘ç°Discovery

æ€ä¹ˆè·å–æ³¨å†Œä¸­å¿ƒä¸Šçš„æœåŠ¡ä¿¡æ¯å‘¢ï¼Œé€šè¿‡æœåŠ¡å‘ç°æœºåˆ¶è·å–

è¿™é‡Œæˆ‘ä»¬è·å–`payment8001`æœåŠ¡çš„ä¿¡æ¯

1.  ä¾èµ–`DiscoveryClient`

    ```java
    @Resource
    private DiscoveryClient discoveryClient;
    ```

2.  ä¿®æ”¹PaymentController  -> åˆ›å»ºè®¿é—®æ¥å£

    ```java
    @GetMapping("/discovery")
    public DiscoveryClient getDiscovery() {
        // è·å–æ‰€æœ‰æœåŠ¡
        List<String> services = discoveryClient.getServices();
        for (String service : services) {
            log.info(service);
        }
        // è·å–å®ä¾‹
        List<ServiceInstance> instances = discoveryClient.getInstances("CLOUD-PAYMENT-SERVICE");
        for (ServiceInstance instance : instances) {
            log.info(instance.getServiceId() + "\t" + instance.getHost()
                     + "\t" + instance.getPort() + "\t" + instance.getUri());
        }
        return this.discoveryClient;
    }
    ```

3.  å¼€å¯æœåŠ¡å‘ç°æœºåˆ¶

    ```java
    // ä¸»ç±»æ·»åŠ 
    @EnableDiscoveryClient
    ```

4.  ==æ³¨æ„ï¼šéœ€è¦å°†`eureka.client.fetch-registry`æ”¹ä¸º`true`æ‰èƒ½è·å–åˆ°æœåŠ¡ä¿¡æ¯ï¼Œå› ä¸ºè¿™ä¸ªåŠŸèƒ½å°±æ˜¯æ§åˆ¶æˆ‘ä»¬æ˜¯å¦èƒ½è·å–æ³¨å†Œä¸­å¿ƒä¿¡æ¯çš„å¼€å…³.==

**æµ‹è¯•**

è®¿é—®`http://localhost:8001/payment/discovery`

![image-20230206173433796](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206173433796.png)

å¯ä»¥çœ‹åˆ°è¿”å›çš„æ˜¯æ³¨å†Œçš„æœåŠ¡åˆ—è¡¨

æŸ¥çœ‹æ—¥å¿—è¾“å‡º

![image-20230206173647625](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206173647625.png)

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è·å–çš„æŒ‡å®šæœåŠ¡idçš„æœåŠ¡å®ä¾‹ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¿®æ”¹å’Œæ²¡ä¿®æ”¹çš„ä¸¤ä¸ªæœåŠ¡





### Eurekaè‡ªæˆ‘ä¿æŠ¤æ¨¡å¼

![image-20230206164113933](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206164113933.png)

åœ¨eurekaçš„ç®¡ç†ç•Œé¢å¯ä»¥çœ‹åˆ°è¿™ä¸€è¡Œè¯ï¼Œå®ƒçš„æ„æ€æ˜¯Eurekaè¿›å…¥äº†ä¿æŠ¤æ¨¡å¼



#### ***ä»€ä¹ˆæ˜¯è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼***

eurekaå‘ç°æœºåˆ¶æ˜¯é»˜è®¤æ¯30ç§’å‘é€ä¸€èµ·å¿ƒè·³ï¼Œå¦‚æœ30è¿‡åæ²¡æœ‰å‘é€å¿ƒè·³ï¼Œå¼€å¯è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼çš„è¯ï¼Œé‚£ä¹ˆå®ƒé»˜è®¤å°†æ­¤æœåŠ¡ä¿¡æ¯ä¿å­˜90ç§’ï¼Œåœ¨90ç§’å†…è¿˜æ˜¯æ²¡æœ‰å‘é€å¿ƒè·³ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå°†æ­¤æœåŠ¡ç§»é™¤ã€‚å…³é—­è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼çš„è¯ï¼Œåœ¨æŒ‡å®šæ—¶é—´æ²¡æœ‰æ”¶åˆ°Eureka Clinetå‘é€çš„å¿ƒè·³ï¼Œå®ƒä¼šç›´æ¥ç§»é™¤ï¼Œä¸è¿›è¡Œè‡ªæˆ‘ä¿æŠ¤ï¼ˆæ®‹å¿çš„Eureka~~~ï¼‰ã€‚

è‡ªæˆ‘ä¿æŠ¤çš„å¥½å¤„å°±æ˜¯åœ¨å‘é€å¿ƒè·³çš„è¿‡ç¨‹ä¸­æœåŠ¡ç½‘ç»œæ‹¥å¡æˆ–è€…æœåŠ¡æ‰§è¡Œç¼“æ…¢å¯¼è‡´å¿ƒè·³å‘é€ä¸åŠæ—¶ï¼Œè¿™ä¸ªæ—¶å€™eurekaä¼šç»™å®ƒä¸€å®šçš„æ—¶é—´å‘é€å¿ƒè·³ï¼Œå¦‚æœè¶…å‡ºè¿™ä¸€æ®µæ—¶é—´ï¼Œé‚£ä¹ˆeurekaåªèƒ½ç‹ å¿ƒçš„å°†å®ƒç§»é™¤ã€‚

è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ç¬¦åˆCSPä¸­çš„APæœºåˆ¶



#### ***å¦‚ä½•å…³é—­è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼***

å®ƒé»˜è®¤æ˜¯å¼€å¯çš„ï¼Œæˆ‘ä»¬æƒ³è¦å…³é—­å°±éœ€è¦ä¿®æ”¹å®ƒçš„é…ç½®ï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹`yamlé…ç½®æ–‡ä»¶`

-   Eureka Serverç«¯

    ```yaml
    server:
      # ç¦ç”¨è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼
      enable-self-preservation: false
    ```

-   Eureka Clientç«¯

    ```yaml
    eureka:
      instance:
        # å‘é€å¿ƒè·³é—´éš”æ—¶é—´ï¼Œé»˜è®¤æ˜¯30s
        lease-renewal-interval-in-seconds: 1
        # ç­‰å¾…æ—¶é—´ï¼Œé»˜è®¤æ˜¯90sï¼Œå¼€å¯è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ä¼šç­‰å¾…åˆ°æŒ‡å®šçš„æ—¶é—´ï¼Œåœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰å‘é€å¿ƒè·³ï¼Œeurekaç§»é™¤è¯¥æœåŠ¡ä¿¡æ¯
        lease-expiration-duration-in-seconds: 2
    ```



**æµ‹è¯•**

å¯åŠ¨Serverï¼Œåœ¨å¯åŠ¨clientï¼Œç„¶ååœæ‰clientï¼Œçœ‹ç®¡ç†é¡µé¢æ˜¯å¦è¿˜æœ‰è¯¥æœåŠ¡





## Zookeeper

zookeeperæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼åè°ƒå·¥å…·ï¼Œå¯ä»¥å®ç°æ³¨å†Œä¸­å¿ƒåŠŸèƒ½ã€‚ä¸€èˆ¬æ˜¯ç”¨å®ƒå»æ›¿ä»£eurekaï¼Œä½†æ˜¯ç”¨çš„å°‘ï¼Œè¿™é‡Œä»‹ç»ä¸€ä¸‹å•æœºç‰ˆçš„zookeeperï¼Œé›†ç¾¤çš„å¯ä»¥è‡ªè¡Œå­¦ä¹ ã€‚å®‰è£…è¿™é‡Œä¹Ÿä¸è®²è§£ã€‚å½“å‰ä½¿ç”¨çš„cloudå¯¹åº”çš„zookeeperç‰ˆæœ¬æ˜¯`3.5.3-beta`



### â‘ æ„å»ºæœåŠ¡æä¾›è€…

å‘zkæ³¨å†Œä¿¡æ¯

1.  å»ºæ¨¡å— -> æ–°å»ºcloud-provider-payment8004

2.  æ”¹pom

    ```xml
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-zookeeper-discovery</artifactId>
    </dependency>
    ```

3.  æ”¹yml

    ```yaml
    server:
      port: 8004
    
    #æœåŠ¡åˆ«å----æ³¨å†Œzookeeperåˆ°æ³¨å†Œä¸­å¿ƒåç§°
    spring:
      application:
        name: cloud-provider-payment
      cloud:
        zookeeper:
          # zkæœåŠ¡å™¨åœ°å€ï¼Œæˆ‘è¿™é‡Œåšäº†æ˜ å°„
          connect-string: study-zookeeper.com:2181
    ```

4.  ä¸»å¯åŠ¨

    ```java
    @SpringBootApplication
    @EnableDiscoveryClient  //è¯¥æ³¨è§£ç”¨äºå‘ä½¿ç”¨consulæˆ–è€…zookeeperä½œä¸ºæ³¨å†Œä¸­å¿ƒæ—¶æ³¨å†ŒæœåŠ¡
    public class PaymentMain8004 {
    
        public static void main(String[] args) {
            SpringApplication.run(PaymentMain8004.class, args);
        }
    }
    ```

5.  ä¸šåŠ¡ç±»

    

**æŸ¥çœ‹**

å¯åŠ¨zkçš„clientç«¯æŸ¥çœ‹æ³¨å†Œçš„ä¿¡æ¯

![image-20230207111756161](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207111756161.png)

zkæ˜¯æ— çŠ¶æ€çš„ï¼Œåªè¦æœåŠ¡ä¸‹çº¿ï¼Œç«‹åˆ»å°†æœåŠ¡ä¿¡æ¯åˆ é™¤ï¼Œå†æ¬¡ä¸Šçº¿ï¼Œé‡æ–°åˆ†é…æ–°çš„idã€‚ä¸åƒeurekaé‚£æ ·æ‹¥æœ‰è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‚



### â‘¡æ„å»ºæœåŠ¡æ¶ˆè´¹è€…

è°ƒç”¨æä¾›è€…çš„æ¥å£

1.  æ–°å»ºcloud-consumerzk-order8002æ¨¡å—

2.  pom

    ```xml
    <dependencies>
        <!-- SpringBootæ•´åˆWebç»„ä»¶ -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency><!-- å¼•å…¥è‡ªå·±å®šä¹‰çš„apié€šç”¨åŒ…ï¼Œå¯ä»¥ä½¿ç”¨Paymentæ”¯ä»˜Entity -->
            <groupId>com.atguigu</groupId>
            <artifactId>cloud-api-commons</artifactId>
            <version>${project.version}</version>
        </dependency>
        <!-- SpringBootæ•´åˆzookeeperå®¢æˆ·ç«¯ -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-zookeeper-discovery</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    ```

3.  yml

    ```yaml
    server:
      port: 8004
    
    #æœåŠ¡åˆ«å----æ³¨å†Œzookeeperåˆ°æ³¨å†Œä¸­å¿ƒåç§°
    spring:
      application:
        name: cloud-provider-payment
      cloud:
        zookeeper:
          connect-string: study-zookeeper.com:2181
    ```

4.  å¯åŠ¨ç±»

    ```java
    @SpringBootApplication
    @EnableDiscoveryClient  //è¯¥æ³¨è§£ç”¨äºå‘ä½¿ç”¨consulæˆ–è€…zookeeperä½œä¸ºæ³¨å†Œä¸­å¿ƒæ—¶æ³¨å†ŒæœåŠ¡
    public class PaymentMain8004 {
    
        public static void main(String[] args) {
            SpringApplication.run(PaymentMain8004.class, args);
        }
    }
    ```

5.  ä¸šåŠ¡

    ```java
    @RestController
    public class PaymentController {
    
        @Value("${server.port}")
        private Integer serverPort;
    
        @GetMapping("/payment/zk")
        public String paymentZK() {
            return "springcloud with ckï¼š" + serverPort + "\t" + UUID.randomUUID().toString();
        }
    }
    ```

æŸ¥çœ‹æœåŠ¡æ˜¯å¦æ³¨å†Œè¿›zk

![image-20230207113727953](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207113727953.png)

æµ‹è¯•æœåŠ¡æ˜¯å¦æ­£å¸¸ -> è®¿é—®`http://localhost:8002/consumer/payment/zk`

![image-20230207113755471](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207113755471.png)

æ­£å¸¸~~~ğŸ˜‹ğŸ˜‹ğŸ˜‹





## Consul

### 1.ç®€ä»‹

å®˜ç½‘ï¼š`https://www.consul.io/`

![image-20230207141931306](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207141931306.png)

ä¸Šå›¾æ˜¯å®˜ç½‘çš„è¯´æ˜ã€‚

ç¿»è¯‘ï¼šHashiCorp Consul æ˜¯ä¸€ç§æœåŠ¡ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œä½¿å›¢é˜Ÿèƒ½å¤Ÿç®¡ç†æœåŠ¡ä¹‹é—´ä»¥åŠè·¨æœ¬åœ°å’Œå¤šäº‘ç¯å¢ƒå’Œè¿è¡Œæ—¶çš„å®‰å…¨ç½‘ç»œè¿æ¥ã€‚Consul ä¸ºç½‘ç»œåŸºç¡€è®¾æ–½è®¾å¤‡æä¾›æœåŠ¡å‘ç°ã€æœåŠ¡ç½‘æ ¼ã€æµé‡ç®¡ç†å’Œè‡ªåŠ¨æ›´æ–°ã€‚æ‚¨å¯ä»¥åœ¨å•ä¸ª Consul éƒ¨ç½²ä¸­å•ç‹¬æˆ–ä¸€èµ·ä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚

äººè¯ï¼šå°±æ˜¯æœåŠ¡æ³¨å†Œä¸å‘ç°åŠŸèƒ½å’ŒæœåŠ¡ç®¡ç†ï¼Œå½“ç„¶è¿˜æœ‰ä¸€äº›å…¶ä»–çš„åŠŸèƒ½

| åŠŸèƒ½          | å®ç°                                                 |
| ------------- | ---------------------------------------------------- |
| æœåŠ¡å‘ç°      | æä¾›HTTPå’ŒDNSä¸¤ç§å‘ç°æ–¹å¼ã€‚                          |
| å¥åº·ç›‘æµ‹      | æ”¯æŒå¤šç§æ–¹å¼ï¼ŒHTTPã€TCPã€Dockerã€Shellè„šæœ¬å®šåˆ¶åŒ–ç›‘æ§ |
| KVå­˜å‚¨        | Keyã€Valueçš„å­˜å‚¨æ–¹å¼                                 |
| å¤šæ•°æ®ä¸­å¿ƒ    | Consulæ”¯æŒå¤šæ•°æ®ä¸­å¿ƒ                                 |
| å¯è§†åŒ–Webç•Œé¢ |                                                      |





### 2.å®‰è£…

åœ¨å®˜ç½‘ä¸‹è½½ï¼Œè¿™é‡Œé€‰æ‹©çš„æ˜¯`1.13.0`ç‰ˆæœ¬ï¼Œé€‰æ‹©é€‚åˆä½ çš„æœºå™¨çš„ç³»ç»Ÿå’Œæ¶æ„ç±»å‹ï¼Œæˆ‘è¿™é‡Œæ˜¯windowå’Œx86æ¶æ„

ä¸‹è½½å®Œè§£å‹åæ˜¯ä¸€ä¸ª`.exe`æ–‡ä»¶ã€‚

***è¿è¡Œ***ï¼šæ‰“å¼€cmdç•Œé¢è¾“å…¥`consul agent -dev`ï¼Œå®ƒé»˜è®¤æ˜¯åœ¨æœ¬æœºçš„`8500`ç«¯å£

***è®¿é—®***ï¼šæµè§ˆå™¨è¾“å…¥`http://localhost:8500/`æˆ–`http://localhost:8500/ui/dc1/services`è®¿é—®å¯è§†åŒ–webç•Œé¢

![image-20230207141708460](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207141708460.png)





### 3.ä½¿ç”¨

è¿˜æ˜¯ä¸€æ ·çš„å¥—è·¯ï¼Œäº”æ­¥èµ°ï¼Œå»ºmodelã€æ”¹pomã€æ”¹ymlã€ä¸»å¯åŠ¨ã€ä¸šåŠ¡ç±»

#### 3.1 æ„å»ºæä¾›è€…æ¨¡å—

1.  æ–°å»º`cloud-providerconsul-payment8006`æ¨¡å—

2.  pom

    ```xml
    <dependencies>
            <!--SpringCloud consul-server -->
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-starter-consul-discovery</artifactId>
            </dependency>
            <!-- SpringBootæ•´åˆWebç»„ä»¶ -->
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-web</artifactId>
            </dependency>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-actuator</artifactId>
            </dependency>
            <!--æ—¥å¸¸é€šç”¨jaråŒ…é…ç½®-->
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-devtools</artifactId>
                <scope>runtime</scope>
                <optional>true</optional>
            </dependency>
            <dependency>
                <groupId>org.projectlombok</groupId>
                <artifactId>lombok</artifactId>
                <optional>true</optional>
            </dependency>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-test</artifactId>
                <scope>test</scope>
            </dependency>
        </dependencies>
    
    ```

3.  yml

    ```yaml
    ###consulæœåŠ¡ç«¯å£å·
    server:
      port: 8006
    
    spring:
      application:
        name: consul-provider-payment
    ####consulæ³¨å†Œä¸­å¿ƒåœ°å€
      cloud:
        consul:
          host: localhost
          port: 8500
          discovery:
            #hostname: 127.0.0.1
            service-name: ${spring.application.name}
    
    ```

4.  ä¸»å¯åŠ¨

    ```java
    @SpringBootApplication
    @EnableDiscoveryClient
    public class PaymentConsulMain8004 {
    
        public static void main(String[] args) {
            SpringApplication.run(PaymentConsulMain8004.class, args);
        }
    }
    ```

5.  ä¸šåŠ¡

    ```java
    @RestController
    public class PaymentController {
    
        @Value("${server.port}")
        private Integer serverPort;
    
        @GetMapping("/payment/zk")
        public String paymentZK() {
            return "springcloud with consulï¼š" + serverPort + "\t" + UUID.randomUUID().toString();
        }
    }
    ```



#### 3.2 æ„å»ºæ¶ˆè´¹è€…æ¨¡å—

1.  æ–°å»º`cloud-consumerconsul-order8002`æ¨¡å—

2.  pom

    ```xml
    <dependencies>
        <!--SpringCloud consul-server -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-consul-discovery</artifactId>
        </dependency>
        <!-- SpringBootæ•´åˆWebç»„ä»¶ -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <!--æ—¥å¸¸é€šç”¨jaråŒ…é…ç½®-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    ```

3.  yml

    ```yaml
    ###consulæœåŠ¡ç«¯å£å·
    server:
      port: 8002
    
    spring:
      application:
        name: cloud-consumer-order
    ####consulæ³¨å†Œä¸­å¿ƒåœ°å€
      cloud:
        consul:
          host: localhost
          port: 8500
          discovery:
            #hostname: 127.0.0.1
            service-name: ${spring.application.name}
    
    ```

4.  ä¸»å¯åŠ¨

    ```java
    @SpringBootApplication
    @EnableDiscoveryClient //è¯¥æ³¨è§£ç”¨äºå‘ä½¿ç”¨consulæˆ–è€…zookeeperä½œä¸ºæ³¨å†Œä¸­å¿ƒæ—¶æ³¨å†ŒæœåŠ¡
    public class OrderConsulMain8002
    {
        public static void main(String[] args)
        {
            SpringApplication.run(OrderConsulMain8002.class,args);
        }
    }
    ```

5.  ä¸šåŠ¡

    ```java
    @Configuration
    public class ApplicationContextBean
    {
        @Bean
        @LoadBalanced
        public RestTemplate getRestTemplate()
        {
            return new RestTemplate();
        }
    }
    ```

    ```java
    public class OrderController {
    
        @Resource
        private RestTemplate restTemplate;
    
        public static final String INVOKE_URL = "http://cloud-provider-payment";
    
        @GetMapping("/consumer/payment/consul")
        public String paymentInfo() {
            return "æ¶ˆè´¹è€…è°ƒç”¨æ”¯ä»˜æœåŠ¡ ---> result:" + restTemplate.getForObject(
                    INVOKE_URL + "/payment/zk", String.class);
        }
    }
    ```



#### 3.3 æµ‹è¯•

***æŸ¥çœ‹webç•Œé¢***

![image-20230207153540785](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207153540785.png)

å¯ä»¥çœ‹åˆ°å·²ç»æ³¨å†Œè¿›å»çš„ä¸¤ä¸ªæœåŠ¡



***æµ‹è¯•æ˜¯å¦å¯ä»¥è°ƒç”¨æä¾›è€…æ¥å£***

![image-20230207153822298](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207153822298.png)

æˆåŠŸ~~~ğŸ˜‹ğŸ˜‹ğŸ˜‹





## ä¸‰ä¸ªæ³¨å†Œä¸­å¿ƒå¼‚åŒç‚¹

### CAP

CAPç†è®ºå…³æ³¨ç²’åº¦æ˜¯æ•°æ®ï¼Œè€Œä¸æ˜¯æ•´ä½“ç³»ç»Ÿè®¾è®¡çš„ç­–ç•¥

-   C:Consistencyï¼ˆå¼ºä¸€è‡´æ€§ï¼‰
-   A:Availabilityï¼ˆå¯ç”¨æ€§ï¼‰
-   P:Partition toleranceï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰



### æ¡ˆä¾‹

#### AP

`eureka`å°±æ˜¯APã€‚

![image-20230207160815582](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207160815582.png)

APçš„ç‰¹ç‚¹å°±æ˜¯Aç³»ç»Ÿå’ŒBç³»ç»Ÿæ•°æ®åŒæ­¥å¤±è´¥æ—¶ï¼Œå®ƒä¼˜å…ˆè€ƒè™‘çš„æ˜¯å¯ç”¨æ€§ï¼Œæ‰€ä»¥å®ƒå°†æ—§çš„å€¼è¿”å›ï¼Œå¯¹äºä¸€äº›ä¸æ˜¯å¾ˆé‡è¦çš„æ•°æ®æ—¶ä½¿ç”¨CPæ¶æ„æ˜¯åˆç†çš„ã€‚



#### CP

`zookeeper`å’Œ`consul`æ˜¯CP

![image-20230207160934013](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207160934013.png)

CPå°±æ˜¯å¦‚æœæ•°æ®åŒæ­¥å¤±è´¥ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¿”å›ä¸€ä¸ªå¼‚å¸¸ã€‚å®ƒæŸå¤±äº†é«˜å¯ç”¨ï¼Œä½†æ˜¯ä¿è¯äº†ä¸€è‡´æ€§ï¼Œå¯¹äºä¸€äº›é‡è¦çš„æ•°æ®ä½¿ç”¨CPæ˜¯åˆç†çš„ã€‚







# å››ã€è´Ÿè½½å‡è¡¡æœåŠ¡è°ƒç”¨







## Ribbon

### 1ã€æ¦‚è¿°

åœ¨æˆ‘ä»¬å­¦ä¹ Eurekaçš„é‚£ä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬åœ¨`RestTemplate`ä¸Šä½¿ç”¨`@LoadBalanced `æ³¨è§£ï¼Œç”¨å®ƒæ¥å¼€å¯è´Ÿè½½å‡è¡¡ï¼Œå®ƒçš„åº•å±‚æ˜¯ä½¿ç”¨äº†`Ribbon`æ¥åšè´Ÿè½½å‡è¡¡

![image-20230212111414993](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230212111414993-16761716561541.png)



**LBï¼ˆè´Ÿè½½å‡è¡¡ï¼‰**

-   é›†ä¸­å¼LBï¼šå°†è¯·æ±‚ç”¨è¿‡æŸäº›ç­–ç•¥è½¬å‘åˆ°æœåŠ¡æ–¹ï¼Œå¯ä»¥æ˜¯ç¡¬ä»¶ã€ä¹Ÿå¯ä»¥æ˜¯è½¯ä»¶ï¼Œå¦‚nginx
-   è¿›ç¨‹å¼LBï¼šå®ƒæ˜¯å®¢æˆ·ç«¯ä¸Šçš„ä¸€ä¸ªè¿›ç¨‹ï¼Œå®ƒè´Ÿè´£è·å–æä¾›æ–¹çš„æä¾›æœåŠ¡çš„ä¸€ç³»åˆ—ä¸»æœºåœ°å€ï¼Œé€šè¿‡è´Ÿè½½å‡è¡¡ç®—æ³•å°†è¯·æ±‚å‘é€ç»™æä¾›æ–¹é›†ç¾¤ã€‚

ribbonå±äºæ˜¯è¿›ç¨‹å¼LBï¼Œeurekaçš„ä¾‹å­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥æˆ‘ä»¬åªåœ¨å®¢æˆ·ç«¯å¼€å¯äº†è´Ÿè½½å‡è¡¡ã€‚ribbonæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œåœ¨å®¢æˆ·ç«¯é€šè¿‡ç®—æ³•æ¥åšè´Ÿè½½å‡è¡¡è°ƒç”¨ã€‚å®ƒè¿˜å¯ä»¥ç»“åˆå…¶ä»–çš„å®¢æˆ·ç«¯ä½¿ç”¨ï¼Œä¸ä»…é™äºeureka

==Ribbonè¿›å…¥äº†ç»´æŠ¤æ¨¡å¼ï¼Œåé¢æœ‰æ–°çš„æŠ€æœ¯å¯ä»¥æ›¿ä»£å®ƒ==





### 2ã€Ribbonæ ¸å¿ƒç»„ä»¶IRule

IRuleï¼šæ ¹æ®ç‰¹å®šç®—æ³•ä»æœåŠ¡åˆ—è¡¨ä¸­è·å–æœåŠ¡

![image-20230212113530326](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230212113530326.png)

ä¸Šé¢æ˜¯IRuleçš„å®ç°ç±»ï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„è´Ÿè½½å‡è¡¡è§„åˆ™éƒ½ç»§æ‰¿äº†`AbstractLoadBalancerRule`

å®ƒä»¬å¯¹åº”çš„è§„åˆ™

| å®ç°ç±»                    | è§„åˆ™                                                         |
| ------------------------- | ------------------------------------------------------------ |
| RoundRobinRule            | è½®è¯¢                                                         |
| RandomRule                | éšæœº                                                         |
| RetryRule                 | å…ˆæŒ‰ç…§RoundRobinRuleçš„ç­–ç•¥è·å–æœåŠ¡ï¼Œå¦‚æœè·å–æœåŠ¡å¤±è´¥åˆ™åœ¨æŒ‡å®šæ—¶é—´å†…ä¼šè¿›è¡Œé‡è¯•ï¼Œè·å–å¯ç”¨çš„æœåŠ¡ |
| WeightedResponseTimeRule  | å¯¹RoundRobinRuleçš„æ‰©å±•ï¼Œå“åº”é€Ÿåº¦è¶Šå¿«çš„å®ä¾‹é€‰æ‹©æƒé‡è¶Šå¤§ï¼Œè¶Šå®¹æ˜“è¢«é€‰æ‹© |
| BestAvailableRule         | ä¼šå…ˆè¿‡æ»¤æ‰ç”±äºå¤šæ¬¡è®¿é—®æ•…éšœè€Œå¤„äºæ–­è·¯å™¨è·³é—¸çŠ¶æ€çš„æœåŠ¡ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªå¹¶å‘é‡æœ€å°çš„æœåŠ¡ |
| AvailabilityFilteringRule | å…ˆè¿‡æ»¤æ‰æ•…éšœå®ä¾‹ï¼Œå†é€‰æ‹©å¹¶å‘è¾ƒå°çš„å®ä¾‹                       |
| ZoneAvoidanceRule         | é»˜è®¤è§„åˆ™,å¤åˆåˆ¤æ–­serveræ‰€åœ¨åŒºåŸŸçš„æ€§èƒ½å’Œserverçš„å¯ç”¨æ€§é€‰æ‹©æœåŠ¡å™¨ |





### 3ã€æ›¿æ¢é»˜è®¤çš„IRule

åœ¨ä¹‹å‰çš„`cloud-consumer-order8002ï¼ˆrurekaå·¥ç¨‹ï¼‰`ä¸Šæ·»åŠ ä¸‹é¢çš„æ“ä½œ

1.  åˆ›å»ºä¸€ä¸ªæ–°çš„package

    `com.atguigu.myrule`

2.  é‡æ–°å®ç°IRule

    ```java
    @Configuration
    public class MySelfRule {
    
        @Bean
        public IRule myRule() {
            return new RandomRule();
        }
    }
    ```

3.  ä¸»å¯åŠ¨ç±»æ·»åŠ `@RibbonClient`

    ```java
    @SpringBootApplication
    @EnableEurekaClient
    @RibbonClient(name = "CLOUD-PAYMENT-SERVICE", configuration = MySelfRule.class)
    public class OrderMain8002 {
    
        public static void main(String[] args) {
            SpringApplication.run(OrderMain8002.class, args);
        }
    }
    ```

æ³¨æ„ç‚¹ï¼š

<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230212114841739.png" alt="image-20230212114841739" style="zoom:50%;" />

**å®˜æ–¹æ–‡æ¡£æ˜ç¡®ç»™å‡ºäº†è­¦å‘Š**ï¼š
è¿™ä¸ªè‡ªå®šä¹‰é…ç½®ç±»ä¸èƒ½æ”¾åœ¨@ComponentScanæ‰€æ‰«æçš„å½“å‰åŒ…ä¸‹ä»¥åŠå­åŒ…ä¸‹ï¼Œå¦åˆ™æˆ‘ä»¬è‡ªå®šä¹‰çš„è¿™ä¸ªé…ç½®ç±»å°±ä¼šè¢«æ‰€æœ‰çš„Ribbonå®¢æˆ·ç«¯æ‰€å…±äº«ï¼Œè¾¾ä¸åˆ°ç‰¹æ®ŠåŒ–å®šåˆ¶çš„ç›®çš„äº†ã€‚springBootå®ƒé»˜è®¤æ˜¯æ‰«æå½“å‰å¯åŠ¨ç±»æ‰€åœ¨åŒ…çš„ç»„ä»¶ä»¥åŠæ‰€åœ¨åŒ…å­åŒ…ä¸‹çš„æ‰€æœ‰ç»„ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°†è‡ªå®šä¹‰çš„`Rule`æ”¾åˆ°å…¶ä»–åŒ…ä¸‹





### 4ã€RoundRobinRuleæºç åˆ†æ

`RoundRobinRule`å®ƒçš„è§„åˆ™æ˜¯è½®è¯¢ï¼Œè½®è¯¢å°±æ˜¯ `è·å–çš„æœåŠ¡index = è¯·æ±‚çš„æ¬¡æ•° % æœåŠ¡æä¾›è€…çš„æ•°`ï¼Œé€šè¿‡è¿™ä¸ª`index`æ¥è·å–å¯¹åº”ä½ç½®çš„æœåŠ¡ä¿¡æ¯ï¼Œç„¶åå†å‘ç›®æ ‡ä¸»æœºå‘èµ·è¯·æ±‚

**æºç åˆ†æ**

IRuleä¸­æœ‰ä¸€ä¸ª`choose`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å®šä¹‰å¦‚ä½•è¿›è¡Œé€‰æ‹©ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹`RoundRobinRule`ä¸­çš„`choose`å°±çŸ¥é“æ˜¯æ€æ ·çš„è§„åˆ™

```java
public Server choose(ILoadBalancer lb, Object key) {
    if (lb == null) {
        log.warn("no load balancer");
        return null;
    }

    Server server = null;
    int count = 0;
    while (server == null && count++ < 10) {
        List<Server> reachableServers = lb.getReachableServers();
        List<Server> allServers = lb.getAllServers();
        // æ­£å¸¸è¿è¡Œçš„æä¾›è€…æ•°é‡
        int upCount = reachableServers.size();
        // æ€»çš„æä¾›è€…æ•°é‡
        int serverCount = allServers.size();

        if ((upCount == 0) || (serverCount == 0)) {
            log.warn("No up servers available from load balancer: " + lb);
            return null;
        }
	    // æœ€ä¸»è¦è·å–indexçš„æ–¹æ³• 
        int nextServerIndex = incrementAndGetModulo(serverCount);
        server = allServers.get(nextServerIndex);

        if (server == null) {
            /* Transient. */
            Thread.yield();
            continue;
        }

        if (server.isAlive() && (server.isReadyToServe())) {
            return (server);
        }

        // Next.
        server = null;
    }

    if (count >= 10) {
        log.warn("No available alive servers after 10 tries from load balancer: "
                + lb);
    }
    return server;
}
```

```java
// æ ¸å¿ƒæ–¹æ³•
private int incrementAndGetModulo(int modulo) {
    // è‡ªæ—‹é”
    for (;;) {
        int current = nextServerCyclicCounter.get();
        // current -> å½“å‰è¯·æ±‚æ¬¡æ•°
        // modulo -> æä¾›è€…æ•°é‡
        // å½“å‰è¯·æ±‚æ•° % æä¾›è€…æ•°é‡ = å®é™…è°ƒç”¨çš„æä¾›è€…
        int next = (current + 1) % modulo;
        if (nextServerCyclicCounter.compareAndSet(current, next))
            return next;
    }
}
```

ä¾‹å¦‚ï¼šæä¾›è€…æ•°é‡ä¸º3

| è¯·æ±‚æ•° | ç»“æœ                   |
| ------ | ---------------------- |
| 1      | 1 % 3 = 1ï¼Œlist.get(1) |
| 2      | 2 % 3 = 2ï¼Œlist.get(2) |
| 3      | 3 % 3 = 0ï¼Œlist.get(0) |
| 4      | 4 % 3 = 1ï¼Œlist.get(1) |

è§‚å¯Ÿå‘ç°ï¼Œè¯·æ±‚å¾ˆå‡åŒ€çš„åˆ†å‘ç»™æä¾›è€…ã€‚





### 5ã€æ‰‹å†™ä¸€ä¸ªè´Ÿè½½å‡è¡¡è°ƒç”¨

åœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬çŸ¥é“äº†è½®è¯¢ç®—æ³•çš„åŸç†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è‡ªå·±æ¥æ‰‹å†™ä¸€ä¸ªè½®è¯¢ç®—æ³•åšè´Ÿè½½å‡è¡¡



#### æä¾›è€…æ”¹é€ 

`cloud-provider-payment8001`å’Œ`cloud-provider-payment8003`ä¸¤ä¸ªæ¨¡å—æ·»åŠ æ¥å£

```java
@GetMapping("lb")
public String lb() {
    return serverPort.toString();
}
```



#### æ¶ˆè´¹è€…æ”¹é€ 

`cloud-consumer-order8002`

1.  é¦–å…ˆå®šä¹‰ä¸€ä¸ªè·å–æœåŠ¡ä¿¡æ¯çš„è§„åˆ™ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„è¿˜æ˜¯è½®è¯¢ç­–ç•¥

    

    ```java
    package com.atguigu.springcloud.lb;
    public interface LoadBalancer {
    
        /**
         * è·å–æœåŠ¡å®ä¾‹
         * @param serviceInstances æœåŠ¡å®ä¾‹åˆ—è¡¨
         * @return
         */
        ServiceInstance instance(List<ServiceInstance> serviceInstances);
    }
    ```

    ```java
    package com.atguigu.springcloud.lb;
    @Component
    @Slf4j
    public class CustomLB implements LoadBalancer {
    	
        // åŸå­ç±»
        private AtomicInteger atomicInteger = new AtomicInteger(0);
    
        public final  int getAndIncrement() {
            int current;
            int next;
            do {
                // è·å–å½“å‰å€¼
                current = this.atomicInteger.get();
                // ä¸‹ä¸€æ¬¡è¯·æ±‚æ•°ï¼Œè¶…è¿‡intæœ€å¤§å€¼å°±è®¾ç½®ä¸º0,
                next = current >= Integer.MAX_VALUE ? 0 : current + 1;
            } while (!this.atomicInteger.compareAndSet(current, next));
            log.info("*****next*****: {}", next);
            return next;
        }
    
        @Override
        public ServiceInstance instance(List<ServiceInstance> serviceInstances) {
            int index = getAndIncrement() % serviceInstances.size();
            return serviceInstances.get(index);
        }
    }
    ```

2.  å¢åŠ æ¥å£æ–¹æ³•

    ```java
    @GetMapping("/consumer/payment/lb")
    public String getPaymentLB() {
        List<ServiceInstance> instances = discoveryClient.getInstances("CLOUD-PAYMENT-SERVICE");
        // é€šè¿‡æˆ‘ä»¬è‡ªå®šä¹‰çš„è§„åˆ™æ¥è·å–å¤„ç†è¯·æ±‚çš„æœåŠ¡å®ä¾‹
        ServiceInstance serviceInstance = loadBalancer.instance(instances);
        if (instances == null || instances.size() <= 0) {
            return null;
        }
        // è·å–æœåŠ¡çš„uri
        URI uri = serviceInstance.getUri();
        return restTemplate.getForObject(uri + "/payment/lb", String.class);
    }
    ```

3.  å»æ‰`RestTemplate`ä¸­çš„`@LoadBalanced`æ³¨è§£

4.  æµ‹è¯• -> æ¯æ¬¡å‡ºç°ä¸åŒçš„ç«¯å£å·è¡¨ç¤ºæˆåŠŸ





# äº”ã€æœåŠ¡æ¥å£è°ƒç”¨

## OpenFeign

### 1ã€æ¦‚è¿°

#### 1.1 Feignæ˜¯ä»€ä¹ˆ

**å®˜ç½‘åŸè¯**ï¼š

[Feign](https://github.com/OpenFeign/feign) is a declarative web service client. It makes writing web service clients easier. To use Feign create an interface and annotate it. It has pluggable annotation support including Feign annotations and JAX-RS annotations. Feign also supports pluggable encoders and decoders. Spring Cloud adds support for Spring MVC annotations and for using the same `HttpMessageConverters` used by default in Spring Web. Spring Cloud integrates Eureka, Spring Cloud CircuitBreaker, as well as Spring Cloud LoadBalancer to provide a load-balanced http client when using Feign.

Feign æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„ Web æœåŠ¡å®¢æˆ·ç«¯ã€‚å®ƒä½¿ç¼–å†™ Web æœåŠ¡å®¢æˆ·ç«¯å˜å¾—æ›´åŠ å®¹æ˜“ã€‚**è¦ä½¿ç”¨ Feignï¼Œè¯·åˆ›å»ºä¸€ä¸ªæ¥å£å¹¶å¯¹å…¶è¿›è¡Œæ³¨é‡Š**ã€‚å®ƒå…·æœ‰å¯æ’å…¥çš„æ³¨é‡Šæ”¯æŒï¼ŒåŒ…æ‹¬ Feign æ³¨é‡Šå’Œ JAX-RS æ³¨é‡Šã€‚Feign è¿˜æ”¯æŒå¯æ’å…¥çš„ç¼–ç å™¨å’Œè§£ç å™¨ã€‚ Spring Cloud æ·»åŠ äº†å¯¹ Spring MVC æ³¨é‡Šçš„æ”¯æŒï¼Œå¹¶æ”¯æŒä½¿ç”¨åœ¨ Spring Web ä¸­é»˜è®¤ä½¿ç”¨çš„ç›¸åŒHttpMessageConvertersã€‚Spring Cloud é›†æˆäº† Eurekaï¼ŒSpring Cloud CircuitBreakerï¼Œä»¥åŠ Spring Cloud LoadBalancerï¼Œåœ¨ä½¿ç”¨ Feign æ—¶æä¾›è´Ÿè½½å‡è¡¡çš„ http å®¢æˆ·ç«¯ã€‚

é€šè¿‡è¿™æ®µè¯å¯ä»¥çœ‹å‡ºæ¥ä½¿ç”¨Feignå¯ä»¥ä½¿ç”¨è¯·æ±‚å˜å¾—æ›´åŠ æ–¹ä¾¿å’Œç®€å•ï¼Œåªéœ€è¦ä¸€ä¸ªæ¥å£å’Œé…ç½®å³å¯ã€‚



#### 1.2 Feignèƒ½åšä»€ä¹ˆï¼Ÿ

Feignä½¿ç¼–å†™Java Httpå®¢æˆ·ç«¯å˜å¾—æ›´å®¹æ˜“

åœ¨å‰é¢çš„ç« èŠ‚ä¸­æˆ‘ä»¬å­¦ä¹ äº†`Ribbon + RestTemplate`è¯·æ±‚æœåŠ¡ï¼Œåˆ©ç”¨RestTemplateå¯¹httpè¯·æ±‚çš„å°è£…å¤„ç†ï¼Œå½¢æˆäº†ä¸€å¥—æ¨¡ç‰ˆåŒ–çš„è°ƒç”¨æ–¹æ³•ã€‚ä½†æ˜¯åœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œç”±äºå¯¹æœåŠ¡çš„ä¾èµ–å¯èƒ½ä¸æ­¢ä¸€å¤„ï¼Œå¾€å¾€ä¸€ä¸ªæ¥å£ä¼šè¢«å¤šå¤„è°ƒç”¨ï¼Œæ‰€ä»¥éœ€è¦å°†è¿™äº›æ¥å£è¿›è¡Œå°è£…ï¼Œç„¶åå†è¿›è¡Œè°ƒç”¨ã€‚Feignå¸®æˆ‘ä»¬å®ç°äº†å°è£…ï¼Œå®ƒåªéœ€è¦æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ¥å£å’Œæ ‡æ³¨æ³¨è§£å°±ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆå¯¹æœåŠ¡çš„è°ƒç”¨å°è£…ã€‚

Feignå®ƒé›†æˆäº†Ribbonï¼Œæ‰€ä»¥Feignä¹Ÿå¯ä»¥åšè´Ÿè½½å‡è¡¡è°ƒç”¨ã€‚åªéœ€è¦åšä¸€äº›é…ç½®å³å¯ã€‚



#### 1.3 Feignå’ŒOpenFeignçš„åŒºåˆ«

| Feign                                                        | OpenFeign                                                    |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| Feignæ˜¯Spring Cloudç»„ä»¶ä¸­çš„ä¸€ä¸ªè½»é‡çº§RESTfulçš„HTTPæœåŠ¡å®¢æˆ·ç«¯ï¼ŒFeignå†…ç½®äº†Ribbonï¼Œç”¨æ¥åšå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Œå»è°ƒç”¨æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡ã€‚Feignçš„ä½¿ç”¨æ–¹å¼æ˜¯ï¼šä½¿ç”¨Feignçš„æ³¨è§£å®šä¹‰æ¥å£ï¼Œè°ƒç”¨è¿™ä¸ªæ¥å£ï¼Œå°±å¯ä»¥è°ƒç”¨æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡ | OpenFeignæ˜¯Spring Cloud åœ¨Feignçš„åŸºç¡€ä¸Šæ”¯æŒäº†SpringMVCçš„æ³¨è§£ï¼Œå¦‚@RequesMappingç­‰ç­‰ã€‚OpenFeignçš„@FeignClientå¯ä»¥è§£æSpringMVCçš„@RequestMappingæ³¨è§£ä¸‹çš„æ¥å£ï¼Œå¹¶é€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼äº§ç”Ÿå®ç°ç±»ï¼Œå®ç°ç±»ä¸­åšè´Ÿè½½å‡è¡¡å¹¶è°ƒç”¨å…¶ä»–æœåŠ¡ã€‚ |
| `<dependency>    <groupId>org.springframework.cloud</groupId>    <artifactId>spring-cloud-starter-feign</artifactId></dependency>` | `<dependency>    <groupId>org.springframework.cloud</groupId>    <artifactId>spring-cloud-starter-openfeign</artifactId></dependency>` |





### 2ã€ä½¿ç”¨OpenFeign

å¾®æœåŠ¡è°ƒç”¨æ¥å£+`@FeignClient`æ¥ä½¿ç”¨

1.  æ–°å»º`cloud-consumer-feign-order80`

2.  POM

    ```xml
    <dependencies>
        <!--openfeign-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <!--eureka client-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <!-- å¼•å…¥è‡ªå·±å®šä¹‰çš„apié€šç”¨åŒ…ï¼Œå¯ä»¥ä½¿ç”¨Paymentæ”¯ä»˜Entity -->
        <dependency>
            <groupId>com.atguigu</groupId>
            <artifactId>cloud-api-commons</artifactId>
            <version>${project.version}</version>
        </dependency>
        <!--web-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <!--ä¸€èˆ¬åŸºç¡€é€šç”¨é…ç½®-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    ```

3.  Yaml

    ```yaml
    server:
      port: 8002
    
    spring:
      application:
        name: cloud-order-service
    
    eureka:
      client:
        register-with-eureka: false
        service-url:
          defaultZone: http://eureka7001.com:7001/eureka/
    ```

4.  ä¸»å¯åŠ¨

    ```java
    @SpringBootApplication
    @EnableFeignClients
    public class OrderFeignMain80 {
    
        public static void main(String[] args) {
            SpringApplication.run(OrderFeignMain80.class, args);
        }
    }
    ```

5.  ä¸šåŠ¡ç±»

    æ–°å»ºä¸€ä¸ªåŒ…æ”¾æˆ‘ä»¬çš„æœåŠ¡è°ƒç”¨æ¥å£ï¼Œè¿™é‡Œä½¿ç”¨serviceåŒ…

    ```java
    package com.atguigu.springcloud.service;
    
    @Component
    // valueä¸ºæœåŠ¡å
    @FeignClient("CLOUD-PAYMENT-SERVICE")
    public interface PaymentFeignService {
    
        @GetMapping("/payment/getPaymentById")
        CommonResult getPaymentById(@RequestParam("id") Long id);
    }
    ```

    æ–°å»ºä¸€ä¸ªcontroller

    ```java
    @RestController
    @RequestMapping("order")
    public class OrderFeignController {
    
        @Resource
        private PaymentFeignService paymentFeignService;
    
        @GetMapping("/get/{id}")
        public CommonResult getPaymentById(@PathVariable("id") Long id) {
            return paymentFeignService.getPaymentById(id);
        }
    }
    ```

6.  å¯åŠ¨æœåŠ¡æµ‹è¯•

    ç”±äºOpenFeignè‡ªå¸¦Ribbonï¼Œæ‰€ä»¥å®ƒä¹Ÿæœ‰è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ã€‚

    ![image-20230213154951123](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230213154951123.png)

    ![image-20230213155017116](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230213155017116.png)





### 3ã€OpenFeignè¶…æ—¶æ§åˆ¶

é»˜è®¤æƒ…å†µä¸‹ï¼ŒOpenFeignç­‰å¾…1ç§’é’Ÿï¼Œ**å¦‚æœæœåŠ¡ç«¯å¤„ç†è¶…è¿‡1ç§’é’Ÿ**ï¼ŒFeignå®¢æˆ·ç«¯å°±ä¼šæŠ¥é”™ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹å…è®¸æœåŠ¡å¤„ç†è¶…è¿‡ä¸€ç§’é’Ÿï¼Œä¸ºäº†é¿å…æŠ¥é”™çš„æƒ…å†µå‘ç”Ÿï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®Feignå®¢æˆ·ç«¯çš„è¶…æ—¶æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è¶…æ—¶æ§åˆ¶ã€‚åœ¨ymlæ–‡ä»¶ä¸­è¿›è¡Œé…ç½®

![image-20230213160629506](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230213160629506.png)

è¿™ä¸ªæ˜¯è¶…æ—¶çš„æŠ¥é”™ã€‚

ymlæ–‡ä»¶é…ç½®è¶…æ—¶æ§åˆ¶

```yml
#è®¾ç½®feignå®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´(OpenFeigné»˜è®¤æ”¯æŒribbon)
ribbon:
  #æŒ‡çš„æ˜¯å»ºç«‹è¿æ¥æ‰€ç”¨çš„æ—¶é—´ï¼Œé€‚ç”¨äºç½‘ç»œçŠ¶å†µæ­£å¸¸çš„æƒ…å†µä¸‹,ä¸¤ç«¯è¿æ¥æ‰€ç”¨çš„æ—¶é—´
  ReadTimeout: 5000
  #æŒ‡çš„æ˜¯å»ºç«‹è¿æ¥åä»æœåŠ¡å™¨è¯»å–åˆ°å¯ç”¨èµ„æºæ‰€ç”¨çš„æ—¶é—´
  ConnectTimeout: 5000
```



### 4ã€å¼€å¯æ—¥å¿—æ‰“å°åŠŸèƒ½

Feign æä¾›äº†æ—¥å¿—æ‰“å°åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®æ¥è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼Œä»è€Œäº†è§£ Feign ä¸­ Http è¯·æ±‚çš„ç»†èŠ‚ã€‚å°±æ˜¯å¯¹Feignæ¥å£çš„è°ƒç”¨æƒ…å†µè¿›è¡Œç›‘æ§å’Œè¾“å‡º



#### 4.1 æ—¥å¿—çº§åˆ«

| çº§åˆ«    | åŠŸèƒ½                                                         |
| ------- | ------------------------------------------------------------ |
| NONE    | é»˜è®¤çš„ï¼Œä¸æ˜¾ç¤ºä»»ä½•æ—¥å¿—ï¼›                                     |
| BASIC   | ä»…è®°å½•è¯·æ±‚æ–¹æ³•ã€URLã€å“åº”çŠ¶æ€ç åŠæ‰§è¡Œæ—¶é—´ï¼›                  |
| HEADERS | é™¤äº† BASIC ä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯ï¼›        |
| FULL    | é™¤äº† HEADERS ä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„æ­£æ–‡åŠå…ƒæ•°æ®ã€‚ |



#### 4.2 é…ç½®è¾“å‡ºæ—¥å¿—çº§åˆ«

å°†æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„æ—¥å¿—çº§åˆ«æ³¨å…¥åˆ°å®¹å™¨ä¸­å³å¯

```java
@Configuration
public class FeignConfig {
    @Bean
    Logger.Level feignLoggerLevel()
    {
        return Logger.Level.FULL;
    }
}
```



#### 4.3 é…ç½®æ–‡ä»¶ä¸­è®¾ç½®éœ€è¦å¼€å¯çš„Feignå®¢æˆ·ç«¯

```yaml
logging:
  level:
  	# å¼€å¯serviceä¸‹çš„æ‰€æœ‰Feignå®¢æˆ·ç«¯çš„
    com.atguigu.springcloud.service.*: debug
```



#### 4.4 æŸ¥çœ‹æ—¥å¿—è¾“å‡ºç»“æœ

![image-20230213161648831](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230213161648831.png)





# å…­ã€æœåŠ¡é™çº§

## Hystrixï¼ˆåœæ›´ç»´æŠ¤âš ï¼‰

### 1ã€æ¦‚è¿°

#### 1.1 åˆ†å¸ƒå¼ç³»ç»Ÿé¢ä¸´çš„é—®é¢˜

å¤æ‚åˆ†å¸ƒå¼ä½“ç³»ç»“æ„ä¸­çš„åº”ç”¨ç¨‹åºæœ‰æ•°åä¸ªä¾èµ–å…³ç³»ï¼Œæ¯ä¸ªä¾èµ–å…³ç³»åœ¨æŸäº›æ—¶å€™å°†ä¸å¯é¿å…åœ°å¤±è´¥ã€‚

![image-20230213180236426](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230213180236426.png)

**æœåŠ¡é›ªå´©**

å¤šä¸ªå¾®æœåŠ¡ä¹‹é—´è°ƒç”¨çš„æ—¶å€™ï¼Œå‡è®¾å¾®æœåŠ¡Aè°ƒç”¨å¾®æœåŠ¡Bå’Œå¾®æœåŠ¡Cï¼Œå¾®æœåŠ¡Bå’Œå¾®æœåŠ¡Cåˆè°ƒç”¨å…¶å®ƒçš„å¾®æœåŠ¡ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œæ‰‡å‡ºâ€ï¼Œâ€œæ‰‡å‡ºå°±æ˜¯å‘æ‰‡å­æ‰“å¼€çš„æ—¶å€™ä¸€æ ·ä¸€ä¸ªä¸ªè¤¶å­å‘å¤–å¼ å¼€ã€‚å¦‚æœæ‰‡å‡ºçš„é“¾è·¯ä¸ŠæŸä¸ªå¾®æœåŠ¡çš„è°ƒç”¨å“åº”æ—¶é—´è¿‡é•¿æˆ–è€…ä¸å¯ç”¨ï¼Œå¯¹å¾®æœåŠ¡Açš„è°ƒç”¨å°±ä¼šå ç”¨è¶Šæ¥è¶Šå¤šçš„ç³»ç»Ÿèµ„æºï¼Œè¿›è€Œå¼•èµ·ç³»ç»Ÿå´©æºƒï¼Œæ‰€è°“çš„â€œé›ªå´©æ•ˆåº”â€.

å¯¹äºé«˜æµé‡çš„åº”ç”¨æ¥è¯´ï¼Œå•ä¸€çš„åç«¯ä¾èµ–å¯èƒ½ä¼šå¯¼è‡´æ‰€æœ‰æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰èµ„æºéƒ½åœ¨å‡ ç§’é’Ÿå†…é¥±å’Œã€‚æ¯”å¤±è´¥æ›´ç³Ÿç³•çš„æ˜¯ï¼Œè¿™äº›åº”ç”¨ç¨‹åºè¿˜å¯èƒ½å¯¼è‡´æœåŠ¡ä¹‹é—´çš„å»¶è¿Ÿå¢åŠ ï¼Œå¤‡ä»½é˜Ÿåˆ—ï¼Œçº¿ç¨‹å’Œå…¶ä»–ç³»ç»Ÿèµ„æºç´§å¼ ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå‘ç”Ÿæ›´å¤šçš„çº§è”æ•…éšœã€‚è¿™äº›éƒ½è¡¨ç¤ºéœ€è¦å¯¹æ•…éšœå’Œå»¶è¿Ÿè¿›è¡Œéš”ç¦»å’Œç®¡ç†ï¼Œä»¥ä¾¿å•ä¸ªä¾èµ–å…³ç³»çš„å¤±è´¥ï¼Œä¸èƒ½å–æ¶ˆæ•´ä¸ªåº”ç”¨ç¨‹åºæˆ–ç³»ç»Ÿã€‚
æ‰€ä»¥ï¼Œ
é€šå¸¸å½“ä½ å‘ç°ä¸€ä¸ªæ¨¡å—ä¸‹çš„æŸä¸ªå®ä¾‹å¤±è´¥åï¼Œè¿™æ—¶å€™è¿™ä¸ªæ¨¡å—ä¾ç„¶è¿˜ä¼šæ¥æ”¶æµé‡ï¼Œç„¶åè¿™ä¸ªæœ‰é—®é¢˜çš„æ¨¡å—è¿˜è°ƒç”¨äº†å…¶ä»–çš„æ¨¡å—ï¼Œè¿™æ ·å°±ä¼šå‘ç”Ÿçº§è”æ•…éšœï¼Œæˆ–è€…å«é›ªå´©ã€‚

***æ€»ç»“å°±æ˜¯***ï¼šå¾®æœåŠ¡è°ƒç”¨é“¾è·¯ä¸Šçš„ä¸€ä¸ªæœåŠ¡å‡ºç°é—®é¢˜å°±ä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡çš„è°ƒç”¨å‡ºç°é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥æ˜¯å»¶è¿Ÿæˆ–è€…æ˜¯é”™è¯¯ã€‚



#### 1.2 Hystrixæ˜¯ä»€ä¹ˆ

Hystrixæ˜¯ä¸€ä¸ªç”¨äºå¤„ç†åˆ†å¸ƒå¼ç³»ç»Ÿçš„å»¶è¿Ÿå’Œå®¹é”™çš„å¼€æºåº“ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œï¼Œè®¸å¤šä¾èµ–ä¸å¯é¿å…çš„ä¼šè°ƒç”¨å¤±è´¥ï¼Œæ¯”å¦‚è¶…æ—¶ã€å¼‚å¸¸ç­‰ï¼ŒHystrixèƒ½å¤Ÿä¿è¯åœ¨ä¸€ä¸ªä¾èµ–å‡ºé—®é¢˜çš„æƒ…å†µä¸‹ï¼Œä¸ä¼šå¯¼è‡´æ•´ä½“æœåŠ¡å¤±è´¥ï¼Œé¿å…çº§è”æ•…éšœï¼Œä»¥æé«˜åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¼¹æ€§ã€‚

â€œæ–­è·¯å™¨â€æœ¬èº«æ˜¯ä¸€ç§å¼€å…³è£…ç½®ï¼Œå½“æŸä¸ªæœåŠ¡å•å…ƒå‘ç”Ÿæ•…éšœä¹‹åï¼Œé€šè¿‡æ–­è·¯å™¨çš„æ•…éšœç›‘æ§ï¼ˆç±»ä¼¼ç†”æ–­ä¿é™©ä¸ï¼‰ï¼Œå‘è°ƒç”¨æ–¹è¿”å›ä¸€ä¸ªç¬¦åˆé¢„æœŸçš„ã€å¯å¤„ç†çš„å¤‡é€‰å“åº”ï¼ˆ**FallBack**ï¼‰ï¼Œè€Œä¸æ˜¯é•¿æ—¶é—´çš„ç­‰å¾…æˆ–è€…æŠ›å‡ºè°ƒç”¨æ–¹æ— æ³•å¤„ç†çš„å¼‚å¸¸ï¼Œè¿™æ ·å°±ä¿è¯äº†æœåŠ¡è°ƒç”¨æ–¹çš„çº¿ç¨‹ä¸ä¼šè¢«é•¿æ—¶é—´ã€ä¸å¿…è¦åœ°å ç”¨ï¼Œä»è€Œé¿å…äº†æ•…éšœåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„è”“å»¶ï¼Œä¹ƒè‡³é›ªå´©ã€‚



#### 1.3 æœ€ä¸»è¦çš„åŠŸèƒ½

***æœåŠ¡é™çº§***

åœ¨æœåŠ¡å‘ç”Ÿè¶…æ—¶æˆ–è€…å¼‚å¸¸é”™è¯¯çš„æ—¶å€™å¯¹æœåŠ¡è¿›è¡Œå¤„ç†ï¼Œè¿”å›ä¸€ä¸ªå‹å¥½çš„æç¤º(`fallback`)

ä¾‹å¦‚ï¼šè¿”å›ä¿¡æ¯ -> æœåŠ¡å™¨ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•

é‚£äº›æƒ…å†µä¼šå‘ç”Ÿé™çº§

-   ç¨‹åºè¿è¡Œå¼‚å¸¸
-   è¶…æ—¶
-   æœåŠ¡ç†”æ–­è§¦å‘æœåŠ¡é™çº§
-   çº¿ç¨‹æ± /ä¿¡å·é‡æ‰“æ»¡ä¹Ÿä¼šå¯¼è‡´æœåŠ¡é™çº§



***æœåŠ¡ç†”æ–­***

è¯·æ±‚è¾¾åˆ°æœåŠ¡èƒ½å¤„ç†çš„æœ€å¤§å€¼ï¼Œç›´æ¥æ‹’æ¥è®¿é—®ã€‚å°±åƒä¿é™©ä¸ä¸€æ ·ï¼Œç”µé‡åˆ°è¾¾æœ€å¤§å€¼å°±ä¼šè·³é—¸ã€‚



***æœåŠ¡é™æµ***

ç§’æ€ç­‰é«˜å¹¶å‘æ“ä½œã€‚ä¸èƒ½ä¸€ä¸‹å­è¯·æ±‚è¿‡æ¥ï¼Œè§„å®šä¸€ç§’èƒ½å¤„ç†çš„è¯·æ±‚ï¼Œå…¶ä»–è¯·æ±‚éœ€è¦è¿›è¡Œæ’é˜Ÿã€‚



***æœåŠ¡ç›‘æ§***

å¯¹æœåŠ¡è¿›è¡Œç›‘æ§ã€‚





### 2ã€æœåŠ¡é™çº§

#### 2.1 æ­å»ºå·¥ç¨‹

##### 2.1.1æä¾›è€…æ­å»º

1.  åˆ›å»º`cloud-provider-hystrix-payment8001`æ¨¡å—

2.  POM

    ```xml
    <dependencies>
        <!--hystrix-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-hystrix</artifactId>
        </dependency>
        <!--eureka client-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <!--web-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency><!-- å¼•å…¥è‡ªå·±å®šä¹‰çš„apié€šç”¨åŒ…ï¼Œå¯ä»¥ä½¿ç”¨Paymentæ”¯ä»˜Entity -->
            <groupId>com.atguigu.springcloud</groupId>
            <artifactId>cloud-api-commons</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    ```

3.  YAML

    ```yaml
    server:
      port: 8001
    
    spring:
      application:
        name: cloud-provider-hystrix-payment
    
    eureka:
      client:
        register-with-eureka: true
        fetch-registry: true
        service-url:
          #defaultZone: http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka
          defaultZone: http://eureka7001.com:7001/eureka
    ```

4.  ä¸»å¯åŠ¨

    ```java
    @SpringBootApplication
    @EnableEurekaClient
    public class PaymentHystrixMain8001 {
    
        public static void main(String[] args) {
            SpringApplication.run(PaymentHystrixMain8001.class, args);
        }
    }
    ```

5.  ä¸šåŠ¡ç±»

    ***service***

    ```java
    @Service
    public class PaymentService {
    
        public String paymentInfo_OK(Integer id) {
            return String.format("å½“å‰çº¿ç¨‹ï¼š%s\tpaymentInfo_OK\tid:%d\tO(âˆ©_âˆ©)Oå“ˆå“ˆ~",
                    Thread.currentThread().getName(), id);
        }
    
        public String paymentInfo_TimeOut(Integer id) {
            int number = 3;
            try {
                TimeUnit.SECONDS.sleep(3);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
            return String.format("å½“å‰çº¿ç¨‹ï¼š%s\tpaymentInfo_TimeOut\tid:%d\tO(âˆ©_âˆ©)Oå“ˆå“ˆ~ï¼Œè€—è´¹%dç§’",
                    Thread.currentThread().getName(), id, number);
        }
    }
    ```

    ***controller***

    ```java
    @Slf4j
    @RestController
    @RequestMapping("/payment")
    public class PaymentController {
    
        @Resource
        private PaymentService paymentService;
    
        @Value("${server.port}")
        private Integer serverPort;
    
        @GetMapping("/hystrix/ok/{id}")
        public String paymentInfo_OK(@PathVariable("id") Integer id) {
            String result = paymentService.paymentInfo_OK(id);
            log.info("result******ï¼š{}", result);
            return result;
        }
    
        @GetMapping("/hystrix/timeout/{id}")
        public String paymentInfo_TimeOut(@PathVariable("id") Integer id) {
            String result = paymentService.paymentInfo_TimeOut(id);
            log.info("result******ï¼š{}", result);
            return result;
        }
    }
    ```



##### 2.1.2æ¶ˆè´¹è€…å·¥ç¨‹æ­å»º

1.  åˆ›å»º``




#### 2.2 æ¨¡æ‹Ÿå¹¶å‘



##### 2.2.1 JMateré…ç½®

ä½¿ç”¨`JMater`å‘`8001`æœåŠ¡å‘èµ·20000ä¸ªè¯·æ±‚

<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214111847339.png" alt="image-20230214111847339" style="zoom: 67%;" />

<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214111955082.png" alt="image-20230214111955082" style="zoom:67%;" />



##### 2.2.2 å¹¶å‘ä¸‹çš„æ¶ˆè´¹æ¥å£

åœ¨å¹¶å‘ä¸‹è®¿é—®`http://localhost:8002/consumer/payment/hystrix/timeout/1`ï¼Œè¿™ä¸ªæ¥å£æ˜¯æ¶ˆè´¹è€…è®¿é—®æä¾›è€…

![image-20230214115816121](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214115816121.png)

ç»“æœå‘ç°æŠ¥é”™äº†æˆ–è€…æ˜¯ç­‰å¾…åŠ è½½ï¼Œè¿™ä¸ªé”™è¯¯æ˜¯Feignè°ƒç”¨çš„è¶…æ—¶é”™è¯¯ã€‚

å¾ˆæ˜æ˜¾å®¢æˆ·çœ‹ä¸æ‡‚è¿™ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬åº”è¯¥è¿”å›å‹å¥½çš„æç¤ºè€Œä¸æ˜¯é”™è¯¯ï¼Œæ‰€ä»¥éœ€è¦åšæœåŠ¡é™çº§ï¼Œåœ¨å‘ç”Ÿå¼‚å¸¸æˆ–é”™è¯¯çš„æ—¶å€™`fallback`ï¼Œ**è¿”å›ä¸€ä¸ªå…œåº•çš„æ–¹æ³•**ã€‚

>   Qï¼šæˆ‘ä»¬ä½¿ç”¨Feignçš„è¶…æ—¶æ§åˆ¶å¤„ç†ä¸å°±å¥½äº†
>
>   Aï¼šé‚£å¾—å°†Feignçš„è¶…æ—¶æ§åˆ¶è®¾ç½®å¾ˆé•¿çš„æ—¶é—´ï¼Œè¿™ä¸ªç¡®å®ä¹Ÿå¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†æ˜¯è®©å®¢æˆ·ç­‰é‚£ä¹ˆé•¿æ—¶é—´ä¸åˆé€‚ï¼Œè€Œä¸”å èµ„æºï¼Œä¼šæŠŠæœåŠ¡å™¨æ‹–å®ã€‚æƒ³è±¡ä¸€ä¸‹ä¸€ä¸ªè¯·æ±‚æ²¡è§£å†³å®Œï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚åˆè¿›æ¥äº†ï¼Œè¿™æ ·ä¸€å †ç§¯ï¼ŒæœåŠ¡å™¨èµ„æºå¾ˆå¿«å°±ä¼šç”¨å®Œã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™ä½¿ç”¨æœåŠ¡é™çº§æ˜¯æ¯”è¾ƒåˆé€‚çš„ã€‚



#### 2.3 è®¾ç½®æœåŠ¡é™çº§

å¯èƒ½å‘ç”Ÿçš„é—®é¢˜ï¼š

| é—®é¢˜                     | è§£å†³æ–¹æ¡ˆ                                                     |
| ------------------------ | ------------------------------------------------------------ |
| è¶…æ—¶å¯¼è‡´æœåŠ¡å˜æ…¢         | è¶…æ—¶ä¸å†ç­‰å¾…ï¼Œæä¾›è€…ç«¯éœ€è¦åšæœåŠ¡é™çº§ï¼Œè¶…å‡ºæŒ‡å®šæ—¶é—´å°±è¿”å›å…œåº•æ–¹æ³• |
| å‡ºé”™(å®•æœºæˆ–ç¨‹åºè¿è¡Œå‡ºé”™) | å‡ºé”™è¦æœ‰å…œåº•ï¼Œæä¾›è€…ç«¯å®•æœºæˆ–è€…å‡ºé”™ï¼Œæ¶ˆè´¹è€…ç«¯éœ€è¦æœ‰å…œåº•çš„æ–¹æ³•(fallback) |



##### 2.3.1 æä¾›è€…ç«¯é™çº§

***å¼€å¯æœåŠ¡é™çº§åŠŸèƒ½***

ä¸»å¯åŠ¨ç±»æ·»åŠ æ³¨è§£

```java
@EnableCircuitBreaker   // å¼€å¯æœåŠ¡é™çº§
```

***è®¾ç½®å¼‚å¸¸æˆ–è¶…æ—¶å¹¶è®¾ç½®æœåŠ¡é™çº§***

`localhost:8001/payment/hystrix/timeout/{id}`è¿™ä¸ªæ¥å£æ˜¯æˆ‘ä»¬æ¨¡æ‹Ÿçš„è¶…æ—¶æ¥å£ã€‚å®ƒå®é™…è°ƒç”¨è¿”å›çš„æ˜¯`PaymentService#paymentInfo_TimeOut`æ–¹æ³•

ä¿®æ”¹`paymentInfo_TimeOut`æ–¹æ³•ï¼šè®¾ç½®è¶…æ—¶æˆ–è€…å¼‚å¸¸

```java
// å¼€å¯æœåŠ¡é™çº§ -> å¤„ç†è¶…è¿‡3ç§’å°±fallbackï¼Œæ‰§è¡Œå…œåº•æ–¹æ³• paymentInfo_TimeOutHandler è¿”å›
@HystrixCommand(fallbackMethod = "paymentInfo_TimeOutHandler", commandProperties = {
        @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds",value = "3000")
})
public String paymentInfo_TimeOut(Integer id) {
    // åˆ¶é€ å¼‚å¸¸
    // int = 10 / 0;
    int number = 5;
    // åˆ¶é€ è¶…æ—¶
    try { TimeUnit.SECONDS.sleep(3); } catch (InterruptedException e) { throw new RuntimeException(e);}
    return String.format("å½“å‰çº¿ç¨‹ï¼š%s\tpaymentInfo_TimeOut\tid:%d\tO(âˆ©_âˆ©)Oå“ˆå“ˆ~ï¼Œè€—è´¹%dç§’",
            Thread.currentThread().getName(), id, number);
}

public String paymentInfo_TimeOutHandler(Integer id) {
    return "/(ã„’oã„’)/è°ƒç”¨æ”¯ä»˜æ¥å£è¶…æ—¶æˆ–å¼‚å¸¸ï¼š\t"+ "\tå½“å‰çº¿ç¨‹æ± åå­—" + Thread.currentThread().getName();
}
```

è¯´æ˜ï¼šæ­¤æ—¶å¼€å¯äº†æœåŠ¡é™çº§ã€‚å½“æ–¹æ³•å¤„ç†è¶…è¿‡3ç§’æˆ–è€…å‘ç”Ÿé”™è¯¯å°±è¿”å›å…œåº•æ–¹æ³•ã€‚

***æµ‹è¯•***

æä¾›è€…ç«¯ï¼šè®¿é—®`http://localhost:8001/payment/hystrix/timeout/1`ï¼Œè¿”å›çš„æ˜¯å…œåº•æ–¹æ³•

![image-20230214142611023](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214142611023.png)

æ¶ˆè´¹è€…ç«¯ï¼šè®¿é—®`http://localhost:8002/consumer/payment/hystrix/timeout/1`,è¿”å›çš„æ˜¯é”™è¯¯ä¿¡æ¯

![image-20230214142824832](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214142824832.png)

Feignè°ƒç”¨è¶…æ—¶å¼‚å¸¸ï¼Œè¿™æ˜¯å› ä¸ºæä¾›è€…ç«¯åšäº†æœåŠ¡é™çº§ï¼Œä½†æ˜¯æ¶ˆè´¹è€…ç«¯æ²¡æœ‰åšæœåŠ¡é™çº§ï¼Œæ‰€ä»¥æä¾›è€…ç«¯å‘ç”Ÿå¼‚å¸¸æˆ–è¶…æ—¶ï¼Œæ¶ˆè´¹ç«¯è¿˜æ˜¯ä¼šæŠ¥é”™çš„ã€‚æ‰€ä»¥éœ€è¦åœ¨ä¸¤ä¸ªç«¯éƒ½è¦è¿›è¡ŒæœåŠ¡é™çº§æ‰èƒ½ä¿è¯æœåŠ¡æ­£å¸¸è¿”å›ã€‚



##### 2.3.2 æ¶ˆè´¹è€…ç«¯é™çº§

***å¼€å¯æœåŠ¡é™çº§***

1.  ä¸»å¯åŠ¨ç±»æ·»åŠ æ³¨è§£

    ```java
    @EnableHystrix
    ```

2.  ä¿®æ”¹ymlæ–‡ä»¶

    ```yaml
    # ç”¨äºæœåŠ¡é™çº§ åœ¨æ³¨è§£@FeignClientä¸­æ·»åŠ fallbackFactoryå±æ€§å€¼
    feign:
      hystrix:
        # å¼€å¯hystrix
        enabled: true
    ```

***è®¾ç½®æœåŠ¡é™çº§***

```java
// è®¾ç½®æœåŠ¡é™çº§ -> å¤„ç†æ—¶é—´è¶…è¿‡2ç§’å°±fallback
@HystrixCommand(fallbackMethod = "paymentTimeOutFallbackMethod", commandProperties = {
        @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds",value="2000")
})
@GetMapping("/payment/hystrix/timeout/{id}")
public String paymentInfoTimeOut(@PathVariable("id") Integer id) {
    return paymentHystrixService.paymentInfo_TimeOut(id);
}

public String paymentTimeOutFallbackMethod(@PathVariable("id") Integer id)
{
    return "æˆ‘æ˜¯æ¶ˆè´¹è€…80,å¯¹æ–¹æ”¯ä»˜ç³»ç»Ÿç¹å¿™è¯·10ç§’é’Ÿåå†è¯•æˆ–è€…è‡ªå·±è¿è¡Œå‡ºé”™è¯·æ£€æŸ¥è‡ªå·±,o(â•¥ï¹â•¥)o";
}
```

***æµ‹è¯•***

æ­¤æ—¶è®¿é—®`http://localhost:8002/consumer/payment/hystrix/timeout/1`å°±ä¸ä¼šæœ‰é”™è¯¯ä¿¡æ¯ï¼Œè€Œæ˜¯fallback

![image-20230214143825300](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214143825300.png)



#### 2.4 ä»£ç è€¦åˆé—®é¢˜

##### 2.4.1 è€¦åˆé—®é¢˜

è§‚å¯Ÿæˆ‘ä»¬çš„ä»£ç å‘ç°ï¼Œä¸šåŠ¡ä»£ç å’ŒæœåŠ¡é™çº§çš„ä»£ç è€¦åˆäº†

![image-20230214144356338](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214144356338.png)

å¦‚æœæ¯ä¸€ä¸ªä¸šåŠ¡æ–¹æ³•éƒ½è¦æœ‰ä¸€ä¸ªå…œåº•æ–¹æ³•çš„è¯ï¼Œä»£ç å°±ä¼šå¾ˆæ··ä¹±ï¼Œä¹Ÿä¸ç¬¦åˆæˆ‘ä»¬é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œæ‰€ä»¥è¿™äº›å’Œä¸šåŠ¡æ— å…³çš„ä»£ç æˆ‘ä»¬åº”è¯¥ç»™å®ƒè§£è€¦ã€‚



##### 2.4.2 è®¾ç½®å…¨å±€fallbackæ–¹æ³•

è®¾ç½®ä¸€ä¸ªå…¨å±€fallbackæ–¹æ³•ï¼Œæ‰€ä»¥æœåŠ¡é™çº§çš„æ–¹æ³•éƒ½è¿”å›å…¨å±€çš„ï¼Œä¸ªåˆ«éœ€è¦å®šåˆ¶çš„å°±è‡ªå·±è®¾ç½®è‡ªå·±çš„fallbackæ–¹æ³•ã€‚

ç±»ä¸Šæ ‡æ³¨æ³¨è§£å¹¶è®¾ç½®fallbackæ–¹æ³•

```java
@DefaultProperties(defaultFallback = "paymentGlobalFallbackMethod")
public class OrderHystirxController {
    
    public String paymentGlobalFallbackMethod() {
        return "Global 444 å¯¹æ–¹ç³»ç»Ÿç¹å¿™æˆ–å®•æœºäº†ï¼Œè¯·ç¨åé‡è¯•ï¼ŒO(âˆ©_âˆ©)Oå“ˆå“ˆ~~~";
    }
```

æ‰€æœ‰æœåŠ¡ç†”æ–­æ–¹æ³•éƒ½ä¿®æ”¹æˆé»˜è®¤çš„ï¼Œä¸ªåˆ«éœ€è¦å®šåˆ¶çš„å°±ä¸éœ€è¦ä¿®æ”¹ã€‚

```java
@HystrixCommand(commandProperties = {
        @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value="2000")
})
@GetMapping("/payment/hystrix/timeout/{id}")
public String paymentInfoTimeOut(@PathVariable("id") Integer id) {
    return paymentHystrixService.paymentInfo_TimeOut(id);
}
```



***æµ‹è¯•***

è®¿é—®`http://localhost:8002/consumer/payment/hystrix/timeout/1`

![image-20230214145620146](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214145620146.png)

æˆåŠŸï¼Œnice~~~



##### 2.4.3 ç»Ÿä¸€ç®¡ç†fallbackæ–¹æ³•

>   Qï¼šæˆ‘æƒ³æ¯ä¸€ä¸ªéƒ½æœ‰ä¸“å±çš„fallbackæ–¹æ³•å¯ä¸å¯ä»¥
>
>   Aï¼šå½“ç„¶å¯ä»¥

åˆ›å»ºä¸€ä¸ªç±»å®ç°æœåŠ¡è°ƒç”¨æ¥å£ï¼Œåœ¨é‡å†™çš„æ–¹æ³•ä¸­å†™æˆ‘ä»¬çš„å…œåº•æ–¹æ³•ï¼Œå¯¹åº”è°ƒç”¨çš„æ¥å£æ–¹æ³•å‘ç”Ÿè¶…æ—¶æˆ–è€…å¼‚å¸¸å°±ä¼šè°ƒç”¨å®ç°ç±»ä¸­å¯¹åº”æ–¹æ³•ä½œä¸ºå…œåº•æ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬çš„æ¯ä¸€ä¸ªè°ƒç”¨éƒ½å¯ä»¥å®šåˆ¶è‡ªå·±çš„fallbackæ–¹æ³•

```java
@Component
public class PaymentFallbackService implements PaymentHystrixService{

    @Override
    public String paymentInfo_OK(Integer id) {
        return "æœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œæç¤ºæ¥è‡ªï¼š" +
                "cloud-consumer-feign-order8002#paymentInfo_OK";
    }

    @Override
    public String paymentInfo_TimeOut(Integer id) {
        return "æœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œæç¤ºæ¥è‡ªï¼š" +
                "cloud-consumer-feign-order8002#paymentInfo_TimeOut";
    }
}
```

==æ³¨æ„ï¼šä¸€å®šè¦å°†å®ƒæ³¨å…¥åˆ°å®¹å™¨ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸€å®šè¦åŠ `@component`æ³¨è§£==

åœ¨æœåŠ¡è°ƒç”¨æ¥å£ä¸­å£°æ˜fallbackæ–¹æ³•æ‰€åœ¨çš„å®ç°ç±»

```java
@FeignClient(value = "CLOUD-PROVIDER-HYSTRIX-PAYMENT",fallback = PaymentFallbackService.class)
public interface PaymentHystrixService {
```

è¿™ä¸ªæ—¶å€™é»˜è®¤çš„fallbackå°±ä¸èƒ½ç”¨äº†ï¼Œå› ä¸ºæ¯ä¸ªéƒ½æœ‰ä¸“å±çš„fallbackæ–¹æ³•äº†ã€‚





### 3ã€æœåŠ¡ç†”æ–­

#### 3.1 ç†”æ–­æœºåˆ¶æ¦‚è¿°

ç†”æ–­æœºåˆ¶æ˜¯åº”å¯¹é›ªå´©æ•ˆåº”çš„å¾®æœåŠ¡é“¾è·¯ä¿æŠ¤æœºåˆ¶ã€‚å½“æ‰‡å‡ºé“¾è·¯çš„æŸä¸ªå¾®æœåŠ¡å‡ºé”™ä¸å¯ç”¨æˆ–è€…å“åº”æ—¶é—´è¿‡é•¿æ—¶ï¼Œä¼šå¯¹æœåŠ¡é™çº§ï¼Œå½“å¤±è´¥çš„æ¬¡æ•°æˆ–å¤±è´¥ç‡è¾¾åˆ°æŒ‡å®šå€¼å°±ä¼šè§¦å‘ç†”æ–­æœºåˆ¶ï¼Œç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œå‡å°‘å“åº”æ—¶é—´ã€‚å½“æ£€æµ‹è¯¥èŠ‚ç‚¹æœåŠ¡è°ƒç”¨å“åº”æ­£å¸¸åï¼Œå°±ä¼šæ¢å¤é“¾è·¯è°ƒç”¨ã€‚

åœ¨SpringCloudæ¡†æ¶ä¸­ï¼Œç†”æ–­æœºåˆ¶é€šè¿‡Hystrixå®ç°ã€‚Hystrixä¼šç›‘æ§å¾®æœåŠ¡çš„è°ƒç”¨çŠ¶å†µã€‚å½“å¤±è´¥çš„è°ƒç”¨è¾¾åˆ°ä¸€å®šçš„é˜ˆå€¼ï¼Œç¼ºçœæ˜¯5ç§’å†…20æ¬¡è°ƒç”¨å¤±è´¥ï¼Œå°±ä¼šå¯åŠ¨ç†”æ–­æœºåˆ¶ã€‚

>   å¤§ç¥è®ºæ–‡ï¼šhttps://martinfowler.com/bliki/CircuitBreaker.html
>
>   è¿™ç¯‡è®ºæ–‡è¯´çš„å¾ˆè¯¦ç»†

æ–­è·¯å™¨è´Ÿè´£å¼€å¯å’Œå…³é—­ç†”æ–­



#### 3.2 ä½¿ç”¨æœåŠ¡ç†”æ–­

ç†”æ–­æœºåˆ¶çš„æ³¨è§£æ˜¯`@HistrixCommand`



**ä¿®æ”¹`cloud-provider-hystrix-payment8001`å·¥ç¨‹**

-   æ·»åŠ serviceå¹¶è®¾ç½®ç†”æ–­

    ```java
    @HystrixCommand(fallbackMethod = "paymentCircuitBreaker_fallback",commandProperties = {
        	// å¼€å¯æœåŠ¡ç†”æ–­
            @HystrixProperty(name = "circuitBreaker.enabled",value = "true"),
        	// æ»šåŠ¨æ—¶é—´çª—å£æœŸå†…å¤±è´¥10æ¬¡å¼€å¯ç†”æ–­
            @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold",value = "10"),
        	// æ»šåŠ¨æ—¶é—´çª—å£æœŸï¼Œè¯¥æ—¶é—´ç”¨äºæ–­è·¯å™¨åˆ¤æ–­å¥åº·åº¦æ—¶éœ€è¦æ”¶é›†ä¿¡æ¯çš„æŒç»­æ—¶é—´
            @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds",value = "10000"),
        	// æ»šåŠ¨æ—¶é—´çª—å£æœŸå†…ï¼Œé”™è¯¯è¯·æ±‚æ•°ç™¾åˆ†æ¯”è¶…è¿‡äº†60å°±æ‰“å¼€ç†”æ–­
            @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage",value = "60"),
    })
    public String paymentCircuitBreaker(@PathVariable("id") Integer id)
    {
        if(id < 0)
        {
            throw new RuntimeException("******id ä¸èƒ½è´Ÿæ•°");
        }
        String serialNumber = IdUtil.simpleUUID();
    
        return Thread.currentThread().getName()+"\t"+"è°ƒç”¨æˆåŠŸï¼Œæµæ°´å·: " + serialNumber;
    }
    public String paymentCircuitBreaker_fallback(@PathVariable("id") Integer id)
    {
        return "id ä¸èƒ½è´Ÿæ•°ï¼Œè¯·ç¨åå†è¯•ï¼Œ/(ã„’oã„’)/~~   id: " +id;
    }
    ```

    ***è¯´æ˜***ï¼š@HystrixCommandå±æ€§çš„æ„æ€æ˜¯å¼€å¯ç†”æ–­æœºåˆ¶ï¼Œåœ¨10ç§’å†…è¶…è¿‡6æ¬¡å¤±è´¥å°±å¼€å¯æ–­è·¯å™¨

-   æ·»åŠ controller

    ```java
    @GetMapping("/circuit/{id}")
    public String paymentCircuitBreaker(@PathVariable("id") Integer id)
    {
        String result = paymentService.paymentCircuitBreaker(id);
        log.info("****result: "+result);
        return result;
    }
    ```



**æµ‹è¯•**

é¦–å…ˆå…ˆä¸æ–­è®¿é—®`http://localhost:8001/payment/circuit/-1`ï¼Œå¤šæ¬¡è®¿é—®åå†è®¿é—®`http://localhost:8001/payment/circuit/1`ï¼Œæ­¤æ—¶å°±æ˜¯è¿”å›çš„æ˜¯fallbackæ–¹æ³•ï¼Œè€Œä¸æ˜¯ä¸šåŠ¡æ–¹æ³•

![image-20230214181312840](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214181312840.png)

ç­‰å¾…ä¸€æ®µæ—¶é—´å†æ¬¡è®¿é—®åˆæ¢å¤äº†æ­£å¸¸ã€‚

![image-20230214181337314](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214181337314.png)



#### 3.3 åŸç†

##### 3.3.1 å¤§ç¥è®ºæ–‡

>   å¤§ç¥è®ºæ–‡[https://martinfowler.com/bliki/CircuitBreaker.html]ä¸­æœ‰è¯´æ˜æ–­è·¯å™¨çš„æœºåˆ¶

![image-20230214181615815](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214181615815.png)

**è¯´æ˜**ï¼šæ„æ€å°±æ˜¯å½“æœåŠ¡è°ƒç”¨çš„å¤±è´¥æ¬¡æ•°è¾¾åˆ°ä¸€å®šé˜ˆå€¼å°±ä¼šæ‰“å¼€æ–­è·¯å™¨ï¼Œè¿‡ä¸€æ®µæ—¶é—´åå°±ä¼šä»¥åŠå¼€çš„çŠ¶æ€æ¥æ‰“å¼€æ–­è·¯å™¨ã€‚ï¼Œå¦‚æœè°ƒç”¨æˆåŠŸåˆ™å°†é‡ç½®æ–­è·¯å™¨ï¼Œå¦åˆ™å°†é‡æ–°å¯åŠ¨æ–­è·¯å™¨ã€‚



##### 3.3.2 ç†”æ–­ç±»å‹

-   ç†”æ–­æ‰“å¼€

    è¯·æ±‚ä¸å†è¿›è¡Œè°ƒç”¨å½“å‰æœåŠ¡ï¼Œå†…éƒ¨è®¾ç½®æ—¶é’Ÿä¸€èˆ¬ä¸ºMTTRï¼ˆå¹³å‡æ•…éšœå¤„ç†æ—¶é—´)ï¼Œå½“æ‰“å¼€æ—¶é•¿è¾¾åˆ°æ‰€è®¾æ—¶é’Ÿåˆ™è¿›å…¥åŠç†”æ–­çŠ¶æ€

-   ç†”æ–­å…³é—­

    ç†”æ–­å…³é—­ä¸ä¼šå¯¹æœåŠ¡è¿›è¡Œç†”æ–­

-   ç†”æ–­åŠå¼€

    éƒ¨åˆ†è¯·æ±‚æ ¹æ®è§„åˆ™è°ƒç”¨å½“å‰æœåŠ¡ï¼Œå¦‚æœè¯·æ±‚æˆåŠŸä¸”ç¬¦åˆè§„åˆ™åˆ™è®¤ä¸ºå½“å‰æœåŠ¡æ¢å¤æ­£å¸¸ï¼Œå…³é—­ç†”æ–­



##### 3.3.3 ç†”æ–­å™¨æ‰§è¡Œæ­¥éª¤

å®˜ç½‘åŸæ–‡ï¼š

![image-20230214182658468](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214182658468.png)

Hystrix å®ç°æœåŠ¡ç†”æ–­çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1.  å½“æœåŠ¡çš„è°ƒç”¨å‡ºé”™ç‡è¾¾åˆ°æˆ–è¶…è¿‡ Hystix è§„å®šçš„æ¯”ç‡ï¼ˆé»˜è®¤ä¸º 50%ï¼‰åï¼Œç†”æ–­å™¨è¿›å…¥ç†”æ–­å¼€å¯çŠ¶æ€ã€‚
2.  ç†”æ–­å™¨è¿›å…¥ç†”æ–­å¼€å¯çŠ¶æ€åï¼ŒHystrix ä¼šå¯åŠ¨ä¸€ä¸ªä¼‘çœ æ—¶é—´çª—ï¼Œåœ¨è¿™ä¸ªæ—¶é—´çª—å†…ï¼Œè¯¥æœåŠ¡çš„é™çº§é€»è¾‘ï¼ˆfallbackæ–¹æ³•ï¼‰ä¼šä¸´æ—¶å……å½“ä¸šåŠ¡ä¸»é€»è¾‘ï¼Œè€ŒåŸæ¥çš„ä¸šåŠ¡ä¸»é€»è¾‘ä¸å¯ç”¨ã€‚
3.  å½“æœ‰è¯·æ±‚å†æ¬¡è°ƒç”¨è¯¥æœåŠ¡æ—¶ï¼Œä¼šç›´æ¥è°ƒç”¨é™çº§é€»è¾‘ï¼ˆfallbackæ–¹æ³•ï¼‰å¿«é€Ÿåœ°è¿”å›å¤±è´¥å“åº”ï¼Œä»¥é¿å…ç³»ç»Ÿé›ªå´©ã€‚
4.  å½“ä¼‘çœ æ—¶é—´çª—åˆ°æœŸåï¼ŒHystrix ä¼šè¿›å…¥åŠç†”æ–­è½¬æ€ï¼Œå…è®¸éƒ¨åˆ†è¯·æ±‚å¯¹æœåŠ¡åŸæ¥çš„ä¸»ä¸šåŠ¡é€»è¾‘è¿›è¡Œè°ƒç”¨ï¼Œå¹¶ç›‘æ§å…¶è°ƒç”¨æˆåŠŸç‡ã€‚
5.  å¦‚æœè°ƒç”¨æˆåŠŸç‡è¾¾åˆ°é¢„æœŸï¼Œåˆ™è¯´æ˜æœåŠ¡å·²æ¢å¤æ­£å¸¸ï¼ŒHystrix è¿›å…¥ç†”æ–­å…³é—­çŠ¶æ€ï¼ŒæœåŠ¡åŸæ¥çš„ä¸»ä¸šåŠ¡é€»è¾‘æ¢å¤ï¼›å¦åˆ™ Hystrix é‡æ–°è¿›å…¥ç†”æ–­å¼€å¯çŠ¶æ€ï¼Œä¼‘çœ æ—¶é—´çª—å£é‡æ–°è®¡æ—¶ï¼Œç»§ç»­é‡å¤ç¬¬ 2 åˆ°ç¬¬ 5 æ­¥ã€‚



#### 3.4 å±æ€§å€¼åŠå…¶ä½œç”¨

åœ¨`HystrixCommandProperties`ç±»ä¸­å¯ä»¥æ‰¾åˆ°æ‰€æœ‰çš„å±æ€§

| å±æ€§å€¼                                              | ä½œç”¨                                                         |
| --------------------------------------------------- | ------------------------------------------------------------ |
| execution.isolation.strategy                        | è®¾ç½®éš”ç¦»ç­–ç•¥ï¼ŒTHREAD è¡¨ç¤ºçº¿ç¨‹æ±  SEMAPHOREï¼šä¿¡å·æ± éš”ç¦»        |
| execution.isolation.semaphore.maxConcurrentRequests | å½“éš”ç¦»ç­–ç•¥é€‰æ‹©ä¿¡å·æ± éš”ç¦»çš„æ—¶å€™ï¼Œç”¨æ¥è®¾ç½®ä¿¡å·æ± çš„å¤§å°ï¼ˆæœ€å¤§å¹¶å‘æ•°ï¼‰ |
| execution.isolation.thread.timeoutinMilliseconds    | é…ç½®å‘½ä»¤æ‰§è¡Œçš„è¶…æ—¶æ—¶é—´                                       |
| execution.timeout.enabled                           | æ˜¯å¦å¯ç”¨è¶…æ—¶æ—¶é—´                                             |
| execution.isolation.thread.interruptOnTimeout       | æ‰§è¡Œè¶…æ—¶çš„æ—¶å€™æ˜¯å¦ä¸­æ–­                                       |
| execution.isolation.thread.interruptOnCancel        | æ‰§è¡Œè¢«å–æ¶ˆçš„æ—¶å€™æ˜¯å¦ä¸­æ–­                                     |
| fallback.isolation.semaphore.maxConcurrentRequests  | å…è®¸å›è°ƒæ–¹æ³•æ‰§è¡Œçš„æœ€å¤§å¹¶å‘æ•°                                 |
| fallback.enabled                                    | æœåŠ¡é™çº§æ˜¯å¦å¯ç”¨ï¼Œæ˜¯å¦æ‰§è¡Œå›è°ƒå‡½æ•°                           |
| circuitBreaker.enabled                              | æ˜¯å¦å¯ç”¨æ–­è·¯å™¨                                               |
| circuitBreaker.requestVolumeThreshold               | è¯¥å±æ€§ç”¨æ¥è®¾ç½®åœ¨æ»šåŠ¨æ—¶é—´çª—ä¸­ï¼Œæ–­è·¯å™¨ç†”æ–­çš„æœ€å°è¯·æ±‚æ•°ã€‚ä¾‹å¦‚ï¼Œé»˜è®¤è¯¥å€¼ä¸º 20 çš„æ—¶å€™ï¼Œå¦‚æœæ»šåŠ¨æ—¶é—´çª—ï¼ˆé»˜è®¤10ç§’ï¼‰å†…ä»…æ”¶åˆ°äº†19ä¸ªè¯·æ±‚ï¼Œ å³ä½¿è¿™19ä¸ªè¯·æ±‚éƒ½å¤±è´¥äº†ï¼Œæ–­è·¯å™¨ä¹Ÿä¸ä¼šæ‰“å¼€ã€‚ |
| circuitBreaker.errorThresholdPercentage             | è¯¥å±æ€§ç”¨æ¥è®¾ç½®åœ¨æ»šåŠ¨æ—¶é—´çª—ä¸­ï¼Œè¡¨ç¤ºåœ¨æ»šåŠ¨æ—¶é—´çª—ä¸­ï¼Œåœ¨è¯·æ±‚æ•°é‡è¶…è¿‡ï¼ŒcircuitBreaker.requestVolumeThreshold çš„æƒ…å†µä¸‹ï¼Œå¦‚æœé”™è¯¯è¯·æ±‚æ•°çš„ç™¾åˆ†æ¯”è¶…è¿‡50,å°±æŠŠæ–­è·¯å™¨è®¾ç½®ä¸º "æ‰“å¼€" çŠ¶æ€ï¼Œå¦åˆ™å°±è®¾ç½®ä¸º "å…³é—­" çŠ¶æ€ã€‚ |
| circuitBreaker.sleepWindowinMilliseconds            | // è¯¥å±æ€§ç”¨æ¥è®¾ç½®å½“æ–­è·¯å™¨æ‰“å¼€ä¹‹åçš„ä¼‘çœ æ—¶é—´çª—ã€‚ ä¼‘çœ æ—¶é—´çª—ç»“æŸä¹‹åï¼Œä¼šå°†æ–­è·¯å™¨ç½®ä¸º "åŠå¼€" çŠ¶æ€ï¼Œå°è¯•ç†”æ–­çš„è¯·æ±‚å‘½ä»¤ï¼Œå¦‚æœä¾ç„¶å¤±è´¥å°±å°†æ–­è·¯å™¨ç»§ç»­è®¾ç½®ä¸º "æ‰“å¼€" çŠ¶æ€ï¼Œå¦‚æœæˆåŠŸå°±è®¾ç½®ä¸º "å…³é—­" çŠ¶æ€ã€‚ |
| ircuitBreaker.forceOpen                             | æ–­è·¯å™¨å¼ºåˆ¶æ‰“å¼€                                               |
| circuitBreaker.forceClosed                          | æ–­è·¯å™¨å¼ºåˆ¶å…³é—­                                               |
| metrics.rollingStats.timeinMilliseconds             | æ»šåŠ¨æ—¶é—´çª—è®¾ç½®ï¼Œè¯¥æ—¶é—´ç”¨äºæ–­è·¯å™¨åˆ¤æ–­å¥åº·åº¦æ—¶éœ€è¦æ”¶é›†ä¿¡æ¯çš„æŒç»­æ—¶é—´ |
| metrics.rollingStats.numBuckets                     | è¯¥å±æ€§ç”¨æ¥è®¾ç½®æ»šåŠ¨æ—¶é—´çª—ç»Ÿè®¡æŒ‡æ ‡ä¿¡æ¯æ—¶åˆ’åˆ†"æ¡¶"çš„æ•°é‡ï¼Œæ–­è·¯å™¨åœ¨æ”¶é›†æŒ‡æ ‡ä¿¡æ¯çš„æ—¶å€™ä¼šæ ¹æ®è®¾ç½®çš„æ—¶é—´çª—é•¿åº¦æ‹†åˆ†æˆå¤šä¸ª "æ¡¶" æ¥ç´¯è®¡å„åº¦é‡å€¼ï¼Œæ¯ä¸ª"æ¡¶"è®°å½•äº†ä¸€æ®µæ—¶é—´å†…çš„é‡‡é›†æŒ‡æ ‡ã€‚æ¯”å¦‚ 10 ç§’å†…æ‹†åˆ†æˆ 10 ä¸ª"æ¡¶"æ”¶é›†è¿™æ ·ï¼Œæ‰€ä»¥ timeinMilliseconds å¿…é¡»èƒ½è¢« numBuckets æ•´é™¤ã€‚å¦åˆ™ä¼šæŠ›å¼‚å¸¸ |
| metrics.rollingPercentile.enabled                   | è¯¥å±æ€§ç”¨æ¥è®¾ç½®å¯¹å‘½ä»¤æ‰§è¡Œçš„å»¶è¿Ÿæ˜¯å¦ä½¿ç”¨ç™¾åˆ†ä½æ•°æ¥è·Ÿè¸ªå’Œè®¡ç®—ã€‚å¦‚æœè®¾ç½®ä¸º false, é‚£ä¹ˆæ‰€æœ‰çš„æ¦‚è¦ç»Ÿè®¡éƒ½å°†è¿”å› -1 |
| metrics.rollingPercentile.timeInMilliseconds        | è¯¥å±æ€§ç”¨æ¥è®¾ç½®ç™¾åˆ†ä½ç»Ÿè®¡çš„æ»šåŠ¨çª—å£çš„æŒç»­æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’     |
| metrics.rollingPercentile.numBuckets                | è¯¥å±æ€§ç”¨æ¥è®¾ç½®ç™¾åˆ†ä½ç»Ÿè®¡æ»šåŠ¨çª—å£ä¸­ä½¿ç”¨ â€œ æ¡¶ â€çš„æ•°é‡ã€‚        |
| metrics.rollingPercentile.bucketSize                | è¯¥å±æ€§ç”¨æ¥è®¾ç½®åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ¯ä¸ª â€œæ¡¶â€ ä¸­ä¿ç•™çš„æœ€å¤§æ‰§è¡Œæ¬¡æ•°ã€‚å¦‚æœåœ¨æ»šåŠ¨æ—¶é—´çª—å†…å‘ç”Ÿè¶…è¿‡è¯¥è®¾å®šå€¼çš„æ‰§è¡Œæ¬¡æ•°ï¼Œå°±ä»æœ€åˆçš„ä½ç½®å¼€å§‹é‡å†™ã€‚ä¾‹å¦‚ï¼Œå°†è¯¥å€¼è®¾ç½®ä¸º100, æ»šåŠ¨çª—å£ä¸º10ç§’ï¼Œè‹¥åœ¨10ç§’å†…ä¸€ä¸ª â€œæ¡¶ â€ä¸­å‘ç”Ÿäº†500æ¬¡æ‰§è¡Œï¼Œé‚£ä¹ˆè¯¥ â€œæ¡¶â€ ä¸­åªä¿ç•™ æœ€åçš„100æ¬¡æ‰§è¡Œçš„ç»Ÿè®¡ã€‚å¦å¤–ï¼Œå¢åŠ è¯¥å€¼çš„å¤§å°å°†ä¼šå¢åŠ å†…å­˜é‡çš„æ¶ˆè€—ï¼Œå¹¶å¢åŠ æ’åºç™¾åˆ†ä½æ•°æ‰€éœ€çš„è®¡ç®—æ—¶é—´ã€‚ |
| metrics.healthSnapshot.intervalinMilliseconds       | è¯¥å±æ€§ç”¨æ¥è®¾ç½®é‡‡é›†å½±å“æ–­è·¯å™¨çŠ¶æ€çš„å¥åº·å¿«ç…§ï¼ˆè¯·æ±‚çš„æˆåŠŸã€ é”™è¯¯ç™¾åˆ†æ¯”ï¼‰çš„é—´éš”ç­‰å¾…æ—¶é—´ã€‚ |
| requestCache.enabled                                | æ˜¯å¦å¼€å¯è¯·æ±‚ç¼“å­˜                                             |
| requestLog.enabled                                  | HystrixCommandçš„æ‰§è¡Œå’Œäº‹ä»¶æ˜¯å¦æ‰“å°æ—¥å¿—åˆ° HystrixRequestLog ä¸­ |
| coreSize                                            | è¯¥å‚æ•°ç”¨æ¥è®¾ç½®æ‰§è¡Œå‘½ä»¤çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œè¯¥å€¼ä¹Ÿå°±æ˜¯å‘½ä»¤æ‰§è¡Œçš„æœ€å¤§å¹¶å‘é‡ |
| maxQueueSize                                        | è¯¥å‚æ•°ç”¨æ¥è®¾ç½®çº¿ç¨‹æ± çš„æœ€å¤§é˜Ÿåˆ—å¤§å°ã€‚å½“è®¾ç½®ä¸º -1 æ—¶ï¼Œçº¿ç¨‹æ± å°†ä½¿ç”¨ SynchronousQueue å®ç°çš„é˜Ÿåˆ—ï¼Œå¦åˆ™å°†ä½¿ç”¨ LinkedBlockingQueue å®ç°çš„é˜Ÿåˆ—ã€‚ |
| queueSizeRejectionThreshold                         | è¯¥å‚æ•°ç”¨æ¥ä¸ºé˜Ÿåˆ—è®¾ç½®æ‹’ç»é˜ˆå€¼ã€‚ é€šè¿‡è¯¥å‚æ•°ï¼Œ å³ä½¿é˜Ÿåˆ—æ²¡æœ‰è¾¾åˆ°æœ€å¤§å€¼ä¹Ÿèƒ½æ‹’ç»è¯·æ±‚ã€‚è¯¥å‚æ•°ä¸»è¦æ˜¯å¯¹ LinkedBlockingQueue é˜Ÿåˆ—çš„è¡¥å……,å› ä¸ºLinkedBlockingQueueé˜Ÿåˆ—ä¸èƒ½åŠ¨æ€ä¿®æ”¹å®ƒçš„å¯¹è±¡å¤§å°ï¼Œè€Œé€šè¿‡è¯¥å±æ€§å°±å¯ä»¥è°ƒæ•´æ‹’ç»è¯·æ±‚çš„é˜Ÿåˆ—å¤§å°äº†ã€‚ |
|                                                     |                                                              |





### 4ã€æœåŠ¡é™æµ

åœ¨Spring Cloud Alibaba ä¸­è®²è§£



### 5ã€æœåŠ¡ç›‘æ§hystrixDashboard

#### 5.1 æ¦‚è¿°

é™¤äº†éš”ç¦»ä¾èµ–æœåŠ¡çš„è°ƒç”¨ä»¥å¤–ï¼ŒHystrixè¿˜æä¾›äº†å‡†å®æ—¶çš„è°ƒç”¨ç›‘æ§ï¼ˆHystrix Dashboardï¼‰ï¼ŒHystrixä¼šæŒç»­åœ°è®°å½•æ‰€æœ‰é€šè¿‡Hystrixå‘èµ·çš„è¯·æ±‚çš„æ‰§è¡Œä¿¡æ¯ï¼Œå¹¶ä»¥ç»Ÿè®¡æŠ¥è¡¨å’Œå›¾å½¢çš„å½¢å¼å±•ç¤ºç»™ç”¨æˆ·ï¼ŒåŒ…æ‹¬æ¯ç§’æ‰§è¡Œå¤šå°‘è¯·æ±‚å¤šå°‘æˆåŠŸï¼Œå¤šå°‘å¤±è´¥ç­‰ã€‚Netflixé€šè¿‡hystrix-metrics-event-streamé¡¹ç›®å®ç°äº†å¯¹ä»¥ä¸ŠæŒ‡æ ‡çš„ç›‘æ§ã€‚Spring Cloudä¹Ÿæä¾›äº†Hystrix Dashboardçš„æ•´åˆï¼Œå¯¹ç›‘æ§å†…å®¹è½¬åŒ–æˆå¯è§†åŒ–ç•Œé¢ã€‚



#### 5.2 æ­å»ºç›‘æ§å¹³å°

##### 5.2.1 æ¨¡å—æ­å»º

1.  `cloud-consumer-hystrix-dashboard9001`

2.  POM

    ```xml
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-hystrix-dashboard</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>com.atguigu</groupId>
            <artifactId>cloud-api-commons</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    ```

3.  YAML

    ```yaml
    server:
      port: 9001
    ```

4.  ä¸»å¯åŠ¨

    ```java
    @SpringBootApplication
    // å¼€å¯æœåŠ¡ç›‘æ§
    @EnableHystrixDashboard
    public class HystrixDashboardMain9001 {
    
        public static void main(String[] args) {
            SpringApplication.run(HystrixDashboardMain9001.class, args);
        }
    }
    ```

5.  ä¸šåŠ¡ç±»ï¼ˆæ²¡æœ‰ä¸šåŠ¡ï¼‰



**æµ‹è¯•**

è®¿é—®`http://localhost:9001/hystrix`ï¼Œç„¶åä¸æ–­è®¿é—®æ­£å¸¸å’Œé”™è¯¯çš„æ¥å£å°±ä¼šå‡ºç°ä¸‹å›¾çš„æƒ…å†µ

![image-20230215113239905](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215113239905.png)

å¯ä»¥çœ‹åˆ°è¿™ä¸ªè¡¨ç›˜è®°å½•äº†è®¿é—®çš„æƒ…å†µ



##### 5.2.2 å‚æ•°è¯´æ˜

å®å¿ƒåœ†ï¼šå…±æœ‰ä¸¤ç§å«ä¹‰ã€‚å®ƒé€šè¿‡é¢œè‰²çš„å˜åŒ–ä»£è¡¨äº†å®ä¾‹çš„å¥åº·ç¨‹åº¦ï¼Œå®ƒçš„å¥åº·åº¦ä»ç»¿è‰²<é»„è‰²<æ©™è‰²<çº¢è‰²é€’å‡ã€‚
è¯¥å®å¿ƒåœ†é™¤äº†é¢œè‰²çš„å˜åŒ–ä¹‹å¤–ï¼Œå®ƒçš„å¤§å°ä¹Ÿä¼šæ ¹æ®å®ä¾‹çš„è¯·æ±‚æµé‡å‘ç”Ÿå˜åŒ–ï¼Œæµé‡è¶Šå¤§è¯¥å®å¿ƒåœ†å°±è¶Šå¤§ã€‚æ‰€ä»¥é€šè¿‡è¯¥å®å¿ƒåœ†çš„å±•ç¤ºï¼Œå°±å¯ä»¥åœ¨å¤§é‡çš„å®ä¾‹ä¸­å¿«é€Ÿçš„å‘ç°æ•…éšœå®ä¾‹å’Œé«˜å‹åŠ›å®ä¾‹

æ›²çº¿ï¼šç”¨æ¥è®°å½•2åˆ†é’Ÿå†…æµé‡çš„ç›¸å¯¹å˜åŒ–ï¼Œå¯ä»¥é€šè¿‡å®ƒæ¥è§‚å¯Ÿåˆ°æµé‡çš„ä¸Šå‡å’Œä¸‹é™è¶‹åŠ¿ã€‚

æ•´å›¾è¯´æ˜ï¼š

![image-20230215113802575](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215113802575.png)

![image-20230215113827704](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215113827704.png)

ç›‘æ§å¤šä¸ªæœåŠ¡

![image-20230215113922130](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215113922130.png)







# ä¸ƒã€ç½‘å…³

## Zuulï¼ˆåœæ›´ç»´æŠ¤âš ï¼‰å’Œzuul2

zuulçš„æŠ€æœ¯ä¸Šè¢«æ·˜æ±°äº†ï¼Œä¼šå› ä¸ºå®ƒæ˜¯é˜»å¡æ¨¡å‹çš„ã€‚

zuul2å› ä¸ºå…¬å¸å†…éƒ¨çš„çŸ›ç›¾å¯¼è‡´è¿Ÿè¿Ÿæœªå¼€å‘ï¼Œæ‰€ä»¥springcloudå®˜æ–¹å°±è‡ªå·±ç ”å‘äº†ä¸€ä¸ªè‡ªå·±çš„ç½‘å…³å‡ºæ¥ï¼Œå°±æ˜¯Gatewayï¼Œå®ƒæ›¿ä»£äº†zuul





## Gateway

### 1ã€æ¦‚è¿°

#### 1.1 ç®€ä»‹

Spring Cloud Gatewayæ˜¯Spring Cloudä¸­çš„ç½‘å…³ã€‚å®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚**å®ƒæ˜¯åŸºäºWebFluxæ¡†æ¶å®ç°çš„ï¼Œè€ŒWebFluxæ¡†æ¶åº•å±‚åˆ™ä½¿ç”¨äº†é«˜æ€§èƒ½çš„Reactoræ¨¡å¼é€šä¿¡æ¡†æ¶Netty**ã€‚Spring Cloud Gatewayçš„ç›®æ ‡æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ä¸”åŸºäº Filter é“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šåå‘ä»£ç†ã€å®‰å…¨ï¼Œç›‘æ§/æŒ‡æ ‡ã€é™æµç­‰ç­‰ã€‚

Gatewayçš„ä¾èµ–

![image-20230215185024466](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215185024466.png)

ç½‘å…³åœ¨å¾®æœåŠ¡ä¸­çš„ä½ç½®

![image-20230215184933478](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215184933478.png)

![image-20230215185103474](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215185103474.png)



#### 1.2 zuul VS Gateway

**Qï¼šä¸ºä»€ä¹ˆé€‰æ‹©Gatewayè€Œä¸æ˜¯zuulï¼Ÿ**

1ã€Zuul 1.xï¼Œæ˜¯ä¸€ä¸ªåŸºäºé˜»å¡ I/ O çš„ API Gateway

2ã€Zuul 1.x åŸºäºServlet 2. 5ä½¿ç”¨é˜»å¡æ¶æ„å®ƒä¸æ”¯æŒä»»ä½•é•¿è¿æ¥(å¦‚ WebSocket) Zuul çš„è®¾è®¡æ¨¡å¼å’ŒNginxè¾ƒåƒï¼Œæ¯æ¬¡ I/ O æ“ä½œéƒ½æ˜¯ä»å·¥ä½œçº¿ç¨‹ä¸­é€‰æ‹©ä¸€ä¸ªæ‰§è¡Œï¼Œè¯·æ±‚çº¿ç¨‹è¢«é˜»å¡åˆ°å·¥ä½œçº¿ç¨‹å®Œæˆï¼Œä½†æ˜¯å·®åˆ«æ˜¯Nginx ç”¨C++ å®ç°ï¼ŒZuul ç”¨ Java å®ç°ï¼Œè€Œ JVM æœ¬èº«ä¼šæœ‰ç¬¬ä¸€æ¬¡åŠ è½½è¾ƒæ…¢çš„æƒ…å†µï¼Œä½¿å¾—Zuul çš„æ€§èƒ½ç›¸å¯¹è¾ƒå·®ã€‚

3ã€Zuul 2.xç†å¿µæ›´å…ˆè¿›ï¼Œæƒ³åŸºäºNettyéé˜»å¡å’Œæ”¯æŒé•¿è¿æ¥ï¼Œä½†SpringCloudç›®å‰è¿˜æ²¡æœ‰æ•´åˆã€‚ Zuul 2.xçš„æ€§èƒ½è¾ƒ Zuul 1.x æœ‰è¾ƒå¤§æå‡ã€‚åœ¨æ€§èƒ½æ–¹é¢ï¼Œæ ¹æ®å®˜æ–¹æä¾›çš„åŸºå‡†æµ‹è¯•ï¼Œ Spring Cloud Gateway çš„ RPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰æ˜¯Zuul çš„ 1. 6 å€ã€‚

4ã€Spring Cloud Gateway å»ºç«‹ åœ¨ Spring Framework 5ã€ Project Reactor å’Œ Spring Boot 2 ä¹‹ä¸Šï¼Œ ä½¿ç”¨éé˜»å¡ APIã€‚

5ã€Spring Cloud Gateway è¿˜ æ”¯æŒ WebSocketï¼Œ å¹¶ä¸”ä¸Springç´§å¯†é›†æˆæ‹¥æœ‰æ›´å¥½çš„å¼€å‘ä½“éªŒ



#### 1.3 ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ

Routeï¼ˆè·¯ç”±ï¼‰ï¼šè·¯ç”±æ˜¯æ„å»ºç½‘å…³çš„åŸºæœ¬æ¨¡å—ï¼Œå®ƒç”±IDï¼Œç›®æ ‡URIï¼Œä¸€ç³»åˆ—çš„æ–­è¨€å’Œè¿‡æ»¤å™¨ç»„æˆï¼Œå¦‚æœæ–­è¨€ä¸ºtrueåˆ™åŒ¹é…è¯¥è·¯ç”±

Predicate(æ–­è¨€)ï¼šè·¯ç”±çš„è§„åˆ™ï¼Œä¸è§„åˆ™åŒ¹é…çš„è¯·æ±‚å°±å¯ä»¥é€šè¿‡

Filterï¼ˆè¿‡æ»¤å™¨ï¼‰ï¼šæŒ‡çš„æ˜¯Springæ¡†æ¶ä¸­GatewayFilterçš„å®ä¾‹ï¼Œä½¿ç”¨è¿‡æ»¤å™¨ï¼Œå¯ä»¥åœ¨è¯·æ±‚è¢«è·¯ç”±å‰æˆ–è€…ä¹‹åå¯¹è¯·æ±‚è¿›è¡Œä¿®æ”¹ã€‚



#### 1.4 å·¥ä½œæµç¨‹

![image-20230215200903043](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215200903043.png)

Clients make requests to Spring Cloud Gateway. If the Gateway Handler Mapping determines that a request matches a route, it is sent to the Gateway Web Handler. This handler runs the request through a filter chain that is specific to the request. The reason the filters are divided by the dotted line is that filters can run logic both before and after the proxy request is sent. All â€œpreâ€ filter logic is executed. Then the proxy request is made. After the proxy request is made, the â€œpostâ€ filter logic is run.

å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ã€‚å¦‚æœ Gateway Handler Mapping ç¡®å®šè¯·æ±‚ä¸è·¯ç”±åŒ¹é…ï¼Œåˆ™å°†å…¶å‘é€åˆ° Gateway Web Handlerã€‚æ­¤å¤„ç†ç¨‹åºé€šè¿‡ç‰¹å®šäºè¯·æ±‚çš„è¿‡æ»¤å™¨é“¾è¿è¡Œè¯·æ±‚ã€‚è¿‡æ»¤å™¨è¢«è™šçº¿åˆ†å¼€çš„åŸå› æ˜¯è¿‡æ»¤å™¨å¯ä»¥åœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰å’Œä¹‹åè¿è¡Œé€»è¾‘ã€‚æ‰§è¡Œæ‰€æœ‰â€œé¢„â€è¿‡æ»¤å™¨é€»è¾‘ã€‚ç„¶åè¿›è¡Œä»£ç†è¯·æ±‚ã€‚å‘å‡ºä»£ç†è¯·æ±‚åï¼Œè¿è¡Œâ€œpostâ€è¿‡æ»¤å™¨é€»è¾‘ã€‚

äººè¯å°±æ˜¯æ–­è¨€è§„åˆ™åŒ¹é…å°±å°†è¯·æ±‚äº¤ç»™è¿‡æ»¤å™¨å‰ç½®å¤„ç†å™¨å¤„ç†ï¼Œç„¶åå†äº¤ç»™å¤„ç†è¯·æ±‚çš„å¾®æœåŠ¡è¿›è¡Œå¤„ç†ï¼Œæœ€åè¿”å›ç»“æœå†äº¤ç»™è¿‡æ»¤å™¨åç½®å¤„ç†å™¨å¤„ç†ã€‚





### 2ã€å…¥é—¨æ¡ˆä¾‹

1.  cloud-gateway-gateway9527

2.  POM

    ```xml
    <dependencies>
        <!--gateway-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-gateway</artifactId>
        </dependency>
        <!--eureka-client-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <!-- å¼•å…¥è‡ªå·±å®šä¹‰çš„apié€šç”¨åŒ…ï¼Œå¯ä»¥ä½¿ç”¨Paymentæ”¯ä»˜Entity -->
        <dependency>
            <groupId>com.atguigu</groupId>
            <artifactId>cloud-api-commons</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    ```

3.  YAML

    ```yaml
    server:
      port: 9527
    
    spring:
      application:
        name: cloud-gateway
    
      cloud:
        gateway:
          routes:
            - id: payment_route                       # è·¯ç”±å”¯ä¸€ID
              uri: http://localhost:8001              # è·¯ç”±åŒ¹é…çš„è·¯å¾„
              uri: lb://CLOUD-PAYMENT-SERVICE         #åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€
              predicates:                             # æ–­è¨€ -> è·¯ç”±åŒ¹é…è§„åˆ™
                - Path=/payment/getPaymentById/**     # æ–­è¨€è·¯å¾„ä¸ºtrueæ”¾è¡Œ
    
            - id: payment_route2
              uri: http://localhost:8001
              predicates:
                - Path=/payment/lb/**
    
    eureka:
      instance:
        hostname: cloud-gateway-service
      client:
        register-with-eureka: true
        fetch-registry: true
        service-url:
          defaultZone: http://eureka7001.com:7001/eureka
    ```

4.  ä¸»å¯åŠ¨

    ```java
    @SpringBootApplication
    public class GateWayMain9527 {
    
        public static void main(String[] args) {
            SpringApplication.run(GateWayMain9527.class, args);
        }
    }
    ```

å¯åŠ¨æµ‹è¯•è®¿é—®`http://localhost:9527/payment/lb`ï¼Œæ˜¾ç¤ºçš„æ˜¯8001ç«¯å£ï¼Œç›®å‰æˆ‘ä»¬æ²¡æœ‰è®¾ç½®åŠ¨æ€è·¯ç”±ï¼Œæ‰€ä»¥å®ƒä¸ä¼šæœ‰è´Ÿè½½å‡è¡¡çš„æ•ˆæœ



### 3ã€åŠ¨æ€è·¯ç”±

è¦å®ç°åŠ¨æ€è·¯ç”±éœ€è¦å°†æœåŠ¡æ³¨å†Œåˆ°eurekaä¸­ï¼Œä¿®æ”¹ä¸Šé¢çš„æ¨¡å—

1.  POM -> æ·»åŠ eureka starter

2.  YAML -> å¼€å¯åŠ¨æ€è·¯ç”±åŠŸèƒ½ï¼Œä¿®æ”¹è·¯ç”±é…ç½®

    urié¡¹è®¾ç½®ä¸ºæœåŠ¡æœåŠ¡å

    ```yaml
    spring:
      cloud:
        gateway:
          discovery:
            locator:
              #å¼€å¯ä»æ³¨å†Œä¸­å¿ƒåŠ¨æ€åˆ›å»ºè·¯ç”±çš„åŠŸèƒ½ï¼Œåˆ©ç”¨å¾®æœåŠ¡åè¿›è¡Œè·¯ç”±
              enabled: true
        
        routes:
          - id: payment_route                       # è·¯ç”±å”¯ä¸€ID
    #          uri: http://localhost:8001              # è·¯ç”±åŒ¹é…çš„è·¯å¾„
            uri: lb://CLOUD-PAYMENT-SERVICE         #åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€
            predicates:                             # æ–­è¨€ -> è·¯ç”±åŒ¹é…è§„åˆ™
              - Path=/payment/getPaymentById/**     # æ–­è¨€è·¯å¾„ä¸ºtrueæ”¾è¡Œ
    
    	 - id: payment_route2
    	   uri: lb://CLOUD-PAYMENT-SERVICE         #åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€
    #          uri: http://localhost:8001
    	   predicates:
    	     - Path=/payment/lb/**
    ```

3.  å¯åŠ¨ç±»

    ```java
    @EnableEurekaClient
    ```

è®¿é—®`http://localhost:9527/payment/lb`æ˜¯æœ‰è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ï¼ŒæˆåŠŸ~~~



### 4ã€Predicate(æ–­è¨€)

#### 4.1 è¯´æ˜

ç¬¦åˆè·¯ç”±è§„åˆ™çš„å°±æ”¾è¡Œï¼Œä¸ç¬¦åˆå°±æŠ¥ä¸‹é¢çš„404é”™è¯¯

![image-20230215165141349](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215165141349.png)

æ–­è¨€çš„è§„åˆ™åœ¨å®˜æ–¹æ–‡æ¡£çš„ç¬¬5ç« 

![image-20230215195612847](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215195612847.png)



#### 4.2 æ¡ˆä¾‹

è¿™é‡Œç”¨Afteræ¥ä¸¾åˆ—å­ï¼Œå…¶ä»–çš„è§„åˆ™éƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œæ»¡è¶³å°±æ”¾è¡Œï¼Œä¸æ»¡è¶³å°±æŠ¥404

ä¿®æ”¹yml

```yaml
predicates:
  - Path=/payment/lb/**
  - After=2022-02-15T17:10:03.685+08:00[Asia/Shanghai]  # æ–­è¨€ï¼Œåœ¨æŒ‡å®šæ—¶é—´ä¹‹åæ‰èƒ½è®¿é—®
  - Between=2022-02-02T17:45:06.206+08:00[Asia/Shanghai],2023-03-25T18:59:06.206+08:00[Asia/Shanghai]	   # æ–­è¨€ï¼Œåœ¨æŒ‡å®šæ—¶é—´èŒƒå›´å†…æ‰èƒ½è®¿é—®
  - Cookie=username,xiaozhi     # cookieä¸­username=å°æ™ºæ‰èƒ½è®¿é—®
  - Method=GET  				  # è¯·æ±‚æ–¹æ³•æ˜¯GET
  - Query=name				  # è¯·æ±‚æºå¸¦nameå‚æ•°æ‰èƒ½è®¿é—®
```

è¯´æ˜ï¼šAfteræ–­è¨€å°±æ˜¯è¯·æ±‚è¦åœ¨æŒ‡å®šæ—¶é—´ä¹‹åæ‰èƒ½è®¿é—®ï¼Œä¸ç„¶å°±æŠ¥é”™

è·å–ä¸Šè¿°ä¾‹å­çš„æ—¶é—´

```java
// è·å–å½“å‰æ—¶åŒºçš„æ—¶é—´
ZonedDateTime now = ZonedDateTime.now();
```

**æµ‹è¯•**

å› ä¸ºéœ€è¦æºå¸¦cookieï¼Œæ‰€ä»¥ä¸èƒ½åœ¨æµè§ˆå™¨æµ‹è¯•ï¼Œéœ€è¦ä½¿ç”¨Postmanæˆ–è€…curlå·¥å…·æµ‹è¯•ã€‚è¿™é‡Œä½¿ç”¨curlå·¥å…·

æ‰“å¼€cmdçª—å£ï¼Œè¾“å…¥

```sh
curl http://localhost:9527/payment/lb?name=xiaozhi --cookie=xiaozhi
```



#### 4.3 è§„åˆ™åˆ—è¡¨

| æ–­è¨€å…³é”®å­—           | ä½œç”¨                         |
| -------------------- | ---------------------------- |
| After                | æŒ‡å®šæ—¶é—´ä¹‹åè®¿é—®             |
| Before               | æŒ‡å®šæ—¶é—´ä¹‹å‰è®¿é—®             |
| Between              | æŒ‡å®šæ—¶é—´èŒƒå›´å†…è®¿é—®           |
| Cookie               | æºå¸¦ç¬¦åˆè§„åˆ™çš„cookieæ‰èƒ½è®¿é—® |
| Header               | æºå¸¦æŒ‡å®šçš„è¯·æ±‚å¤´             |
| Host                 | æŒ‡å®šçš„ä¸»æœºå                 |
| Method               | æŒ‡å®šè¯·æ±‚æ–¹æ³•                 |
| Path                 | åŒ¹é…è·¯å¾„                     |
| Query                | æŒ‡å®šå‚æ•°å                   |
| RemoteAddr           | æŒ‡å®šIPåœ°å€                   |
| Weight               | æƒé‡                         |
| XForwardedRemoteAddr | æŒ‡å®šçš„ä»£ç†æœåŠ¡å™¨             |

æ³¨æ„ï¼švalueéƒ½æ˜¯æ­£åˆ™è¡¨è¾¾å¼





### 5ã€Filter

![image-20230215202115225](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215202115225.png)

è·¯ç”±è¿‡æ»¤å™¨å…è®¸ä»¥æŸç§æ–¹å¼ä¿®æ”¹ä¼ å…¥çš„ HTTP è¯·æ±‚æˆ–ä¼ å‡ºçš„ HTTP å“åº”ã€‚è·¯ç”±è¿‡æ»¤å™¨çš„èŒƒå›´æ˜¯ç‰¹å®šè·¯ç”±ã€‚ Spring Cloud Gateway åŒ…æ‹¬è®¸å¤šå†…ç½®çš„ GatewayFilter å·¥å‚ã€‚

åœ¨å®˜ç½‘çš„67ç« æœ‰è¯´æ˜ï¼Œç›®å‰å…¨å±€çš„æœ‰10ä¸ªï¼Œç½‘å…³è¿‡æ»¤å™¨çš„æœ‰37ä¸ªï¼ŒåŠ èµ·æ¥47ä¸ª

![image-20230215201428752](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215201428752.png)



#### 5.1 æ¡ˆä¾‹è¯´æ˜

ä¿®æ”¹ä¹‹å‰çš„æ¨¡å—ï¼Œæ·»åŠ Filtersé…ç½®é¡¹

YAML

```yaml
spring:
  cloud:
    gateway:
      discovery:
        locator:
          #å¼€å¯ä»æ³¨å†Œä¸­å¿ƒåŠ¨æ€åˆ›å»ºè·¯ç”±çš„åŠŸèƒ½ï¼Œåˆ©ç”¨å¾®æœåŠ¡åè¿›è¡Œè·¯ç”±
          enabled: true
      routes:
        - id: payment_route                       # è·¯ç”±å”¯ä¸€ID
#          uri: http://localhost:8001              # è·¯ç”±åŒ¹é…çš„è·¯å¾„
          uri: lb://CLOUD-PAYMENT-SERVICE         #åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€
          predicates:                             # æ–­è¨€ -> è·¯ç”±åŒ¹é…è§„åˆ™
            - Path=/payment/getPaymentById/**     # æ–­è¨€è·¯å¾„ä¸ºtrueæ”¾è¡Œ

        - id: payment_route2
          uri: lb://CLOUD-PAYMENT-SERVICE         #åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€
#          uri: http://localhost:8001
          predicates:
            - Path=/payment/lb/**
            - After=2022-02-15T17:10:03.685+08:00[Asia/Shanghai]  # æ–­è¨€ï¼Œåœ¨æŒ‡å®šæ—¶é—´ä¹‹åæ‰èƒ½è®¿é—®
#            # æ–­è¨€ï¼Œåœ¨æŒ‡å®šæ—¶é—´èŒƒå›´å†…æ‰èƒ½è®¿é—®
#            - Between=2022-02-02T17:45:06.206+08:00[Asia/Shanghai],2023-03-25T18:59:06.206+08:00[Asia/Shanghai]
#            - Cookie=username,xiaozhi     # cookieä¸­username=å°æ™ºæ‰èƒ½è®¿é—®
#            - Method=GET  # è¯·æ±‚æ–¹æ³•æ˜¯GET
#            - Query=name
#            - Host=localhost
          filters:
            - AddRequestHeader=X-Request-Id,xiaozhi666  # è¿‡æ»¤å™¨ä¼šåœ¨åŒ¹é…çš„è¯·æ±‚å¤´ä¸ŠåŠ ä¸€å¯¹è¯·æ±‚å¤´ï¼Œåä¸ºX-Request-Idï¼Œå€¼ä¸º444
```

è¯´æ˜ï¼š`AddRequestHeader`è¿‡æ»¤å™¨ä¼šåœ¨åŒ¹é…è¯·æ±‚çš„è¯·æ±‚å¤´åŠ ä¸Š`X-Request-Id: xiaozhi666`

```java
@GetMapping("lb")
public String lb(HttpServletRequest request) {
    String header = request.getHeader("X-Request-Id");
    if (header == null) {
        header = "";
    }
    return serverPort.toString() + "---" + header;
}
```

æä¾›è€…ä¸­è·å–è¿™ä¸ªè¯·æ±‚å¤´

![image-20230215203915360](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215203915360.png)

è®¿é—®8001ç«¯å£çš„æœåŠ¡å‡ºç°è¯·æ±‚å¤´çš„å†…å®¹ï¼Œè¯´æ˜æˆåŠŸ~~~

å…¶ä»–çš„Filterä¹Ÿæ˜¯ç±»ä¼¼çš„åŠŸèƒ½ï¼Œå¯ä»¥æŒ‰ç…§å®˜æ–¹æ–‡æ¡£æ¥å­¦ä¹ ã€‚



#### 5.2 è‡ªå®šä¹‰Global Filter

æ¡ˆä¾‹ï¼šè·å–urlå‚æ•°ï¼Œå¦‚æœä¸ºç©ºåˆ™ä¸æ”¾è¡Œ

æ–¹å¼ä¸€ï¼šå®ç°GlobalFilterå¹¶æ³¨å…¥å®¹å™¨ä¸­

```java
@Slf4j
@Component
public class CustomGlobalFilter implements GlobalFilter, Ordered {

    @Override
    public Mono<Void> filter(ServerWebExchange exchange,
                             GatewayFilterChain chain) {
        log.info("timeï¼š" + new Date() + "\tæ‰§è¡Œäº†è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨");
        String username = exchange.getRequest().getQueryParams().getFirst("username");
        if (username == null) {
            log.info("ç”¨æˆ·åä¸æ­£ç¡®ï¼Œæ— æ³•ç™»é™†");
            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);
            return exchange.getResponse().setComplete();
        }
        return chain.filter(exchange);
    }

    @Override
    public int getOrder() {
        return 0;
    }
}
```

æ–¹å¼äºŒï¼šä½¿ç”¨@beanæ³¨è§£çš„æ–¹å¼æ³¨å…¥å®¹å™¨

```java
@Order(0)
@Bean
public GlobalFilter myCustomGlobalFilter() {
    return (exchange, chain) -> {
        log.info("timeï¼š" + new Date() + "\tæ‰§è¡Œäº†è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨");
        String username = exchange.getRequest().getQueryParams().getFirst("username");
        if (username == null) {
            log.info("ç”¨æˆ·åä¸æ­£ç¡®ï¼Œæ— æ³•ç™»é™†");
            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);
            return exchange.getResponse().setComplete();
        }
        return chain.filter(exchange);
    };
}
```

å’Œæ–¹å¼ä¸€æ˜¯ä¸€æ ·çš„åŠŸèƒ½æ•ˆæœã€‚



**æµ‹è¯•**

ä¸å¸¦æœ‰å‚æ•°è®¿é—®

![image-20230215204603567](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215204603567.png)

å¯ä»¥çœ‹åˆ°ä½¿æˆ‘ä»¬è®¾ç½®çš„é”™è¯¯çŠ¶æ€ç 



å¸¦å‚æ•°è®¿é—®

![image-20230215204643821](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215204643821.png)

å¾ˆniceï¼Œæµ‹è¯•é€šè¿‡äº†~~~ğŸ˜‹







# å…«ã€åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ

## Spring Cloud Config

### 1ã€æ¦‚è¿°

#### 1.1 åˆ†å¸ƒå¼ç³»ç»Ÿé‡åˆ°çš„é—®é¢˜

åˆ†å¸ƒå¼ç³»ç»Ÿåˆä¸€ä¸ªä¸ªçš„å¾®æœåŠ¡ç»„æˆã€‚ä¿®æ”¹ä¸€ä¸ªé…ç½®å°±éœ€è¦å¤šå°æœºå™¨è¿›è¡Œä¿®æ”¹ï¼Œç„¶åè¿˜å¾—é‡å¯ï¼Œè€Œä¸”è¿˜æœ‰å¤§é‡çš„é…ç½®æ˜¯é‡å¤çš„ï¼Œå¯¼è‡´å·¥ä½œé‡å·¨å¤§ï¼Œæ‰€ä»¥éå¸¸éœ€è¦ä¸€ä¸ªé›†ä¸­å¼ç®¡ç†é…ç½®çš„æœåŠ¡ã€‚SpringCloudä¸­ç”±spring cloud configæ¥åšè¿™ä¸ªäº‹ã€‚é€šè¿‡é…ç½®ä¸­å¿ƒå»åŠ¨æ€ä¿®æ”¹æˆ‘ä»¬çš„é…ç½®ï¼Œä¸éœ€è¦é‡å¯å°±å¯ä»¥ä¿®æ”¹æˆ‘ä»¬çš„é…ç½®ã€‚å¤§å¤§ç¼©å‡äº†ä»»åŠ¡é‡



#### 1.2 æ˜¯ä»€ä¹ˆ

å®˜ç½‘ï¼š`https://spring.io/projects/spring-cloud-config`

SpringCloud Configä¸ºå¾®æœåŠ¡æ¶æ„ä¸­çš„å¾®æœåŠ¡æä¾›é›†ä¸­åŒ–çš„å¤–éƒ¨é…ç½®æ”¯æŒï¼Œé…ç½®æœåŠ¡å™¨ä¸ºå„ä¸ªä¸åŒå¾®æœåŠ¡åº”ç”¨çš„æ‰€æœ‰ç¯å¢ƒæä¾›äº†ä¸€ä¸ªä¸­å¿ƒåŒ–çš„å¤–éƒ¨é…ç½®ã€‚

![image-20230216144050413](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216144050413.png)

ä¸Šå›¾æ˜¯å®ƒçš„å·¥ä½œåŸç†å›¾ã€‚é¦–å…ˆéœ€è¦å¯åŠ¨é…ç½®ä¸­å¿ƒæœåŠ¡(`Config Server`)ï¼ŒæœåŠ¡çš„æ¯ä¸€æ¬¡è¯·æ±‚å°±ä¼šè·å–ä¸€ä¸‹Gitä¸Šçš„é…ç½®æ–‡ä»¶ï¼Œç„¶åå„ä¸ªå¾®æœåŠ¡ä»é…ç½®ä¸­å¿ƒæœåŠ¡è·å–æ–°çš„é…ç½®ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†éœ€è¦ä¿®æ”¹çš„é…ç½®åœ¨Gitä»“åº“ä¸­è¿›è¡Œä¿®æ”¹å³å¯



### 2ã€ä½¿ç”¨

SpringCloud Configåˆ†ä¸º**æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯**ä¸¤éƒ¨åˆ†ã€‚

æœåŠ¡ç«¯ä¹Ÿç§°ä¸ºåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡åº”ç”¨ï¼Œç”¨æ¥è¿æ¥é…ç½®æœåŠ¡å™¨å¹¶ä¸ºå®¢æˆ·ç«¯æä¾›è·å–é…ç½®ä¿¡æ¯ï¼ŒåŠ å¯†/è§£å¯†ä¿¡æ¯ç­‰è®¿é—®æ¥å£

å®¢æˆ·ç«¯åˆ™æ˜¯é€šè¿‡æŒ‡å®šçš„é…ç½®ä¸­å¿ƒæ¥ç®¡ç†åº”ç”¨èµ„æºï¼Œä»¥åŠä¸ä¸šåŠ¡ç›¸å…³çš„é…ç½®å†…å®¹ï¼Œå¹¶åœ¨å¯åŠ¨çš„æ—¶å€™ä»é…ç½®ä¸­å¿ƒè·å–å’ŒåŠ è½½é…ç½®ä¿¡æ¯é…ç½®æœåŠ¡å™¨é»˜è®¤é‡‡ç”¨gitæ¥å­˜å‚¨é…ç½®ä¿¡æ¯ï¼Œè¿™æ ·å°±æœ‰åŠ©äºå¯¹ç¯å¢ƒé…ç½®è¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡gitå®¢æˆ·ç«¯å·¥å…·æ¥æ–¹ä¾¿çš„ç®¡ç†å’Œè®¿é—®é…ç½®å†…å®¹ã€‚



#### 2.1 æœåŠ¡ç«¯æ­å»º

**Gitä»“åº“è®¾ç½®**

1.  åˆ›å»ºåä¸º`spring-cloud-config`çš„ä»“åº“

2.  æ·»åŠ ä¸‰ä¸ªæ–‡ä»¶ yamlæ–‡ä»¶

    ![image-20230216145126104](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216145126104.png)

    ```yaml
    config:
      info: dev, version=1
    ```

    ä¸åŒæ–‡ä»¶å†…å®¹ä¸åŒã€‚



**å·¥ç¨‹æ­å»º**

1.  åˆ›å»º`cloud-config-center-3344`æ¨¡å—

2.  POM

    ```xml
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-config-server</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    ```

3.  YAML

    ```yaml
    server:
      port: 3344
    
    spring:
      application:
        name:  cloud-config-center #æ³¨å†Œè¿›EurekaæœåŠ¡å™¨çš„å¾®æœåŠ¡å
      cloud:
        config:
          server:
            git:
              uri: https://github.com/mazhi-oss/spring-cloud-config.git #GitHubä¸Šé¢çš„gitä»“åº“åå­—
              ####æœç´¢ç›®å½•
              search-paths:
                - spring-cloud-config
            # ç”±äºgithub 2020-10-1 å°†ä¸»åˆ†æ”¯ä¿®æ”¹ä¸ºmain,æ‰€ä»¥è¦ä¿®æ”¹é»˜è®¤çš„label
            defaultLabel: main
          ####è¯»å–åˆ†æ”¯
          label: main
    
    
    
    #æœåŠ¡æ³¨å†Œåˆ°eurekaåœ°å€
    eureka:
      client:
        service-url:
          defaultZone: http://localhost:7001/eureka
    ```

4.  ä¸»å¯åŠ¨

    ```java
    @SpringBootApplication
    @EnableConfigServer		// å¼€å¯æœåŠ¡
    public class ConfigCenterMain3344
    {
        public static void main(String[] args) {
                SpringApplication.run(ConfigCenterMain3344.class, args);
        }
    }
    ```



**æµ‹è¯•**

å¯åŠ¨`eureka7001`ï¼Œå¯åŠ¨é…ç½®ä¸­å¿ƒæœåŠ¡å™¨

è®¿é—®`http://localhost:3344/main/config-dev.yml`

![image-20230216145506422](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216145506422.png)





#### 2.2 æ–‡ä»¶è®¿é—®è§„åˆ™

è®¿é—®è§„åˆ™å¦‚ä¸‹å›¾ï¼Œæ²¡æœ‰æ ‡æ˜`label`çš„è®¿é—®çš„æ˜¯é»˜è®¤çš„åˆ†æ”¯ï¼Œå¯ä»¥åœ¨serverç«¯è¿›è¡Œè®¾ç½®

![image-20230216145557360](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216145557360.png)

æ–‡ä»¶åè¯´æ˜ï¼š

-   applicationï¼šåº”ç”¨å
-   labelï¼šåˆ†æ”¯å
-   profileï¼šç¯å¢ƒå

ä¾‹å¦‚ï¼š`http://localhost:3344/main/config-dev.yml`ï¼Œ`main`å°±æ˜¯åˆ†æ”¯å,`config`å°±æ˜¯åº”ç”¨åï¼Œ`dev`å°±æ˜¯ç¯å¢ƒå

**ä¸åŒè®¿é—®æ ¼å¼ä¼šè¿”å›ä¸åŒçš„å†…å®¹**

æ¯”å¦‚`/{application}/{profile}/[/{label}]`è¿™ç§æ ¼å¼

<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216150345931.png" alt="image-20230216150345931" style="zoom:67%;" />



#### 2.3 å®¢æˆ·ç«¯æ­å»º

å®¢æˆ·ç«¯å°±æ˜¯æˆ‘ä»¬å„ä¸ªå¾®æœåŠ¡ï¼Œé€šè¿‡`Config Server`è·å–ä¿®æ”¹çš„é…ç½®



**æ­å»ºå·¥ç¨‹**

1.  åˆ›å»º`cloud-config-client-3355`æ¨¡å—

2.  POM

    ```XML
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-config</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
    
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    ```

    ==æ³¨æ„ï¼šClientç«¯çš„POMå’ŒServerç«¯çš„æ˜¯ä¸ä¸€æ ·çš„ï¼Œserverç«¯çš„åå­—ä¸º`spring-cloud-config-server`ï¼ŒClientç«¯ä¸º`spring-cloud-starter-config`ï¼Œè¦æ³¨æ„è¿™ä¸¤ä¸ªçš„åŒºåˆ«==

3.  YAML -> `bootstrap.yml`

    ```yaml
    server:
      port: 3355
    
    spring:
      application:
        name: config-client
      cloud:
        #Configå®¢æˆ·ç«¯é…ç½®
        config:
          label: main  #åˆ†æ”¯åç§°
          name: config #é…ç½®æ–‡ä»¶åç§°
          #è¯»å–åç¼€åç§°   ä¸Šè¿°3ä¸ªç»¼åˆï¼šmainåˆ†æ”¯ä¸Šconfig-dev.ymlçš„é…ç½®æ–‡ä»¶è¢«è¯»å–http://config-3344.com:3344/master/config-dev.yml
          profile: dev
          uri: http://localhost:3344 #é…ç½®ä¸­å¿ƒåœ°å€
    
    #æœåŠ¡æ³¨å†Œåˆ°eurekaåœ°å€
    eureka:
      client:
        service-url:
          defaultZone: http://localhost:7001/eureka
    ```

4.  ä¸»å¯åŠ¨

    ```java
    @EnableEurekaClient
    @SpringBootApplication
    public class ConfigClientMain3355
    {
        public static void main(String[] args)
        {
            SpringApplication.run(ConfigClientMain3355.class,args);
        }
    }
    ```



**æµ‹è¯•**

å¯åŠ¨è®¿é—®`http://localhost:3355/configInfo`

![image-20230216151104128](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216151104128.png)

è·å–åˆ°äº†é…ç½®ï¼Œnice~~~ğŸ˜‹ğŸ˜‹ğŸ˜‹





#### 2.4 bootstrap.ymlæ–‡ä»¶è¯´æ˜

æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„`application.yml`ï¼Œä¸ºä»€ä¹ˆåˆšæ‰ä½¿ç”¨äº†`bootstrap.yml`ï¼Œä»–ä»¬ä¸¤ä¸ªåŒºåˆ«åœ¨å“ªï¼Ÿ

-   applicaiton.ymlæ˜¯**ç”¨æˆ·çº§**çš„èµ„æºé…ç½®é¡¹
-   bootstrap.yml æ˜¯**ç³»ç»Ÿçº§**çš„ï¼Œä¼˜å…ˆçº§æ›´åŠ é«˜

Spring Cloudä¼šåˆ›å»ºä¸€ä¸ªâ€œBootstrap Contextâ€ï¼Œä½œä¸ºSpringåº”ç”¨çš„`Application Context`çš„çˆ¶ä¸Šä¸‹æ–‡ã€‚åˆå§‹åŒ–çš„æ—¶å€™ï¼Œ`Bootstrap Context`è´Ÿè´£ä»å¤–éƒ¨æºåŠ è½½é…ç½®å±æ€§å¹¶è§£æé…ç½®ã€‚è¿™ä¸¤ä¸ªä¸Šä¸‹æ–‡å…±äº«ä¸€ä¸ªä»å¤–éƒ¨è·å–çš„`Environment`ã€‚

`Bootstrap`å±æ€§æœ‰é«˜ä¼˜å…ˆçº§ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä»¬ä¸ä¼šè¢«æœ¬åœ°é…ç½®è¦†ç›–ã€‚ `Bootstrap context`å’Œ`Application Context`æœ‰ç€ä¸åŒçš„çº¦å®šï¼Œæ‰€ä»¥æ–°å¢äº†ä¸€ä¸ª`bootstrap.yml`æ–‡ä»¶ï¼Œä¿è¯`Bootstrap Context`å’Œ`Application Context`é…ç½®çš„åˆ†ç¦»ã€‚

è¦å°†Clientæ¨¡å—ä¸‹çš„`application.yml`æ–‡ä»¶æ”¹ä¸º`bootstrap.yml`,è¿™æ˜¯å¾ˆå…³é”®çš„ï¼Œå› ä¸º`bootstrap.yml`æ˜¯æ¯”`application.yml`å…ˆåŠ è½½çš„ã€‚`bootstrap.yml`ä¼˜å…ˆçº§é«˜äº`application.yml`ã€‚

==é…ç½®å˜æ›´ä¼šè¦†ç›–`application`ä¸­çš„é…ç½®ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸å˜æ›´çš„é…ç½®æ”¾åˆ°`bootstrap.yml`ä¸­==





### 3ã€é…ç½®åŠ¨æ€åˆ·æ–°

#### 3.1 ä¿®æ”¹Gitä»“åº“ä¸Šçš„é…ç½®æ–‡ä»¶

è®¾ç½®ç‰ˆæœ¬ä¸º2

![image-20230216153110129](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216153110129.png)

æ¥ä¸‹æ¥è®¿é—®`Config Server`çœ‹æ˜¯å¦å·²ç»æ›´æ–°äº†ã€‚

![image-20230216153209280](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216153209280.png)

å¯ä»¥çœ‹åˆ°æœåŠ¡å™¨ç«¯å·²ç»æ›´æ–°äº†ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹å®¢æˆ·ç«¯

![image-20230216153241470](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216153241470.png)

å¹¶æ²¡æœ‰åˆ·æ–°ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰é…ç½®åŠ¨æ€åˆ·æ–°~~~



#### 3.2 åŠ¨æ€åˆ·æ–°é…ç½®

1.  é¦–å…ˆéœ€è¦å¼•å…¥`actuator`ä¾èµ–

    ```xml
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    ```

2.  ä¿®æ”¹å®¢æˆ·ç«¯YAMLé…ç½® -> `bootstrap.yml`

    ```yaml
    # æš´éœ²ç›‘æ§ç«¯ç‚¹
    management:
      endpoints:
        web:
          exposure:
          	# è¿™é‡Œä¸ºäº†æ–¹ä¾¿æš´éœ²å…¨éƒ¨ç«¯ç‚¹
            include: "*"
    ```

3.  controllerä¸Šæ ‡æ³¨`@RefreshScope`æ³¨è§£

4.  é‡æ–°å¯åŠ¨æœåŠ¡

å¯åŠ¨æœåŠ¡ä¹‹åè®¿é—®æ˜¯å¯ä»¥è·å–åˆ°æœ€æ–°çš„é…ç½®çš„ï¼Œä½†æ˜¯æˆ‘ä»¬è¦çš„å°±æ˜¯ä¸é‡å¯ä¹Ÿå¯ä»¥è·å–ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜æ˜¯éœ€è¦ä¿®æ”¹ä¸€ä¸‹é…ç½®

ä¿®æ”¹versionä¸º3

![image-20230216153814993](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216153814993.png)

å†æ¬¡è¯·æ±‚å‘ç°`Config Server`æ›´æ–°äº†ï¼Œä½†æ˜¯`Clientç«¯`è¿˜æ˜¯æ²¡æœ‰æ›´æ–°ï¼Œè¿˜éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å‘è¯·æ±‚åˆ·æ–°ä¸€ä¸‹

æ‰“å¼€cmdçª—å£ï¼Œä½¿ç”¨`curl`å·¥å…·å‘é€`Post`è¯·æ±‚`http://localhost:3355/actuator/refresh`

```sh
# ä¸€å®šè¦åŠ  -X
curl -X POST "http://localhost:3355/actuator/refresh"
# ä¿®æ”¹çš„é…ç½®ä¿¡æ¯
["config.client.version","config.info"]
```

![image-20230216154318465](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216154318465.png)

å‘é€å®Œæˆåå†æ¬¡è®¿é—®

![image-20230216154338147](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216154338147.png)

æ¼‚äº®ï¼Œä½ åšåˆ°äº†ï¼Œä½ çœŸçš„åšåˆ°äº†ï¼Œå®ƒæ”¹å˜äº†ï¼ŒOh~~~~ğŸ˜‚



#### 3.3 é—®é¢˜

Qï¼šå¯¹äºä¸Šé¢çš„åŠ¨æ€åˆ·æ–°é…ç½®æˆ‘ä»¬å·²ç»å®ç°äº†ï¼Œä½†æ˜¯å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œéš¾é“æ¯æ¬¡é…ç½®æ›´æ”¹å°±è¦æ‰‹åŠ¨åˆ·æ–°ä¸€æ¬¡å—ï¼Ÿè¿™æ ·æ­¤ä¸æ˜¯æ¯ä¸€ä¸ªä¿®æ”¹é…ç½®çš„å¾®æœåŠ¡éƒ½è¦åˆ·æ–°ä¸€æ¬¡ï¼Œå¾®æœåŠ¡å¤šçš„è¯ä»»åŠ¡é‡è¿˜æ˜¯æœ‰ç‚¹å¤§ã€‚èƒ½ä¸èƒ½å¹¿æ’­å‘¢ï¼Œä¸€æ¬¡é€šçŸ¥ï¼Œåˆ°å¤„ç”Ÿæ•ˆã€‚

Aï¼šæ˜¯çš„ï¼Œspring cloudè€ƒè™‘åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å­¦ä¹ æ¶ˆæ¯æ€»çº¿ï¼Œå®ƒå¯ä»¥å¸®æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜





# ä¹ã€æ¶ˆæ¯æ€»çº¿

## SpringCloud Bus

### 1.æ¦‚è¿°

æˆ‘ä»¬ä½¿ç”¨`SpringCloud Config`æ¥ç®¡ç†é…ç½®ï¼Œä½†æ˜¯é…ç½®ä¿®æ”¹éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»åˆ·æ–°ï¼Œå¦‚æœæœåŠ¡å¤ªå¤šçš„è¯ï¼Œé‡å¤çš„å·¥ä½œå°±ä¼šå˜å¤šï¼Œ`SpringCloud BUS`å°±æ˜¯æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Œä¸€æ¬¡åˆ·æ–°ï¼Œå¹¿æ’­é€šçŸ¥ï¼Œå¤„å¤„ç”Ÿæ•ˆã€‚`Spring Cloud Config` + `SpringCloud BUS` å®ç°çœŸæ­£çš„åŠ¨æ€åˆ·æ–°ã€‚åªéœ€è¦åˆ·æ–°ä¸€æ¬¡ï¼Œå°±èƒ½é€šè¿‡æ€»çº¿æ¨é€ç»™å„ä¸ªæœåŠ¡ã€‚

Spring Cloud Busæ˜¯ç”¨æ¥å°†åˆ†å¸ƒå¼ç³»ç»Ÿçš„èŠ‚ç‚¹ä¸è½»é‡çº§æ¶ˆæ¯ç³»ç»Ÿé“¾æ¥èµ·æ¥çš„æ¡†æ¶ï¼Œå®ƒæ•´åˆäº†Javaçš„äº‹ä»¶å¤„ç†æœºåˆ¶å’Œæ¶ˆæ¯ä¸­é—´ä»¶çš„åŠŸèƒ½ã€‚**Spring Clud Busç›®å‰æ”¯æŒRabbitMQå’ŒKafkaã€‚**

Spring Cloud Busèƒ½ç®¡ç†å’Œä¼ æ’­åˆ†å¸ƒå¼ç³»ç»Ÿé—´çš„æ¶ˆæ¯ï¼Œå°±åƒä¸€ä¸ªåˆ†å¸ƒå¼æ‰§è¡Œå™¨ï¼Œå¯ç”¨äºå¹¿æ’­çŠ¶æ€æ›´æ”¹ã€äº‹ä»¶æ¨é€ç­‰ï¼Œä¹Ÿå¯ä»¥å½“ä½œå¾®æœåŠ¡é—´çš„é€šä¿¡é€šé“ã€‚

![image-20230216170503829](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216170503829.png)

**ä»€ä¹ˆæ˜¯æ€»çº¿**
åœ¨å¾®æœåŠ¡æ¶æ„çš„ç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨è½»é‡çº§çš„æ¶ˆæ¯ä»£ç†æ¥æ„å»ºä¸€ä¸ªå…±ç”¨çš„æ¶ˆæ¯ä¸»é¢˜ï¼Œå¹¶è®©ç³»ç»Ÿä¸­æ‰€æœ‰å¾®æœåŠ¡å®ä¾‹éƒ½è¿æ¥ä¸Šæ¥ã€‚ç”±äºè¯¥ä¸»é¢˜ä¸­äº§ç”Ÿçš„æ¶ˆæ¯ä¼šè¢«æ‰€æœ‰å®ä¾‹ç›‘å¬å’Œæ¶ˆè´¹ï¼Œæ‰€ä»¥ç§°å®ƒä¸ºæ¶ˆæ¯æ€»çº¿ã€‚åœ¨æ€»çº¿ä¸Šçš„å„ä¸ªå®ä¾‹ï¼Œéƒ½å¯ä»¥æ–¹ä¾¿åœ°å¹¿æ’­ä¸€äº›éœ€è¦è®©å…¶ä»–è¿æ¥åœ¨è¯¥ä¸»é¢˜ä¸Šçš„å®ä¾‹éƒ½çŸ¥é“çš„æ¶ˆæ¯ã€‚

**åŸºæœ¬åŸç†**
ConfigClientå®ä¾‹éƒ½è®¢é˜…MQä¸­åŒä¸€ä¸ªtopic(é»˜è®¤æ˜¯springCloudBus)ã€‚å½“ä¸€ä¸ªæœåŠ¡åˆ·æ–°æ•°æ®çš„æ—¶å€™ï¼Œå®ƒä¼šæŠŠè¿™ä¸ªä¿¡æ¯æ”¾å…¥åˆ°Topicä¸­ï¼Œè¿™æ ·å…¶å®ƒç›‘å¬åŒä¸€Topicçš„æœåŠ¡å°±èƒ½å¾—åˆ°é€šçŸ¥ï¼Œç„¶åå»æ›´æ–°è‡ªèº«çš„é…ç½®ã€‚



**ä¸¤ç§ä¼ æ’­æ–¹å¼**ï¼š

æ–¹å¼ä¸€ï¼šåˆ©ç”¨é…ç½®ä¸­å¿ƒè§¦å‘ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå†ç”±å®¢æˆ·ç«¯è§¦å‘å…¨éƒ¨çš„å®¢æˆ·ç«¯ã€‚

<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219112506319.png" alt="image-20230219112506319" style="zoom: 67%;" />

æ–¹å¼äºŒï¼šåˆ©ç”¨æ¶ˆæ¯æ€»çº¿è§¦å‘ä¸€ä¸ªæœåŠ¡ç«¯ConfigServerçš„/bus/refreshç«¯ç‚¹ï¼Œè€Œåˆ·æ–°æ‰€æœ‰å®¢æˆ·ç«¯çš„é…ç½®ï¼ˆæ¨èä½¿ç”¨è¿™ç§æ–¹å¼ï¼‰

<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219112635696.png" alt="image-20230219112635696" style="zoom:67%;" />





### 2.å®‰è£…RabbitMQ(çœç•¥)





### 3.åŠ¨æ€åˆ·æ–°å…¨å±€å¹¿æ’­

åœ¨`SpringCloud Config`ç« èŠ‚æˆ‘ä»¬æ­å»ºäº†3355å·¥ç¨‹ï¼Œç°åœ¨æˆ‘ä»¬å†æ­å»ºä¸€ä¸ª3366å·¥ç¨‹ï¼Œé…ç½®éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç«¯å£å·ä¸ä¸€è‡´ï¼Œä¸šåŠ¡ä¸Šå¤šä¸€ä¸ªç«¯å£å·

```java
@RestController
@RefreshScope
public class ConfigClientController {
    @Value("${server.port}")
    private String serverPort;

    @Value("${config.info}")
    private String configInfo;

    @GetMapping("/configInfo")
    public String configInfo()
    {
        return "serverPort: "+serverPort+"\t\n\n configInfo: "+configInfo;
    }

}
```

æ¥ç€æ·»åŠ BUSçš„POMï¼Œä¸¤ä¸ªéƒ½è¦æ·»åŠ 

```xml
<!--busæ•´åˆRabbitMQçš„POM-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bus-amqp</artifactId>
</dependency>
```

bootstrap.ymlæ·»åŠ é…ç½®é¡¹

```yaml
spring:
  rabbitmq:
    host: 192.168.6.156
    port: 5672
    username: guest
    password: guest
```

**é…ç½®ä¸­å¿ƒå·¥ç¨‹ä¿®æ”¹**

-   æ·»åŠ POM

    ```xml
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-bus-amqp</artifactId>
    </dependency>
    ```

-   ä¿®æ”¹yml

    ```yaml
      # rabbitmqé…ç½®
    spring:
      rabbitmq:
        host: 192.168.6.156
        port: 5672
        username: guest
        password: guest
        
    ##rabbitmqç›¸å…³é…ç½®,æš´éœ²busåˆ·æ–°é…ç½®çš„ç«¯ç‚¹
    management:
      endpoints: #æš´éœ²busåˆ·æ–°é…ç½®çš„ç«¯ç‚¹
        web:
          exposure:
            include: 'bus-refresh'
    ```

    è¿™ä¸ªå®˜ç½‘ä¸Šå¯ä»¥æ‰¾åˆ°æš´éœ²çš„ç«¯ç‚¹

    ![image-20230219113404288](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219113404288.png)

    ä¸Šå›¾æ˜¯4.0.1ç‰ˆæœ¬çš„ï¼Œä¸æ˜¯å½“å‰ä½¿ç”¨çš„è¿™ä¸ªç‰ˆæœ¬ï¼ï¼ï¼



**æµ‹è¯•**

å¯åŠ¨Eureka7001å’Œ3344ã€3355ã€3366è¿™ä¸‰å°

åœ¨`RabbitMQ`æ§åˆ¶å°ä¸­å¯ä»¥çœ‹åˆ°`SpringCloudBus`çš„ä¿¡æ¯

![image-20230220202302139](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230220202302139.png)

ä¿®æ”¹githubä¸Šçš„é…ç½®æ–‡ä»¶

![image-20230219113610248](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219113610248.png)

æ¥ç€å‘é€åˆ·æ–°è¯·æ±‚

```sh
curl -X POST "http://localhost:3344/actuator/bus-refresh"
```

è§‚å¯Ÿç»“æœ

![image-20230219113742325](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219113742325.png)

æˆåŠŸ~~~ğŸ˜‹ğŸ˜‹ğŸ˜‹





### 4.åŠ¨æ€åˆ·æ–°å®šç‚¹é€šçŸ¥

åœºæ™¯ï¼šæŸå‡ å°é…ç½®ä¿®æ”¹ï¼Œå…¶ä»–çš„ä¸ä¿®æ”¹

æ¡ˆä¾‹ï¼šé€šçŸ¥3355ï¼Œ3366ä¸ä¿®æ”¹

**å…¬å¼**ï¼š`http://localhost:é…ç½®ä¸­å¿ƒçš„ç«¯å£å·/actuator/bus-refresh/æ³¨å†Œä¸­å¿ƒæœåŠ¡å:ç«¯å£å·`

ä¾‹å­ï¼šé€šçŸ¥`config-client`æœåŠ¡çš„`3355`ç«¯å£çš„æœåŠ¡ä¿®æ”¹

`localhost:3344/actuator/bus-refresh/config-client:3355`



**å®ç°**

ä¿®æ”¹githubçš„é…ç½®æ–‡ä»¶ï¼Œåœ¨å‘é€ä¾‹å­ä¸­çš„å‘½ä»¤ï¼ŒæŸ¥çœ‹å˜åŒ–

![image-20230219134237524](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219134237524.png)

![image-20230219132548049](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219132548049.png)

![image-20230219134151725](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219134151725.png)







# åã€æ¶ˆæ¯é©±åŠ¨

åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­ï¼Œä¸ä»…æœ‰æˆ‘ä»¬çš„ä¸­å°ï¼Œä¹Ÿå°±æ˜¯Java Webç¨‹åºï¼ŒåŒæ—¶è¿˜æœ‰å¤§æ•°æ®å¹³å°ï¼Œé‚£ä¹ˆå®ƒä¼šå‡ºç°ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯æˆ‘ä»¬Javaç¨‹åºç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯RabbitMQï¼Œå¤§æ•°æ®å¹³å°ç”¨çš„æ˜¯Kafkaï¼Œ**é‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸¤ç§æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥å›åˆ‡æ¢**ã€‚è¿™æ˜¯ç›¸å½“è´¹åŠ²çš„ï¼Œè€Œä¸”å®ƒçš„å­¦ä¹ æˆæœ¬ä¹Ÿæé«˜äº†ï¼Œè™½ç„¶éƒ½æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†æ˜¯åœ¨å¾ˆå¤šæ–¹é¢è¿˜æ˜¯æœ‰å¾ˆå¤šçš„ä¸åŒï¼Œå­¦ä¹ èµ·æ¥éœ€è¦èŠ±è´¹è®¸å¤šçš„æ—¶é—´ï¼Œé‚£æœ‰æ²¡æœ‰ä¸€ä¸ªæ¡†æ¶æˆ–è€…è½¯ä»¶æ¥é›†æˆä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè®©æˆ‘ä»¬ä¸å†ä¸“æ³¨åº•å±‚çš„ç»†èŠ‚ï¼Œè€Œæ˜¯ä¸“æ³¨äºæˆ‘ä»¬çš„ä¸šåŠ¡å‘¢ï¼Ÿæ˜¯çš„ï¼Œå®ƒå°±æ˜¯æˆ‘ä»¬çš„ä¸»è§’ï¼Œæ¶ˆæ¯é©±åŠ¨ã€‚



## SpringCloud Stream

### 1ã€æ¦‚è¿°

#### 1.1 æ˜¯ä»€ä¹ˆï¼Ÿ

å®˜æ–¹å®šä¹‰ Spring Cloud Stream æ˜¯ä¸€ä¸ªæ„å»ºæ¶ˆæ¯é©±åŠ¨å¾®æœåŠ¡çš„æ¡†æ¶ã€‚

åº”ç”¨ç¨‹åºé€šè¿‡ inputs æˆ–è€… outputs æ¥ä¸ Spring Cloud Streamä¸­binderå¯¹è±¡äº¤äº’ã€‚é€šè¿‡æˆ‘ä»¬é…ç½®æ¥binding(ç»‘å®š) ï¼Œè€Œ Spring Cloud Stream çš„ **binderå¯¹è±¡è´Ÿè´£ä¸æ¶ˆæ¯ä¸­é—´ä»¶äº¤äº’**ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦ææ¸…æ¥šå¦‚ä½•ä¸ Spring Cloud Stream äº¤äº’å°±å¯ä»¥æ–¹ä¾¿ä½¿ç”¨æ¶ˆæ¯é©±åŠ¨çš„æ–¹å¼ã€‚

é€šè¿‡ä½¿ç”¨Spring Integrationæ¥è¿æ¥æ¶ˆæ¯ä»£ç†ä¸­é—´ä»¶ä»¥å®ç°æ¶ˆæ¯äº‹ä»¶é©±åŠ¨ã€‚Spring Cloud Stream ä¸ºä¸€äº›ä¾›åº”å•†çš„æ¶ˆæ¯ä¸­é—´ä»¶äº§å“æä¾›äº†ä¸ªæ€§åŒ–çš„è‡ªåŠ¨åŒ–é…ç½®å®ç°ï¼Œå¼•ç”¨äº†**å‘å¸ƒ-è®¢é˜…ã€æ¶ˆè´¹ç»„ã€åˆ†åŒº**çš„ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚

==**ç›®å‰ä»…æ”¯æŒRabbitMQã€Kafkaã€‚**==

![image-20230220152928327](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230220152928327.png)

**ä¸­æ–‡æŒ‡å¯¼æ‰‹å†Œ**ï¼š`https://m.wang1314.com/doc/webapp/topic/20971999.html`



#### 1.2 è®¾è®¡æ€æƒ³

![image-20230220202922897](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230220202922897.png)

æ ‡å‡†æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸‰ä¸ªæ­¥éª¤ï¼š

-   æ¶ˆæ¯ï¼šç”Ÿäº§è€…/æ¶ˆè´¹è€…ä¹‹é—´é€šè¿‡æ¶ˆæ¯åª’ä»‹ä¼ é€’ä¿¡æ¯
-   é€šé“ï¼šæ¶ˆæ¯å¿…é¡»è¦èµ°çš„ç‰¹æ®Šé€šé“ï¼ˆ`MessageChannel`ï¼‰
-   å¤„ç†ï¼šç”±`MessageHandler`æ¶ˆæ¯å¤„ç†å™¨å‘è®¢é˜…çš„å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯

ä½¿ç”¨`SpringCloud Stream`å¯ä»¥ä½¿æˆ‘ä»¬å±è”½åº•å±‚æ¶ˆæ¯é˜Ÿåˆ—çš„æ“ä½œç»†èŠ‚ã€‚é€šè¿‡ç»‘å®šå™¨ï¼ˆ`Binder`ï¼‰ä½œä¸ºä¸­é—´å±‚ï¼Œå®Œç¾çš„å®ç°äº†åº”ç”¨ç¨‹åºå’Œæ¶ˆæ¯ä¸­é—´ä»¶ç»†èŠ‚ä¹‹é—´çš„éš”ç¦»ï¼Œé€šè¿‡å‘åº”ç”¨ç¨‹åºæš´éœ²ç»Ÿä¸€çš„Channelé€šé“ï¼Œä½¿å¾—åº”ç”¨ç¨‹åºä¸éœ€è¦å†è€ƒè™‘å„ç§ä¸åŒçš„æ¶ˆæ¯ä¸­é—´ä»¶å®ç°ã€‚Streamä¸­çš„æ¶ˆæ¯é€šä¿¡æ–¹å¼éµå¾ªäº†å‘å¸ƒ-è®¢é˜…æ¨¡å¼ã€‚



#### 1.3 æ ¸å¿ƒç»„ä»¶å’Œæ³¨è§£

-   Binderï¼ˆç»‘å®šå™¨ï¼‰ï¼šBinderå¯ä»¥ç”ŸæˆBindingï¼ŒBindingç”¨æ¥ç»‘å®šæ¶ˆæ¯å®¹å™¨çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œå®ƒæœ‰ä¸¤ç§ç±»å‹ï¼ŒINPUTå’ŒOUTPUTï¼ŒINPUTå¯¹åº”äºæ¶ˆè´¹è€…ï¼ŒOUTPUTå¯¹åº”äºç”Ÿäº§è€…
-   Channelï¼ˆé€šé“ï¼‰ï¼šæ˜¯é˜Ÿåˆ—Queueçš„ä¸€ç§æŠ½è±¡ï¼Œåœ¨æ¶ˆæ¯é€šè®¯ç³»ç»Ÿä¸­å°±æ˜¯å®ç°å­˜å‚¨å’Œè½¬å‘çš„åª’ä»‹ï¼Œé€šè¿‡Channelå¯¹é˜Ÿåˆ—è¿›è¡Œé…ç½®
-   Sourceå’ŒSinkï¼šç®€å•çš„å¯ç†è§£ä¸ºå‚ç…§å¯¹è±¡æ˜¯Spring Cloud Streamè‡ªèº«ï¼Œä»Streamå‘å¸ƒæ¶ˆæ¯å°±æ˜¯è¾“å‡ºï¼Œæ¥å—æ¶ˆæ¯å°±æ˜¯è¾“å…¥ã€‚Suorceå°±æ˜¯è¾“å‡ºï¼ŒSinkå°±æ˜¯è¾“å…¥ã€‚

<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230220204132411.png" alt="image-20230220204132411" style="zoom:67%;" />

<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230220204136473.png" alt="image-20230220204136473"  />





### 2ã€ä½¿ç”¨

#### 2.1 æ¶ˆæ¯ç”Ÿäº§è€…æ­å»º

1.  åˆ›å»º`cloud-stream-rabbitmq-provider8801`

2.  POM

    ```xml
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-stream-rabbit</artifactId>
        </dependency>
        <!--åŸºç¡€é…ç½®-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    ```

3.  YAML

    ```yaml
    server:
      port: 8801
    
    spring:
      application:
        name: cloud-stream-provider   # åº”ç”¨å
    
      rabbitmq:
        host: 192.168.6.156
        port: 5672
        username: guest
        password: guest
    
      cloud:
        ####################### streamé…ç½® ########################
        stream:
          binders:  # åœ¨æ­¤å¤„é…ç½®è¦ç»‘å®šçš„rabbitmqçš„æœåŠ¡ä¿¡æ¯
            defaultRabbit: # è¡¨ç¤ºå®šä¹‰çš„åç§°ï¼Œç”¨äºäºbindingæ•´åˆ
              type: rabbit # æ¶ˆæ¯ç»„ä»¶ç±»å‹
    #          environment: # è®¾ç½®rabbitmqçš„ç›¸å…³çš„ç¯å¢ƒé…ç½®
    
          bindings: # æœåŠ¡çš„æ•´åˆå¤„ç†
            output:  # è¿™ä¸ªåå­—æ˜¯ä¸€ä¸ªé€šé“çš„åç§°
              destination: studyExchange      # è¡¨ç¤ºè¦ä½¿ç”¨çš„Exchangeåç§°å®šä¹‰
              content-type: application/json  # è®¾ç½®æ¶ˆæ¯ç±»å‹ï¼Œæœ¬æ¬¡ä¸ºå¯¹è±¡jsonï¼Œå¦‚æœæ˜¯æ–‡æœ¬åˆ™è®¾ç½®â€œtext/plainâ€
              binder: defaultRabbit           # è®¾ç½®è¦ç»‘å®šçš„æ¶ˆæ¯æœåŠ¡çš„å…·ä½“è®¾ç½®
    
      ####################### rabbitmqé…ç½® ########################
    
    
    ####################### eurekaé…ç½® ########################
    eureka:
      client:
        service-url:
          defaultZone: http://localhost:7001/eureka
      instance:
        instance-id: send-8801.com    # åœ¨ä¿¡æ¯åˆ—è¡¨æ—¶æ˜¾ç¤ºä¸»æœºåç§°
        prefer-ip-address: true       # è®¿é—®çš„è·¯å¾„å˜ä¸ºIPåœ°å€
    ```

4.  å¯åŠ¨ç±»

    ```java
    @SpringBootApplication
    public class StreamMQMain8801
    {
        public static void main(String[] args) {
            SpringApplication.run(StreamMQMain8801.class,args);
        }
    }
    ```

5.  ä¸šåŠ¡ç±»

    ![image-20230221085217729](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221085217729.png)

    controller

    ```java
    @RestController
    public class MessageController {
    
        @Resource
        private IMessageProvider iMessageProvider;
    
        @GetMapping("/sendMessage")
        public String send() {
            return iMessageProvider.send();
        }
    }
    ```

    service

    ```java
    @Slf4j
    @EnableBinding(Source.class)
    public class MessageProviderImpl implements IMessageProvider {
    
        @Resource
        private MessageChannel output;
    
        @Override
        public String send() {
            String serial = UUID.randomUUID().toString();
            output.send(MessageBuilder.withPayload(serial).build());
            log.info("serialï¼š{}", serial);
            return null;
        }
    }
    ```

æµ‹è¯•ï¼Œè®¿é—®å®šä¹‰å¥½çš„æ¥å£

![image-20230221085329782](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221085329782.png)

æœ‰æ—¥å¿—è¾“å‡ºï¼ŒæˆåŠŸ~~~ğŸ˜‹ğŸ˜‹ğŸ˜‹



#### 2.2 æ¶ˆæ¯æ¶ˆè´¹è€…æ­å»º

éœ€è¦æ­å»ºä¸¤ä¸ªåŒæ ·çš„æ¶ˆè´¹è€…ï¼Œç«¯å£å·ä¸åŒ

1.  åˆ›å»º`cloud-stream-rabbitmq-consumer8803`å’Œ`cloud-stream-rabbitmq-consumer8802`æ¨¡å—

2.  POM

    ```xml
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-stream-rabbit</artifactId>
        </dependency>
        <!--åŸºç¡€é…ç½®-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    ```

3.  YAML

    ```yaml
    server:
      port: 8803 # 8802
    
    spring:
      application:
        name: cloud-stream-consumer
    
      cloud:
        stream:
          binders: # åœ¨æ­¤å¤„é…ç½®è¦ç»‘å®šçš„rabbitmqçš„æœåŠ¡ä¿¡æ¯ï¼›
            defaultRabbit: # è¡¨ç¤ºå®šä¹‰çš„åç§°ï¼Œç”¨äºäºbindingæ•´åˆ
              type: rabbit # æ¶ˆæ¯ç»„ä»¶ç±»å‹
    #          environment: # è®¾ç½®rabbitmqçš„ç›¸å…³çš„ç¯å¢ƒé…ç½®
    
          bindings: # æœåŠ¡çš„æ•´åˆå¤„ç†
            input:  # è¿™ä¸ªåå­—æ˜¯ä¸€ä¸ªé€šé“çš„åç§°
              destination: studyExchange      # è¡¨ç¤ºè¦ä½¿ç”¨çš„Exchangeåç§°å®šä¹‰
              content-type: application/json  # è®¾ç½®æ¶ˆæ¯ç±»å‹ï¼Œæœ¬æ¬¡ä¸ºå¯¹è±¡jsonï¼Œå¦‚æœæ˜¯æ–‡æœ¬åˆ™è®¾ç½®â€œtext/plainâ€
              binder: defaultRabbit           # è®¾ç½®è¦ç»‘å®šçš„æ¶ˆæ¯æœåŠ¡çš„å…·ä½“è®¾ç½®
    
      rabbitmq:
        host: 192.168.6.156
        port: 5672
        username: guest
        password: guest
    
    eureka:
      client: # å®¢æˆ·ç«¯è¿›è¡ŒEurekaæ³¨å†Œçš„é…ç½®
        service-url:
          defaultZone: http://localhost:7001/eureka
      instance:
        lease-renewal-interval-in-seconds: 2 # è®¾ç½®å¿ƒè·³çš„æ—¶é—´é—´éš”ï¼ˆé»˜è®¤æ˜¯30ç§’ï¼‰
        lease-expiration-duration-in-seconds: 5 # å¦‚æœç°åœ¨è¶…è¿‡äº†5ç§’çš„é—´éš”ï¼ˆé»˜è®¤æ˜¯90ç§’ï¼‰
        instance-id: receive-8802.com  # åœ¨ä¿¡æ¯åˆ—è¡¨æ—¶æ˜¾ç¤ºä¸»æœºåç§°
        prefer-ip-address: true     # è®¿é—®çš„è·¯å¾„å˜ä¸ºIPåœ°å€
    ```

4.  ä¸»å¯åŠ¨

    ```java
    @SpringBootApplication
    public class StreamMQMain8803 {
        public static void main(String[] args)
        {
            SpringApplication.run(StreamMQMain8803.class,args);
        }
    }
    ```

5.  ä¸šåŠ¡ç±»

    service

    ```java
    @Slf4j
    @Component
    @EnableBinding(Sink.class)
    public class ReceiveMessageListener
    {
        @Value("${server.port}")
        private String serverPort;
    
        @StreamListener(Sink.INPUT)
        public void input(Message<String> message) {
            log.info("æ¶ˆè´¹è€…------->æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š{}\t{}", message.getPayload(), serverPort);
        }
    }
    ```



***æµ‹è¯•***

å¤šæ¬¡è®¿é—®8801çš„å‘é€æ¶ˆæ¯æ¥å£ï¼Œè§‚å¯Ÿ8802å’Œ8803çš„æ—¥å¿—è¾“å‡º

![image-20230221084855659](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221084855659-16769405367371.png)

å¯ä»¥çœ‹åˆ°å³°å€¼çš„å˜åŒ–ï¼Œå½“æˆ‘ä»¬ä¸ç‚¹çš„æ—¶å€™å®ƒå°±å½’0äº†

8803æ—¥å¿—è¾“å‡º

![image-20230221085747897](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221085747897.png)

8802æ—¥å¿—è¾“å‡º

![image-20230221085825854](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221085825854.png)





### 3ã€åˆ†ç»„æ¶ˆè´¹å’ŒæŒä¹…åŒ–

è§‚å¯Ÿä¸Šé¢çš„æ¡ˆä¾‹å‘ç°ï¼Œä¸€ä¸ªæ¶ˆæ¯è¢«ä¸¤ä¸ªæœåŠ¡æ¶ˆè´¹äº†ï¼Œè¿™ç§è¢«å¤šä¸ªæ¶ˆè´¹çš„å«é‡å¤æ¶ˆè´¹ã€‚é‡å¤æ¶ˆè´¹ä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å¯¹æ¶ˆæ¯è¿›è¡Œåˆ†ç»„ï¼Œ**ä¸åŒç»„çš„æœåŠ¡å¯ä»¥å¤šä¸ªæ¶ˆè´¹ï¼ŒåŒä¸ªç»„çš„æœåŠ¡åªèƒ½æœ‰ä¸€ä¸ªæ¶ˆè´¹**ã€‚



#### 3.1 åˆ†ç»„

ä¿®æ”¹ä¸Šé¢çš„æ¡ˆä¾‹ï¼Œä½¿ä»–ä»¬ä¹‹é—´åªæœ‰ä¸€ä¸ªæœåŠ¡èƒ½æ¶ˆè´¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†ä»–ä»¬åˆ†åœ¨åŒä¸€ä¸ªç»„

è‡ªåŠ¨åˆ†é…çš„åˆ†ç»„å

![image-20230221091256573](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221091256573.png)

å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªæ˜¯ä¸åŒçš„åˆ†ç»„ï¼Œæ‰€ä»¥ä¸¤ä¸ªæœåŠ¡éƒ½æ¶ˆè´¹äº†æ¶ˆæ¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦ç»™ä¸¤ä¸ªæœåŠ¡åˆ†åˆ°ä¸€ä¸ªåˆ†ç»„ä¸­ã€‚

**ä¿®æ”¹ä¸¤ä¸ªæœåŠ¡çš„`YAML`æ–‡ä»¶**

![image-20230221091515273](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221091515273.png)

ç°åœ¨ä»–ä»¬éƒ½åœ¨ä¸€ä¸ªç»„ä¸­

![image-20230221091657017](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221091657017.png)



**æµ‹è¯•**

ç”Ÿäº§è€…å‘é€4æ¡æ¶ˆæ¯ã€‚è§‚å¯Ÿä¸¤ä¸ªæ¶ˆè´¹è€…çš„æ—¥å¿—

-   8803

    ![image-20230221091827898](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221091827898.png)

-   8802

    ![image-20230221091846946](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221091846946.png)

å¯ä»¥çœ‹åˆ°å¾ˆæ¯ä¸ªæœåŠ¡éƒ½æ¶ˆè´¹äº†ä¸¤æ¡ï¼Œæ²¡æœ‰è¢«é‡å¤æ¶ˆè´¹ã€‚



#### 3.2 æŒä¹…åŒ–

æœåŠ¡å®•æœºåï¼Œå†æ¬¡å¯åŠ¨ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®åˆ†ç»„ï¼Œæ¶ˆæ¯å°±ä¼šå‘ç”Ÿä¸¢å¤±çš„æƒ…å†µï¼Œè¿™å°±æ˜¯æŒä¹…åŒ–é—®é¢˜ã€‚

**åœºæ™¯å¤ç°**

-   å°†ä¸¤å°æ¶ˆè´¹è€…å…³æ‰ã€‚ä¸€å°è®¾ç½®åˆ†ç»„ï¼Œä¸€å°ä¸è®¾ç½®ã€‚

    8802çš„å»æ‰

    ![image-20230221092224227](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221092224227.png)

-   ç”Ÿäº§è€…8801å‘é€å¤šæ¡æ¶ˆæ¯

-   å¯åŠ¨ä¸¤å°æ¶ˆè´¹è€…ï¼Œè§‚å¯Ÿæ—¥å¿—æ˜¯å¦æœ‰è¾“å‡º

    8803æ¶ˆè´¹äº†æ¶ˆæ¯

    ![image-20230221092500164](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221092500164.png)

    8802æ²¡æœ‰æ¶ˆè´¹ã€‚



**è§£å†³é—®é¢˜**

ç»™å®ƒè®¾ç½®ä¸€ä¸ªåˆ†ç»„ã€‚æˆ‘ä»¬å°†ä¸¤ä¸ªæœåŠ¡åˆ†åˆ°ä¸åŒçš„åˆ†ç»„ï¼Œå› ä¸ºåˆ†åœ¨ä¸€ä¸ªåˆ†ç»„å…ˆå¯åŠ¨çš„å°±ä¼šå°†æ¶ˆæ¯å…¨éƒ¨æ¶ˆè´¹ï¼Œåå¯åŠ¨çš„å°±ä¸ç”¨æ¶ˆè´¹äº†ï¼Œå› ä¸ºæ˜¯åŒä¸€ä¸ªç»„ã€‚

![image-20230221100808511](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221100808511.png)



**æµ‹è¯•**

å…ˆåœæ‰ä¸¤å°æœåŠ¡ã€‚ä½¿ç”¨8801ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯ï¼Œå†æ¬¡å¯åŠ¨ä¸¤å°æœåŠ¡

è§‚å¯Ÿå‘ç°ä¸¤å°æœåŠ¡å™¨éƒ½æœ‰æ¶ˆæ¯æ¶ˆè´¹çš„æ—¥å¿—ï¼Œnice~~~ğŸ˜ˆğŸ˜‹ğŸ˜‹







# åä¸€ã€åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€æ¬¡è¯·æ±‚å¯èƒ½éœ€è¦å¤šä¸ªæœåŠ¡èŠ‚ç‚¹è°ƒç”¨æ¥ååŒäº§å‡ºç»“æœï¼Œæ¯ä¸€æ®µè¯·æ±‚éƒ½ä¼šå½¢æˆä¸€ä¸ªå¤æ‚çš„åˆ†å¸ƒå¼è°ƒç”¨é“¾è·¯ï¼Œé“¾è·¯ä¸­çš„ä»»ä½•ä¸€ä¸ªæœåŠ¡å‡ºç°é«˜å»¶æ—¶æˆ–é”™è¯¯éƒ½ä¼šå¼•èµ·æ•´ä¸ªè¯·æ±‚çš„å¤±è´¥ã€‚

![image-20230221153148441](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221153148441.png)

åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªå¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿½è¸ªè¿™ä¸€æ®µè°ƒç”¨é“¾è·¯çš„æœåŠ¡ï¼Œå½“å‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥å¾ˆç›´è§‚çš„çœ‹åˆ°å‡ºé”™çš„æœåŠ¡ã€‚



## Spring Cloud Sleuth

### 1ã€æ¦‚è¿°

Spring Cloud Sleuthæä¾›äº†ä¸€å¥—å®Œæ•´çš„æœåŠ¡è·Ÿè¸ªçš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æä¾›è¿½è¸ªè§£å†³æ–¹æ¡ˆå¹¶ä¸”å…¼å®¹æ”¯æŒäº†zipkin

![image-20230221155422621](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221155422621.png)

ä¸Šå›¾æ˜¯å®Œæ•´çš„é“¾è·¯è°ƒç”¨

![image-20230221155539663](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221155539663.png)

![image-20230221155757474](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221155757474.png)

ä¸€æ¡é“¾è·¯é€šè¿‡Trace Idå”¯ä¸€æ ‡è¯†ï¼ŒSpanæ ‡è¯†å‘èµ·çš„è¯·æ±‚ä¿¡æ¯ï¼Œå„spané€šè¿‡`parent id `å…³è”èµ·æ¥ï¼Œ`parent id`å¯ä»¥ç†è§£ä¸ºæ˜¯è°ƒç”¨å®ƒçš„æœåŠ¡

Trace:ç±»ä¼¼äºæ ‘ç»“æ„çš„Spané›†åˆï¼Œè¡¨ç¤ºä¸€æ¡è°ƒç”¨é“¾è·¯ï¼Œå­˜åœ¨å”¯ä¸€æ ‡è¯†

span:è¡¨ç¤ºè°ƒç”¨é“¾è·¯æ¥æºï¼Œé€šä¿—çš„ç†è§£spanå°±æ˜¯ä¸€æ¬¡è¯·æ±‚ä¿¡æ¯





**SpringCloudä»Fç‰ˆèµ·å·²ä¸éœ€è¦è‡ªå·±æ„å»ºZipkin Serveräº†ï¼Œåªéœ€è°ƒç”¨jaråŒ…å³å¯**

**å¯åŠ¨å‘½ä»¤**

```shell
java -jar jaråŒ…å
```

ç„¶åè®¿é—®`http://localhost:9411`

![image-20230221155325873](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221155325873.png)

æˆåŠŸ~~~





### 2ã€ä½¿ç”¨

æ·»åŠ å®ƒçš„POMå’Œä¿®æ”¹YAMLã€‚è§‚å¯Ÿweb æ§åˆ¶å°å³å¯ã€‚

1.  ä¿®æ”¹`cloud-consumer-order8002`å’Œ`cloud-provider-payment8001`å·¥ç¨‹

2.  POM

    ```xml
    <!--åŒ…å«äº†sleuth+zipkin-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-zipkin</artifactId>
    </dependency>
    ```

3.  YAML

    ```yaml
    spring:
      zipkin:
        base-url: http://localhost:9411
        sleuth:
          sampler:
            #é‡‡æ ·ç‡å€¼ä»‹äº 0 åˆ° 1 ä¹‹é—´ï¼Œ1 åˆ™è¡¨ç¤ºå…¨éƒ¨é‡‡é›†
            probability: 1
    ```

4.  ä¸šåŠ¡ç±»

    -   8001-paymnt

        ```java
        @GetMapping("/zipkin")
        public String paymentZipkin() {
            return "hi ,I am xiaozhi";
        }
        ```

    -   8002-order

        ```java
        @GetMapping("/payment/zipkin")
        public String paymentZipkin() {
            String result = restTemplate.getForObject("http://localhost:8001"+"/payment/zipkin/", String.class);
            return result;
        }
        ```



**æµ‹è¯•**

è®¿é—®å‡ æ¬¡`http://localhost:8002/order/payment/zipkin`ï¼Œè§‚å¯Ÿwebæ§åˆ¶å°å˜åŒ–

![image-20230221160533972](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221160533972.png)

3ä¸ªspansï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯`zipkin`æœ¬èº«ï¼Œç‚¹å‡»å¯¹åº”çš„æ ç›®å¯ä»¥çœ‹åˆ°è¯¦ç»†çš„ä¿¡æ¯

![image-20230221160625533](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221160625533.png)

**æŸ¥çœ‹ä¾èµ–**

![image-20230221160652692](https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221160652692.png)



















